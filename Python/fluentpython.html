<!DOCTYPE html>
  <html>
    <head>
      <title>fluentpython</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0/katex.min.css">
      
      
      
      
      
      
      
      
      
      

      <style> 
      /**
 * prism.js Github theme based on GitHub's theme.
 * @author Sam Clarke
 */
code[class*="language-"],
pre[class*="language-"] {
  color: #333;
  background: none;
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.4;

  -moz-tab-size: 8;
  -o-tab-size: 8;
  tab-size: 8;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
  padding: .8em;
  overflow: auto;
  /* border: 1px solid #ddd; */
  border-radius: 3px;
  /* background: #fff; */
  background: #f5f5f5;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: .1em;
  border-radius: .3em;
  white-space: normal;
  background: #f5f5f5;
}

.token.comment,
.token.blockquote {
  color: #969896;
}

.token.cdata {
  color: #183691;
}

.token.doctype,
.token.punctuation,
.token.variable,
.token.macro.property {
  color: #333;
}

.token.operator,
.token.important,
.token.keyword,
.token.rule,
.token.builtin {
  color: #a71d5d;
}

.token.string,
.token.url,
.token.regex,
.token.attr-value {
  color: #183691;
}

.token.property,
.token.number,
.token.boolean,
.token.entity,
.token.atrule,
.token.constant,
.token.symbol,
.token.command,
.token.code {
  color: #0086b3;
}

.token.tag,
.token.selector,
.token.prolog {
  color: #63a35c;
}

.token.function,
.token.namespace,
.token.pseudo-element,
.token.class,
.token.class-name,
.token.pseudo-class,
.token.id,
.token.url-reference .token.variable,
.token.attr-name {
  color: #795da3;
}

.token.entity {
  cursor: help;
}

.token.title,
.token.title .token.punctuation {
  font-weight: bold;
  color: #1d3e81;
}

.token.list {
  color: #ed6a43;
}

.token.inserted {
  background-color: #eaffea;
  color: #55a532;
}

.token.deleted {
  background-color: #ffecec;
  color: #bd2c00;
}

.token.bold {
  font-weight: bold;
}

.token.italic {
  font-style: italic;
}


/* JSON */
.language-json .token.property {
  color: #183691;
}

.language-markup .token.tag .token.punctuation {
  color: #333;
}

/* CSS */
code.language-css,
.language-css .token.function {
  color: #0086b3;
}

/* YAML */
.language-yaml .token.atrule {
  color: #63a35c;
}

code.language-yaml {
  color: #183691;
}

/* Ruby */
.language-ruby .token.function {
  color: #333;
}

/* Markdown */
.language-markdown .token.url {
  color: #795da3;
}

/* Makefile */
.language-makefile .token.symbol {
  color: #795da3;
}

.language-makefile .token.variable {
  color: #183691;
}

.language-makefile .token.builtin {
  color: #0086b3;
}

/* Bash */
.language-bash .token.keyword {
  color: #0086b3;
}html body{font-family:"Helvetica Neue",Helvetica,"Segoe UI",Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ul,html body>ol{margin-bottom:16px}html body ul,html body ol{padding-left:2em}html body ul.no-list,html body ol.no-list{padding:0;list-style-type:none}html body ul ul,html body ul ol,html body ol ol,html body ol ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:bold;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:bold}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em !important;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::before,html body code::after{letter-spacing:-0.2em;content:"\00a0"}html body pre>code{padding:0;margin:0;font-size:.85em !important;word-break:normal;white-space:pre;background:transparent;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;font-size:.85em !important;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:before,html body pre tt:before,html body pre code:after,html body pre tt:after{content:normal}html body p,html body blockquote,html body ul,html body ol,html body dl,html body pre{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body pre,html body code{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview .pagebreak,.markdown-preview .newpage{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center !important}.markdown-preview:not([for="preview"]) .code-chunk .btn-group{display:none}.markdown-preview:not([for="preview"]) .code-chunk .status{display:none}.markdown-preview:not([for="preview"]) .code-chunk .output-div{margin-bottom:16px}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0}@media screen and (min-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px)}}@media screen and (max-width:914px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview{font-size:14px !important;padding:1em}}@media print{html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,0.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,0.66);border:4px solid rgba(150,150,150,0.66);background-clip:content-box}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{padding:0 1.6em;margin-top:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc li{margin-bottom:.8em}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul{list-style-type:none}html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% -  300px);padding:2em calc(50% - 457px -  150px);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */
.markdown-preview.markdown-preview code.red {
  background-color: #f8f2f4;
  color: #d40a32;
}
.markdown-preview.markdown-preview code.green {
  background-color: #eafef1;
  color: #089308;
}
.markdown-preview.markdown-preview #maste_title {
  color: #00bfff;
  font-size: 50px;
  font-family: 'Courier New', Courier, monospace;
}
.markdown-preview.markdown-preview .vice_title {
  color: #d0a3d0;
  font-size: 25px;
  font-family: 'Courier New', Courier, monospace;
}
.markdown-preview.markdown-preview hr.title_separator {
  border: 0;
  height: 0;
  /* Firefox... */
  box-shadow: 0 0 10px 1px deepskyblue;
}
 
      </style>
    </head>
    <body for="html-export">
      <div class="mume markdown-preview   ">
      <p><image src="../assets/logo_min.png" style="width:50px"> <span id="maste_title">foolish fly fox's blog<span></span></span></image></p>
<p><span class="vice_title">--Stay hungry, stay foolish.<span><br>
<span class="vice_title">--Forever young, forever weep.<span></span></span></span></span></p>
<hr class="title_separator">
<br>
<h1 class="mume-header" id="%E6%B5%81%E7%95%85%E7%9A%84-python">流畅的 Python</h1>

<h2 class="mume-header" id="%E7%AC%AC%E4%B8%80%E7%AB%A0-python%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B">第一章 Python数据模型</h2>

<p>不管在上面框架下写程序，都会花费大量的时间去实现那些被框架本身所调用的方法。Python碰到特殊句法时，会使用特殊方法去激活一些基本的对象操作。这些特殊的方法以两个下划线开头，两个下划线结尾(例如：<code>__getitem__</code>)。比如，<code>obj[key]</code>的背后是<code>__getitem__</code>方法，为了能获得 <code>my_collection[key]</code> 的值，解释器实际上会调用 <code>my_collection.__getitem__(key)</code>。</p>
<p>这些特殊方法名能够让你自己的对象实现和支持一下的语言框架，并与之交互：</p>
<ul>
<li>迭代器</li>
<li>集合类</li>
<li>访问属性</li>
<li>运算符重载</li>
<li>函数和方法的调用</li>
<li>对象的创建和销毁</li>
<li>字符串的表现形式和格式化</li>
<li>管理上下文(with 块)</li>
</ul>
<blockquote>
<p>魔术方法(magic method) 是特殊方法的昵称，也称为双下方法(dunder method)。</p>
</blockquote>
<h3 class="mume-header" id="%E4%B8%80%E6%91%9Epython%E9%A3%8E%E6%A0%BC%E7%9A%84%E7%BA%B8%E7%89%8C">一摞Python风格的纸牌</h3>

<div class="code-chunk" data-id="20180414082902" data-cmd="python"><div class="input-div"><pre data-role="codeBlock" data-info="python {code_chunk_offset=0, cmd id=&amp;amp;quot;20180414082902&amp;amp;quot;}" class="language-python"><span class="token keyword">from</span> collections <span class="token keyword">import</span> namedtuple

Card <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">'Card'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'rank'</span><span class="token punctuation">,</span> <span class="token string">'suit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">FrenchDeck</span><span class="token punctuation">:</span>
    ranks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token keyword">for</span> n <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token string">'JQKA'</span><span class="token punctuation">)</span>
    suits <span class="token operator">=</span> <span class="token string">'spades diamonds clubs hearts'</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_cards <span class="token operator">=</span> <span class="token punctuation">[</span>Card<span class="token punctuation">(</span>rank<span class="token punctuation">,</span> suit<span class="token punctuation">)</span> <span class="token keyword">for</span> rank <span class="token keyword">in</span> self<span class="token punctuation">.</span>ranks 
            <span class="token keyword">for</span> suit <span class="token keyword">in</span> self<span class="token punctuation">.</span>suits<span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_cards<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> position<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_cards<span class="token punctuation">[</span>position<span class="token punctuation">]</span>

deck <span class="token operator">=</span> FrenchDeck<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><div class="btn-group"><div class="run-btn btn"><span>▶︎</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"></div></div><p>自 Python2.6 开始，namedtuple 就被加入到 Python 中，用以构建只有少数属性，没有方法的对象，比如数据库条目等。</p>
<div class="code-chunk" data-id="code-chunk-id-1" data-cmd="python"><div class="input-div"><pre data-role="codeBlock" data-info="python {code_chunk_offset=1, cmd continue=&amp;amp;quot;20180414082902&amp;amp;quot;}" class="language-python"><span class="token comment"># 调用 __len__ 方法</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>deck<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 调用 __getitem__ 方法</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>deck<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>deck<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><div class="btn-group"><div class="run-btn btn"><span>▶︎</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"></div></div><p>现在可以体会到通过特殊方法利用Python数据模型的两个好处了：</p>
<ol>
<li>作为你的类的用户，他们不必去记住标准操作的各式名称(如是：<code>length</code> 还是 <code>size</code>)；</li>
<li>可以更方便地利用 Python 库，而不用重复发明轮子；</li>
</ol>
<p>因为 <code>__getitem__</code> 方法把 [] 操作交给了 <code>self._cards</code> 列表，所以我们的 <code>deck</code> 实例也支持切片操作(slicing)</p>
<p>切片操作：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token comment"># 获取最后 4 张牌</span>
<span class="token operator">>></span><span class="token operator">></span> deck<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="" class="language-"><code>[Card(rank=&apos;A&apos;, suit=&apos;spades&apos;),
 Card(rank=&apos;A&apos;, suit=&apos;diamonds&apos;),
 Card(rank=&apos;A&apos;, suit=&apos;clubs&apos;),
 Card(rank=&apos;A&apos;, suit=&apos;hearts&apos;)]
</code></pre><p>另外，仅仅实现了 <code>__getitem__</code> 方法，这一摞牌就变成可迭代的了：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token keyword">for</span> i <span class="token keyword">in</span> deck<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="" class="language-"><code>Card(rank=&apos;2&apos;, suit=&apos;spades&apos;)
Card(rank=&apos;2&apos;, suit=&apos;diamonds&apos;)
Card(rank=&apos;2&apos;, suit=&apos;clubs&apos;)
... ...
</code></pre><p>方向迭代也可以：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">reversed</span><span class="token punctuation">(</span>deck<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="" class="language-"><code>Card(rank=&apos;A&apos;, suit=&apos;hearts&apos;)
Card(rank=&apos;A&apos;, suit=&apos;clubs&apos;)
Card(rank=&apos;A&apos;, suit=&apos;diamonds&apos;)
Card(rank=&apos;A&apos;, suit=&apos;spades&apos;)
... ...
</code></pre><p>迭代通常是隐式的，譬如说一个集合类型没有实现 <code>__contains__</code>，那么 in 运算符就会按顺序做一次迭代搜索。</p>
<p>通过实现 <code>__len__</code> 和 <code>__getitem__</code> 这两个特殊方法，FrenchDeck 就跟一个 Python 自有的序列数据类型一样，可以体现出 Python 的核心语言特性（例如迭代和切片）。同时这个类还可以用于标准库中，诸如：<code>random.choice</code>、<code>reverted</code>和<code>sorted</code>这些函数。</p>
<h3 class="mume-header" id="%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E7%89%B9%E6%AE%8A%E6%96%B9%E6%B3%95">如何使用特殊方法</h3>

<p>需要明确：特殊方法的存在是为了被 Python 解释器调用的，你并不需要调用它们。也就是说没有 <code>my_object.__len__()</code> 这种写法，而应该使用 <code>len(my_object)</code>。</p>
<p>很多时候，特殊方法的调用时隐式的，比如 <code>for i in x:</code> 这个语句，背后其实用的是 <code>iter(x)</code>，而这个函数的背后是 <code>x.__iter__()</code> 方法。当然，前提是这个方法在 x 中被实现了。</p>
<p>通常你的代码无需直接使用特殊方法。除非有大量的元编程存在，直接调用特殊方法的频率应该远远低于你去实现它们的次数。唯一的例外是 <code>__init__</code> 方法，你的代码中可能经常会用到它，目的是在你自己的子类 <code>__init__</code> 方法中调用超类的构造器。</p>
<p><strong>通过内置的函数 len、 iter、str、等等来使用特殊方法是最好的选择。</strong></p>
<p>不要自己想当然地添加特殊方法，比如 <code>__foo__</code>，因为虽然现在这个名字没有被 Python 内部使用，以后就不一定了。</p>
<h4 class="mume-header" id="%E6%A8%A1%E6%8B%9F%E6%95%B0%E5%80%BC%E7%B1%BB%E5%9E%8B">模拟数值类型</h4>

<p>利用特殊方法，可以让自定义对象通过加号 <code>+</code> 进行运算。</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token keyword">import</span> math
<span class="token keyword">class</span> <span class="token class-name">Vector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>x <span class="token operator">=</span> x
        self<span class="token punctuation">.</span>y <span class="token operator">=</span> y
    
    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> f<span class="token string">'Vector({self.x}, {self.y})'</span>
    
    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> f<span class="token string">'({self.x}, {self.y})'</span>

    <span class="token keyword">def</span> <span class="token function">__add__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>x <span class="token operator">+</span> other<span class="token punctuation">.</span>x
        y <span class="token operator">=</span> self<span class="token punctuation">.</span>y <span class="token operator">+</span> other<span class="token punctuation">.</span>y
        <span class="token keyword">return</span> Vector<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">__abs__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> math<span class="token punctuation">.</span>hypot<span class="token punctuation">(</span>self<span class="token punctuation">.</span>x<span class="token punctuation">,</span> self<span class="token punctuation">.</span>y<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__mul__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> scalar<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> Vector<span class="token punctuation">(</span>self<span class="token punctuation">.</span>x<span class="token operator">*</span>scalar<span class="token punctuation">,</span> self<span class="token punctuation">.</span>y<span class="token operator">*</span>scalar<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__bool__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">bool</span><span class="token punctuation">(</span><span class="token builtin">abs</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__truediv__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> scalar<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> Vector<span class="token punctuation">(</span>self<span class="token punctuation">.</span>x<span class="token operator">/</span>scalar<span class="token punctuation">,</span> self<span class="token punctuation">.</span>y<span class="token operator">/</span>scalar<span class="token punctuation">)</span>
</pre><h4 class="mume-header" id="__repr__"><strong>repr</strong></h4>

<p>Python 有一个内置的函数叫 repr，它能把一个对象用字符串的形式表达出来以便辨认，这就是 “字符串表示形式”。<code>repr</code> 通过 <code>__repr__</code> 这个特殊方法来得到一个对象的字符串表示形式。如果没有实现 <code>__repr__</code>，当我们在控制台中打印一个向量的实例时，得到的字符串可能是：<code>&lt;__main__.Vector at 0x103c4e7f0&gt;</code>。</p>
<p>交互式控制台和调试程序(debugger)用 repr 函数来获取字符串表示形式。</p>
<p>如果你只想实现 <code>__repr__</code> 和 <code>__str__</code> 两个特殊方法中的一个，<code>__repr__</code> 是更好的选择，因为如果一个对象没有 <code>__str__</code> 函数，而 Python 又需要调用他的时候，解释器会用 <code>__repr__</code> 来替代。</p>
<h4 class="mume-header" id="%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%E5%B8%83%E5%B0%94%E5%80%BC">自定义的布尔值</h4>

<p>尽管 Python 中有 bool 类型，但实际上如何对象都可以用于需要布尔值的上下文中（bool()、if、while、and、or、not 等）。为了判断一个值 x 为真还是假，Python会调用 bool(x)，这个函数只能返回 True 或 False。</p>
<p>默认情况下，我们自己定义的类的实例总是被认为是真的，除非这个类对 <code>__bool__</code> 或者 <code>__len__</code> 函数有自己的实现。<code>bool(x)</code> 的背后是调用 <code>x.__bool__()</code> 的结果，如果不存在 <code>__bool__</code> 方法，那么<code>bool(x)</code> 会尝试调用 <code>x.__len__()</code>，若返回0，则 bool 会返回False，否则返回True。</p>
<h3 class="mume-header" id="%E7%89%B9%E6%AE%8A%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93">特殊方法总结</h3>

<p>表1-1：跟运算符无关的特殊方法</p>
<table>
<thead>
<tr>
<th>类别</th>
<th>方法名</th>
</tr>
</thead>
<tbody>
<tr>
<td>字符串/字节序列表示形式</td>
<td><code>__repr__</code> <code>__str__</code> <code>__format__</code> <code>__bytes__</code></td>
</tr>
<tr>
<td>数值转换</td>
<td><code>__abs__</code> <code>__bool__</code> <code>__complex__</code> <code>__int__</code> <code>__float__</code> <code>__hash__</code> <code>__index__</code></td>
</tr>
<tr>
<td>集合模拟</td>
<td><code>__len__</code> <code>__getitem__</code> <code>__setitem__</code> <br><code>__delitem__</code> <code>__contains__</code></td>
</tr>
<tr>
<td>迭代枚举</td>
<td><code>__iter__</code> <code>__reversed__</code> <code>__next__</code></td>
</tr>
<tr>
<td>可调用模拟</td>
<td><code>__call__</code></td>
</tr>
<tr>
<td>上下文管理</td>
<td><code>__enter__</code> <code>__exit__</code></td>
</tr>
<tr>
<td>实例创建和销毁</td>
<td><code>__new__</code> <code>__init__</code> <code>__del__</code></td>
</tr>
<tr>
<td>属性管理</td>
<td><code>__getattr__</code> <code>__getattribute__</code> <br><code>__setattr__</code> <code>__delattr__</code> <code>__dir__</code></td>
</tr>
<tr>
<td>属性描述符</td>
<td><code>__get__</code> <code>__set__</code> <code>__delete__</code></td>
</tr>
<tr>
<td>跟类相关的服务</td>
<td><code>__prepare__</code> <code>__instancecheck__</code> <code>__subclasscheck</code></td>
</tr>
</tbody>
</table>
<p>表1-2：跟运算符相关的特殊方法</p>
<table>
<thead>
<tr>
<th>类别</th>
<th>方法名和对应的运算符</th>
</tr>
</thead>
<tbody>
<tr>
<td>一元运算符</td>
<td><code>__neg__</code>(-) <code>__pos__</code>(+) <code>__abs__</code></td>
</tr>
<tr>
<td>比较运算符</td>
<td><code>__eq__</code> <code>__gt__</code> <code>__lt__</code> <code>__ge__</code> <br><code>__le__</code> <code>__ne__</code></td>
</tr>
<tr>
<td>算术运算符</td>
<td><code>__add__</code> <code>__sub__</code> <code>__mul__</code> <code>__truediv__</code> <br> <code>__floordiv__</code> <code>__mod__</code> <code>__divmod__</code> <code>__pow__``__round__</code></td>
</tr>
<tr>
<td>反向算术运算符</td>
<td><code>__radd__</code> <code>__rsub__</code> <code>__rmul__</code> <code>__rtruediv__</code> <code>__rfloordiv__</code> <code>__rmod__</code> <code>__rdivmod__</code> <code>__rpow__</code></td>
</tr>
<tr>
<td>增量赋值算术运算</td>
<td><code>__iadd__</code> <code>__isub__</code> <code>__imul__</code> <code>__itruediv__</code> <code>__ifloordiv__</code> <code>__imod__</code> <code>__ipow__</code></td>
</tr>
<tr>
<td>位运算符</td>
<td><code>__invert__</code>~  <code>__lshift__</code>&lt;&lt;  <code>__rshift__</code>&gt;&gt;  <code>__and__</code>&amp;  <code>__or__</code>|  <code>__xor__</code>^</td>
</tr>
<tr>
<td>反向位运算符</td>
<td><code>__rlshfit__</code> <code>__rrshift__</code> <code>__rand__</code> <code>__ror__</code> <code>__rxor__</code></td>
</tr>
<tr>
<td>增量赋值位运算符</td>
<td><code>__ilshift__</code> <code>__irshift__</code> <code>__iand__</code> <code>__ior__</code> <code>__ixor__</code></td>
</tr>
</tbody>
</table>
<h2 class="mume-header" id="%E5%BA%8F%E5%88%97%E6%9E%84%E6%88%90%E7%9A%84%E6%95%B0%E7%BB%84">序列构成的数组</h2>

<h3 class="mume-header" id="%E5%86%85%E7%BD%AE%E5%BA%8F%E5%88%97%E7%B1%BB%E5%9E%8B%E9%A2%84%E8%A7%88">内置序列类型预览</h3>

<ul>
<li>容器序列：list、tuple、collections.deque 这些序列能存放不同类型的数据；</li>
<li>扁平序列：str、bytes、bytearray、memoryview 和 array.array，这类序列只能容纳一种类型。</li>
</ul>
<p>容器序列存放的是它们所包含的任意类型的对象的引用，而扁平序列里存放的是值而不是引用。换句话说，扁平序列其实是一段连续的内存空间，由此可见扁平序列其实更加紧凑，但是它里面只能存放诸如字符、字节和数值这种基础类型。</p>
<p>序列还能按能否被修改进行分类：</p>
<ul>
<li>可变序列：list、collections.deque、bytearray、array.array、memoryview。</li>
<li>不可变序列：tuple、str、bytes。</li>
</ul>
<p>列表推导是一种构建列表的方法，它异常强大，然而由于相关的语句比较晦涩，人们往往不愿意去用它。</p>
<h3 class="mume-header" id="%E5%88%97%E8%A1%A8%E6%8E%A8%E5%AF%BC%E5%92%8C%E7%94%9F%E6%88%90%E5%99%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F">列表推导和生成器表达式</h3>

<p>类型推导是构建列表(list)的快捷方式，而生成器列表则可以用于创建任何类型的序列。</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token comment"># 创建一个特殊的字符串</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">chr</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">36</span><span class="token punctuation">,</span><span class="token number">162</span><span class="token punctuation">,</span><span class="token number">163</span><span class="token punctuation">,</span><span class="token number">165</span><span class="token punctuation">,</span><span class="token number">8364</span><span class="token punctuation">,</span><span class="token number">164</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><pre data-role="codeBlock" data-info="" class="language-"><code>$&#xA2;&#xA3;&#xA5;&#x20AC;&#xA4;
</code></pre><p>将一个字符串变成 Unicode 码位的列表：</p>
<pre data-role="codeBlock" data-info="python" class="language-python">symbols <span class="token operator">=</span> <span class="token string">'$¢£¥€¤'</span>
codes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> symbols<span class="token punctuation">:</span>
    codes<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
codes
</pre><pre data-role="codeBlock" data-info="" class="language-"><code>[36, 162, 163, 165, 8364, 164]
</code></pre><p>使用列表解析的方法：</p>
<pre data-role="codeBlock" data-info="python" class="language-python">symbols <span class="token operator">=</span> <span class="token string">'$¢£¥€¤'</span>
codes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">ord</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> symbols<span class="token punctuation">]</span>
codes
</pre><pre data-role="codeBlock" data-info="" class="language-"><code>[36, 162, 163, 165, 8364, 164]
</code></pre><p>输出相同。</p>
<p>列表推导可能被滥用。以前看过有的Python代码用列表推导来重复获取一个函数的副作用。</p>
<div class="code-chunk" data-id="code-chunk-id-2" data-cmd="python"><div class="input-div"><pre data-role="codeBlock" data-info="python {code_chunk_offset=2, cmd}" class="language-python">funcs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span>i<span class="token operator">+</span>x <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>funcs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>funcs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>funcs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><div class="btn-group"><div class="run-btn btn"><span>▶︎</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"></div></div><p>上述的代码可以改良为：</p>
<div class="code-chunk" data-id="code-chunk-id-3" data-cmd="python"><div class="input-div"><pre data-role="codeBlock" data-info="python {code_chunk_offset=3, cmd}" class="language-python">funcs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">lambda</span> x<span class="token punctuation">,</span>i<span class="token operator">=</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span>x <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>funcs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>funcs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>funcs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><div class="btn-group"><div class="run-btn btn"><span>▶︎</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"></div></div><p>通常的原则是：只用列表推导来创建新的列表，并且尽量保持简短。如果列表推导的代码超过两行，你可能就要考虑是不是得用for循环来重写了。</p>
<p><strong>语法提示</strong>：Python 会忽略代码中的 []、{}、和 () 中的换行，因此，如果你的代码中有多行的列表、列表推导、生成器表达式、字典这一类的，可以省略不太好看的续行符 <code>\</code>。</p>
<p>在 Python2.x 中，列表推导中 for 关键字会破坏上下文，如：</p>
<pre data-role="codeBlock" data-info="python" class="language-python">Python <span class="token number">2.7</span><span class="token number">.10</span> <span class="token punctuation">(</span>default<span class="token punctuation">,</span> Oct  <span class="token number">6</span> <span class="token number">2017</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">:</span><span class="token number">29</span><span class="token punctuation">:</span><span class="token number">07</span><span class="token punctuation">)</span> 
<span class="token punctuation">[</span>GCC <span class="token number">4.2</span><span class="token number">.1</span> Compatible Apple LLVM <span class="token number">9.0</span><span class="token number">.0</span> <span class="token punctuation">(</span>clang<span class="token operator">-</span><span class="token number">900.0</span><span class="token number">.31</span><span class="token punctuation">)</span><span class="token punctuation">]</span> on darwin
Type <span class="token string">"help"</span><span class="token punctuation">,</span> <span class="token string">"copyright"</span><span class="token punctuation">,</span> <span class="token string">"credits"</span> <span class="token operator">or</span> <span class="token string">"license"</span> <span class="token keyword">for</span> more information<span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> x <span class="token operator">=</span> <span class="token string">'my precious'</span>
<span class="token operator">>></span><span class="token operator">></span> dummy <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token string">'ABC'</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> x
<span class="token string">'C'</span>
</pre><p>同理，在Pytho2.x中，for循环也会破坏 context：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> x <span class="token operator">=</span> <span class="token string">'my precious'</span>
<span class="token operator">>></span><span class="token operator">></span> dummy <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token string">'ABC'</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     dummy<span class="token punctuation">.</span>append<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">>></span><span class="token operator">></span> x
<span class="token string">'C'</span>
</pre><p>而在 Python3中，使用 for 循环还是会破坏 context，而使用列表推导就不会出现这种情况：</p>
<pre data-role="codeBlock" data-info="python" class="language-python">Python <span class="token number">3.6</span><span class="token number">.3</span> <span class="token punctuation">(</span>v3<span class="token punctuation">.</span><span class="token number">6.3</span><span class="token punctuation">:</span><span class="token number">2c5fed86e0</span><span class="token punctuation">,</span> Oct  <span class="token number">3</span> <span class="token number">2017</span><span class="token punctuation">,</span> <span class="token number">00</span><span class="token punctuation">:</span><span class="token number">32</span><span class="token punctuation">:</span><span class="token number">08</span><span class="token punctuation">)</span> 
<span class="token punctuation">[</span>GCC <span class="token number">4.2</span><span class="token number">.1</span> <span class="token punctuation">(</span>Apple Inc<span class="token punctuation">.</span> build <span class="token number">5666</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>dot <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span> on darwin
Type <span class="token string">"help"</span><span class="token punctuation">,</span> <span class="token string">"copyright"</span><span class="token punctuation">,</span> <span class="token string">"credits"</span> <span class="token operator">or</span> <span class="token string">"license"</span> <span class="token keyword">for</span> more information<span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> x <span class="token operator">=</span> <span class="token string">'my precious'</span>
<span class="token operator">>></span><span class="token operator">></span> dumps <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token string">'ABC'</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> x
<span class="token string">'my precious'</span>
<span class="token operator">>></span><span class="token operator">></span> dumps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token string">'ABC'</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     dumps<span class="token punctuation">.</span>append<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">>></span><span class="token operator">></span> x
<span class="token string">'C'</span>
</pre><p>Python3中，列表推导、生成器表达式 以及同它们很相似的集合推导、字典推导都有自己的局部作用域，就像函数似的表达式内部的变量和赋值只在局部起作用，表达式的上下文中的同名变量可以被正常引用，局部变量不会影响到它们。</p>
<h4 class="mume-header" id="%E5%88%97%E8%A1%A8%E6%8E%A8%E5%AF%BC%E5%90%8C-map-filter%E7%9A%84%E6%AF%94%E8%BE%83">列表推导同 map、filter的比较</h4>

<p>filter 和 map 合起来能做的事情，列表推导也能做，而且不需要借助难以理解和阅读的 lambda 表达式。而且效率并不一定比它们差，所以只需要记 列表推导好了。</p>
<h4 class="mume-header" id="%E7%AC%9B%E5%8D%A1%E5%B0%94%E7%A7%AF">笛卡尔积</h4>

<p>用列表推导可以生成两个或两个以上的可迭代类型的笛卡尔积。笛卡尔积是一个列表，列表中的元素是由输入的迭代类型的元素对构成的元组，因此笛卡尔积列表的长度等于输入变量的长度的乘积：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> colors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'block'</span><span class="token punctuation">,</span> <span class="token string">'white'</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> sizes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'S'</span><span class="token punctuation">,</span> <span class="token string">'M'</span><span class="token punctuation">,</span> <span class="token string">'L'</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> tshirts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token keyword">for</span> s <span class="token keyword">in</span> sizes <span class="token keyword">for</span> c <span class="token keyword">in</span> colors<span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> tshirts
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'S'</span><span class="token punctuation">,</span> <span class="token string">'block'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'S'</span><span class="token punctuation">,</span> <span class="token string">'white'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'M'</span><span class="token punctuation">,</span> <span class="token string">'block'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
<span class="token punctuation">(</span><span class="token string">'M'</span><span class="token punctuation">,</span> <span class="token string">'white'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'L'</span><span class="token punctuation">,</span> <span class="token string">'block'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'L'</span><span class="token punctuation">,</span> <span class="token string">'white'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</pre><h4 class="mume-header" id="%E7%94%9F%E6%88%90%E5%99%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F">生成器表达式</h4>

<p>虽然也可以用列表推导来初始化元组、数组或其他序列类型，但是生成器表达式是更好的选择。这是因为生成器表达式背后遵循了迭代器协议，可以逐个地产生元素，而不是先建立一个完整的列表，然后把这个列表传递到某个构造函数中。</p>
<p>生成器更加节省内存。</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> symbols <span class="token operator">=</span> <span class="token string">'$¢£¥€¤'</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">tuple</span><span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">for</span> s <span class="token keyword">in</span> symbols<span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">162</span><span class="token punctuation">,</span> <span class="token number">163</span><span class="token punctuation">,</span> <span class="token number">165</span><span class="token punctuation">,</span> <span class="token number">8364</span><span class="token punctuation">,</span> <span class="token number">164</span><span class="token punctuation">)</span>
</pre><p>如果生成器表达式是一个函数调用过程中的唯一参数，那么不需要额外用括号将它包围起来。如果不唯一，那么要包围。</p>
<p>如果用生成器，生成器表达式会在每次for循环运行时才生成一个组合，不会再用大量内存空间：</p>
<div class="code-chunk" data-id="code-chunk-id-4" data-cmd="python"><div class="input-div"><pre data-role="codeBlock" data-info="python{code_chunk_offset=4, cmd}" class="language-python">sizes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'S'</span><span class="token punctuation">,</span> <span class="token string">'M'</span><span class="token punctuation">,</span> <span class="token string">'L'</span><span class="token punctuation">]</span>
colors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'block'</span><span class="token punctuation">,</span> <span class="token string">'white'</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> tshirt <span class="token keyword">in</span> <span class="token punctuation">(</span>f<span class="token string">'{s} {c}'</span> <span class="token keyword">for</span> s <span class="token keyword">in</span> sizes 
                          <span class="token keyword">for</span> c <span class="token keyword">in</span> colors<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>tshirt<span class="token punctuation">)</span>
</pre><div class="btn-group"><div class="run-btn btn"><span>▶︎</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"></div></div><h3 class="mume-header" id="%E5%85%83%E7%BB%84%E4%B8%8D%E4%BB%85%E4%BB%85%E6%98%AF%E4%B8%8D%E5%8F%AF%E5%8F%98%E7%9A%84%E5%88%97%E8%A1%A8">元组不仅仅是不可变的列表</h3>

<p>有些 Python 入门教程将元组称为是 “不可变列表”，然而这并没有完全概括元组的特点。</p>
<p>除了用作不可变的列表之外，它还可以用于没有字段名的记录。</p>
<h4 class="mume-header" id="%E5%85%83%E7%BB%84-%E8%AE%B0%E5%BD%95">元组-记录</h4>

<p>元组其实是对数据的记录：元组中的每个元素都存放了记录中的一个字段的数据，外加这个字段的位置，正是这个位置信息给数据赋予了意义。</p>
<p>如果只把元组理解为不可变的列表，那其他信息——它所含有的元素的总数和它们的位置似乎就变得可有可无了。但是如果把元组动作一些字段的集合，那么数量和位置信息就变得非常重要。</p>
<p>元组拆包：</p>
<div class="code-chunk" data-id="code-chunk-id-5" data-cmd="python"><div class="input-div"><pre data-role="codeBlock" data-info="python {code_chunk_offset=5, cmd}" class="language-python">a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'black'</span><span class="token punctuation">,</span> <span class="token string">'white'</span><span class="token punctuation">,</span> <span class="token string">'yellow'</span><span class="token punctuation">,</span> <span class="token string">'red'</span><span class="token punctuation">,</span> <span class="token string">'green'</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">]</span>
<span class="token comment"># 获取第三、四个元素，忽略其他的</span>
_<span class="token punctuation">,</span>_<span class="token punctuation">,</span>c<span class="token punctuation">,</span>d<span class="token punctuation">,</span><span class="token operator">*</span>rest <span class="token operator">=</span> a
<span class="token keyword">print</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span>d<span class="token punctuation">)</span>
<span class="token comment"># 获取最后两个元素</span>
<span class="token operator">*</span>head<span class="token punctuation">,</span>c<span class="token punctuation">,</span>d <span class="token operator">=</span> a
<span class="token keyword">print</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span>d<span class="token punctuation">)</span>
</pre><div class="btn-group"><div class="run-btn btn"><span>▶︎</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"></div></div><p>元组的拆包是可以嵌套的：</p>
<div class="code-chunk" data-id="code-chunk-id-6" data-cmd="python"><div class="input-div"><pre data-role="codeBlock" data-info="python {code_chunk_offset=6, cmd}" class="language-python">vehicles <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">(</span><span class="token number">87</span><span class="token punctuation">,</span> <span class="token string">'BWM'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">35.3</span><span class="token punctuation">,</span> <span class="token number">143.6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">98</span><span class="token punctuation">,</span> <span class="token string">'Ford'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">33.7</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">120.7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span> <span class="token string">'Porsche'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">23.9</span><span class="token punctuation">,</span> <span class="token number">117.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
<span class="token keyword">for</span> speed<span class="token punctuation">,</span> brand<span class="token punctuation">,</span> <span class="token punctuation">(</span>lantitude<span class="token punctuation">,</span>longitude<span class="token punctuation">)</span> <span class="token keyword">in</span> vehicles<span class="token punctuation">:</span>
    <span class="token keyword">if</span> longitude <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">'{brand} : ({lantitude}, '</span>
        f<span class="token string">'{ longitude}), {speed}km/s'</span><span class="token punctuation">)</span>
</pre><div class="btn-group"><div class="run-btn btn"><span>▶︎</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"></div></div><h4 class="mume-header" id="%E5%85%B7%E5%90%8D%E5%85%83%E7%BB%84">具名元组</h4>

<p><code>collections.namedtuple</code> 是一个工厂函数。</p>
<p>用 namedtuple 构建的类的实例所消耗的内存跟元组是一样的，因为字段名被存在对应的类里面。这个实例跟普通的对象实例比起来也要小一些，因为 Python 不会用 <code>__dict__</code> 来存放这些实例的属性。</p>
<div class="code-chunk" data-id="20180415214553" data-cmd="python"><div class="input-div"><pre data-role="codeBlock" data-info="python {code_chunk_offset=7, cmd id=&amp;amp;quot;20180415214553&amp;amp;quot;}" class="language-python"><span class="token keyword">from</span> collections <span class="token keyword">import</span> namedtuple
City <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">'City'</span><span class="token punctuation">,</span> <span class="token string">'name population coordinates'</span><span class="token punctuation">)</span>
beijin <span class="token operator">=</span> City<span class="token punctuation">(</span><span class="token string">'Beijin'</span><span class="token punctuation">,</span> <span class="token number">2170</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">116</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><div class="btn-group"><div class="run-btn btn"><span>▶︎</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"></div></div><div class="code-chunk" data-id="code-chunk-id-8" data-cmd="python"><div class="input-div"><pre data-role="codeBlock" data-info="python {code_chunk_offset=8, cmd continue}" class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span>beijin<span class="token punctuation">.</span>population<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>beijin<span class="token punctuation">.</span>coordinates<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>beijin<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><div class="btn-group"><div class="run-btn btn"><span>▶︎</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"></div></div><p>除了从普通元组继承的属性外，还有 <code>_fields</code>类属性、<code>_make(iterable)</code>类方法和实例方法<code>_asdict()</code>:</p>
<div class="code-chunk" data-id="code-chunk-id-9" data-cmd="python"><div class="input-div"><pre data-role="codeBlock" data-info="python {code_chunk_offset=9, cmd continue=&amp;amp;quot;20180415214553&amp;amp;quot;}" class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span>City<span class="token punctuation">.</span>_fields<span class="token punctuation">)</span>
</pre><div class="btn-group"><div class="run-btn btn"><span>▶︎</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"></div></div><h4 class="mume-header" id="tuple%E6%B2%A1%E6%9C%89%E7%9A%84%E6%96%B9%E6%B3%95">tuple没有的方法</h4>

<p>进行修改的方法：+=、-=、*=、append、<code>__delitem__</code>、clear、extend、insert、remove、pop、reverse</p>
<p>没意义的方法：copy（因为元组不能修改，没必要深度拷贝）</p>
<h3 class="mume-header" id="%E5%88%87%E7%89%87">切片</h3>

<p>在 Python 中，像list、tuple和str这类序列类型都支持切片操作，但是实际上切片化操作比人们所想象的要强大得多。</p>
<h4 class="mume-header" id="%E4%B8%BA%E4%BB%80%E4%B9%88%E5%88%87%E7%89%87%E5%92%8C%E5%8C%BA%E9%97%B4%E4%BC%9A%E5%BF%BD%E7%95%A5%E6%9C%80%E5%90%8E%E4%B8%80%E4%B8%AA%E5%85%83%E7%B4%A0">为什么切片和区间会忽略最后一个元素</h4>

<p>在切片和区间操作中不包含区间范围的最后一个元素是Python的风格，这个习惯符合 Python、C和其他语言中以0作为其实下标的传统，好处：</p>
<ul>
<li>range(3) 和 my_list[:3] 都返回3个元素</li>
<li>方便计算长度，my_list[start:stop] 共stop-start个元素</li>
<li>便于分割：my_list[:x] 和 my_list[x:]不会重合</li>
</ul>
<p>Python 解释器对切片操作的理解：<br>
<code>s[a:b:c]</code> 的形式对 s 在 a 和 b 之间以 c 为间隔取值。c 的值可以为负，表示方向取值。</p>
<h4 class="mume-header" id="%E5%A4%9A%E7%BB%B4%E5%88%87%E7%89%87%E5%92%8C%E7%9C%81%E7%95%A5">多维切片和省略</h4>

<p>[] 运算符还可以使用以逗号分开的多个索引或者是切片，外部库 NumPy 就是用到了这个特性，二维的 numpy.ndarray 就可以用 a[i,j] 这种形式来获取，抑或是 a[m:n, k:l] 的方式来得到二维切片。</p>
<p><strong>Python 内置的序列类型都是一维的，因此它们只支持单一的索引，成对出现的索引是没有用的。</strong></p>
<p>省略(ellipsis) 的正确书写方法是三个英语句号，在 NumPy 中，x[i,...] 就是 x[i,:,:,:]的缩写。</p>
<p>一个错误的嵌套列表使用方法：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> weird_board <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'-'</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">3</span>
<span class="token operator">>></span><span class="token operator">></span> weird_board
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'-'</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'-'</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'-'</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> weird_board<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'o'</span>
<span class="token operator">>></span><span class="token operator">></span> weird_board
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'-'</span><span class="token punctuation">,</span> <span class="token string">'o'</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'-'</span><span class="token punctuation">,</span> <span class="token string">'o'</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'-'</span><span class="token punctuation">,</span> <span class="token string">'o'</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</pre><p>正确的应该是：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> normal_board <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'-'</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">3</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> normal_board
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'-'</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'-'</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'-'</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> normal_board<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'o'</span>
<span class="token operator">>></span><span class="token operator">></span> normal_board
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'-'</span><span class="token punctuation">,</span> <span class="token string">'o'</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'-'</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'-'</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</pre><h3 class="mume-header" id="%E5%BA%8F%E5%88%97%E7%9A%84%E5%A2%9E%E9%87%8F%E8%B5%8B%E5%80%BC">序列的增量赋值</h3>

<p>+= 背后的特殊方法是<code>__iadd__</code> ，但是如果一个类没有实现这个方法的话，Python就会退一步调用 <code>__add__</code>。</p>
<p>总的来说，可变序列一般都实现了 <code>__iadd__</code> 方法，因此 += 是就地加法，而不可变序列根本就不支持这个操作，所以会关联到新的变量上。</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> l <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span>
<span class="token comment"># id : return the identity of an object</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">id</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span>
<span class="token number">4368634376</span>
<span class="token operator">>></span><span class="token operator">></span> l <span class="token operator">*=</span> <span class="token number">2</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">id</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span>
<span class="token number">4368634376</span>
<span class="token operator">>></span><span class="token operator">></span> t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">id</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
<span class="token number">4368618984</span>
<span class="token operator">>></span><span class="token operator">></span> t <span class="token operator">*=</span> <span class="token number">2</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">id</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
<span class="token number">4364255592</span>
</pre><p>从上面的例子可以看出，可变序列的 id 在增量赋值时不会改变，不可变序列在增量赋值是会改变 id。</p>
<p>对不可变序列进行重复拼接的时候，效率很很低，因为每次都有一个新对象，而解释器需要把原来对象中的元素先复制到新的对象中，然后追加新的元素。【str 是个例外，效率也很快，毕竟对字符串的 += 操作也非常普遍】</p>
<p>一个 += 的谜题：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> t<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span>
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>
  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>
TypeError<span class="token punctuation">:</span> <span class="token string">'tuple'</span> <span class="token builtin">object</span> does <span class="token operator">not</span> support item assignment
<span class="token operator">>></span><span class="token operator">></span> t
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><p>在抛出异常的同时，居然实现了功能。</p>
<p>查看 <code>s[a] += b</code> 操作的字节码：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> dis<span class="token punctuation">.</span>dis<span class="token punctuation">(</span><span class="token string">'s[a]+=b'</span><span class="token punctuation">)</span>
  <span class="token number">1</span>           <span class="token number">0</span> LOAD_NAME                <span class="token number">0</span> <span class="token punctuation">(</span>s<span class="token punctuation">)</span>
              <span class="token number">2</span> LOAD_NAME                <span class="token number">1</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span>
              <span class="token number">4</span> DUP_TOP_TWO
              <span class="token number">6</span> BINARY_SUBSCR
              <span class="token number">8</span> LOAD_NAME                <span class="token number">2</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span>
             <span class="token number">10</span> INPLACE_ADD
             <span class="token number">12</span> ROT_THREE
             <span class="token number">14</span> STORE_SUBSCR
             <span class="token number">16</span> LOAD_CONST               <span class="token number">0</span> <span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>
             <span class="token number">18</span> RETURN_VALUE

</pre><p>可以看出：在第 10 处，进行了增量赋值操作，在第 14 处对 s 进行赋值。而如果s第不可变序列，就会出错。</p>
<p>总结：</p>
<ul>
<li>不要把可变对象放在元组中</li>
<li>增量赋值不是一个原子操作，它虽然抛出了异常，也实现了功能</li>
<li>查看 Python 的字节码并不难，对了解代码背后的运行机制非常有帮助</li>
</ul>
<h3 class="mume-header" id="listsort-%E6%96%B9%E6%B3%95%E5%92%8C%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0-sorted">list.sort 方法和内置函数 sorted</h3>

<p><code>list.sort</code> 方法会就地排序列表，也就是说不会把原列表复制一份。这也是这个方法的返回值是 None 的原因。</p>
<p>与 <code>list.sort</code> 相反的是内置函数 sorted，它会新建一个列表作为返回值。这个方法可以接受任何形式的可迭代对象作为参数，甚至包括不可变序列或生成器。而不管 sorted 接受的是怎样的参数，它最后都会返回一个列表。</p>
<p>不管是 list.sort 还是 sorted ，它都接受两个参数 <em>key</em> 和 <em>reverse</em>。</p>
<h3 class="mume-header" id="%E7%94%A8-bisect-%E6%9D%A5%E7%AE%A1%E7%90%86%E5%B7%B2%E6%8E%92%E5%BA%8F%E7%9A%84%E5%BA%8F%E5%88%97">用 bisect 来管理已排序的序列</h3>

<p>bisect 模块中包含两个主要函数，bisect 和 insort，两个函数都利用二分查找算法在有序序列中查找或插入元素。</p>
<ul>
<li><code>bisect(haystack, needle)</code> : 在 haystack 中搜索 needle 的位置，该位置满足的条件是：把 needle 插入该位置后，haystack 仍然保持升序。也就是说：这个函数返回的位置前面的值，都小于或等于 needle 的值。其中 haystack 必须是有序序列。</li>
</ul>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> bisect
<span class="token operator">>></span><span class="token operator">></span> l <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> bisect<span class="token punctuation">.</span>bisect<span class="token punctuation">(</span>l<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token number">1</span>
<span class="token operator">>></span><span class="token operator">></span> l<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> l
<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> bisect<span class="token punctuation">.</span>insort<span class="token punctuation">(</span>l<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> l
<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span>
</pre><h3 class="mume-header" id="%E5%BD%93%E5%88%97%E8%A1%A8%E4%B8%8D%E6%98%AF%E9%A6%96%E9%80%89%E6%97%B6">当列表不是首选时</h3>

<p>虽然列表既灵活又简单，但面对各种需求时，我们可能会有更好的选择，数组 <code>array</code> 的效率要高得多，因为数组在背后存的并不是 float 对象，而是数字的机器翻译，即字节表述。这一点就跟 C 语言中的数组一样。</p>
<p>再比如，若要频繁对序列进行先进先出的操作，<code>deque</code> 的速度回更快。</p>
<p>而 set 的包含操作（检查一个元素是否出现在一个集合中）效率很高。</p>
<h4 class="mume-header" id="%E6%95%B0%E7%BB%84">数组</h4>

<p>如果我们需要一个只包含数字的列表，那么 array.array 比 list 更加高效，包括 <code>.pop</code> <code>.insert</code> <code>.extend</code>。另外，数组还提供了从文件读取和存入的更快的方法：<code>.fromfile</code> 和 <code>.tofile</code>。</p>
<p>Python 数组跟 C 语言数组一样精简，创建数组需要一个类型码，用于表示在底层的 C 语言中应该存放怎样的数据类型，比如 b 类型表示有符号字符（signed char），因此 <code>array('b')</code> 创建出的数组就只能存放一个字节大小的整数，范围从 -128~127，这样在序列很大的时候，我们能节省很多空间。</p>
<p>另外，一个快速序列化数字类型的方法是使用：<code>pickle</code> 模块。pickle.dump 处理发电数组的速度几乎跟 array.tofile 一样快。不过 <code>pickle</code> 可以处理几乎所有的内置函数字类型，包括数字、嵌套集合，甚至用户自定义的类。前提是这些类没有什么特别复杂的实现。</p>
<p>从 Python 3.4 开始，数组类型不在支持诸如 <code>list.sort()</code> 这种就地排序方法。要给数组排序的话，得用 sorted 函数新建一个数组。</p>
<pre data-role="codeBlock" data-info="python" class="language-python">a <span class="token operator">=</span> array<span class="token punctuation">.</span>array<span class="token punctuation">(</span>a<span class="token punctuation">.</span>typecode<span class="token punctuation">,</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><p>要在不打乱次序的情况下为数组添加新的元素，可以用<code>bisect.insort</code>。</p>
<h4 class="mume-header" id="%E5%86%85%E5%AD%98%E8%A7%86%E5%9B%BE">内存视图</h4>

<p><code>memoryview</code> 是一个内置类，它能让用户在不复制内容的情况下操作同一个数组的不同切片。<code>memoryview</code> 的概念受到了 NumPy 的启发。</p>
<blockquote>
<p>memoryview 其实是泛化和去数学化的NumPy数组。它让你在不需要复制内容的前提下，在数据结构之间共享内存。其中，数据结构可以是任何形式，比如 PIL 图片、SQLite数据库 和 NumPy 的数组，等等。这个功能在处理大型数据集合的时候非常重要。</p>
</blockquote>
<p><code>memoryview.cast</code> 和 C语言中的类型转换非常类似。memoryview.cast 会把同一块内存里的内容打包成一个全新的 <code>memoryview</code> 对象。</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> numbers <span class="token operator">=</span> array<span class="token punctuation">(</span><span class="token string">'h'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> memv <span class="token operator">=</span> <span class="token builtin">memoryview</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> memv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token operator">-</span><span class="token number">2</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span>memv<span class="token punctuation">)</span>
<span class="token number">5</span>
<span class="token operator">>></span><span class="token operator">></span> memv_oct <span class="token operator">=</span> memv<span class="token punctuation">.</span>cast<span class="token punctuation">(</span><span class="token string">'B'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">list</span><span class="token punctuation">(</span>memv_oct<span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">254</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> memv_oct<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4</span>
<span class="token operator">>></span><span class="token operator">></span> numbers
array<span class="token punctuation">(</span><span class="token string">'h'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</pre><p>如果利用数组来做高级的数字处理是你的日常工作，那么 NumPy 和 SciPy 应该是你的常用武器。</p>
<p><strong>NumPy 和 SciPy</strong></p>
<p>凭借着 NumPy 和 SciPy 提供的高阶数组和矩阵操作，Python 成为了科学计算应用的主流语言。</p>
<p><strong>双向列表</strong><br>
<code>list</code> 利用 append 和 pop 可以模拟先进后出的堆栈操作。也可以通过 append 和 pop(0) 来模拟队列操作，不过删除列表第一个元素（或者是在第一个元素之前添加一个元素）之类的操作都是很耗时的，因为这些操作会牵扯到移动列表中的所有元素。</p>
<p><code>collections.deque</code> 类是一个线程安全、可以快速从两端添加或者删除元素的数据类型。而如果想要有一种数据类型存放 “最近使用到的几个元素”，deque也是一个很好的选择。<strong>新建一个双向队列的时候可以指定队列的大小，如果队列满员，还可以从反向端删除过期的元素，然后在尾端添加新的元素。</strong></p>
<p><code>deque([iterable[, maxlen]]) --&gt; deque object</code>，maxlen 是一个可选参数，代表这个队列可以容纳的元素数量，一旦设定，这个属性就不能修改了。</p>
<p>append 和 popleft 都是原子操作，也就是说 deque 可以在多线程中安全地当先进先出的栈使用，而不需要担心资源锁的问题。</p>
<p>除了 deque 之外，还有一些其他的Python标准库也有对队列的实现。</p>
<p>queue：提供了同步(线程安全)类Queue、LifoQueue和PriorityQueue，不同的线程可以利用这些数据类型来交换信息。这3个类的构造方法都有一个可选参数 maxsize，它接受正整数作为输入值，用来限定队列的大小。但是在满员的时候，这些类不会扔掉就的元素来腾出位置，而是会被锁住，直到另外的线程移除了某个元素而腾出位置。这一特性让这些类很适合用来控制活跃线程的数量。</p>
<p>asyncio：Python3.4 新提供的包，里面有 Queue、LifoQueue、PriorityQueue 和 JoinableQueue，这些类受到 queue 和 multiprocessing 模块的影响，但是为异步编程里的任务管理提供了专门的便利。</p>
<p>注意：list 中最好存放同类型的数据，至少是存放能够相互比较的数据，否则 sort 和 sorted 都不能使用了。而 tuple 并经常用来存放不同类型的元素，这也符合它的本质，元组就是用作存放彼此之间没有关系的数据的记录，也并不需要进行比较。</p>
<p><strong>key 参数很妙</strong> ：list.sort/sorted/max/min函数的key参数使一个很棒的设计，其他语言里的排序函数需要用户提供一个接受两个参数的比较函数作为参数，比如 Python2 中的 cmp(a,b) 。用 key 参数能把事情变得简单且高效，简单是因为只需要提供一个单参数函数来提取或计算一个值作为比较大小的标准即可，而 Python2 的这种设计需要用户写一个返回值是 -1、0或1的双参数函数。说它高效，是因为在每个元素上，key 函数只会被调用一次，而双参数比较函数则在每次两两比较的时候都会被调用。诚然，在排序的时候，Python总会比较两个键 key，但是那一阶段的计算会发生在C语言那一层，这样会比调用用户自定义的Python比较函数更快。</p>
<p>另外，key参数也能让你对一个混有数字字符和数值的列表进行排序：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'12'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token string">'8'</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'15'</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">'8'</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">'12'</span><span class="token punctuation">,</span> <span class="token string">'15'</span><span class="token punctuation">]</span>
</pre><p>sorted 和 list.sort 背后的排序算法是 Timsort，它是一种自适应算法，会根据原始数据的顺序特点交替使用插入排序和归并排序，以达到最佳效率。这样的算法被证明是很有效的，因为来自真实世界中的数据通常是有一定的顺序特点的。</p>
<h2 class="mume-header" id="%E5%AD%97%E5%85%B8%E5%92%8C%E9%9B%86%E5%90%88">字典和集合</h2>

<blockquote>
<p>字典这个数据结构活跃在所有 Python 程序的背后，即使你的编码中没有直接用到它。——A.M. Kuchling</p>
</blockquote>
<p>dict 类型不但在各种程序中广泛使用，<strong>它也是 Python语言的基石</strong>。模型的命名空间、实例属性和函数的关键字参数中都可以看到字典的身影，跟它有关的内置函数都在 <code>__builtins__.__dict__</code>模块中。</p>
<p>正是因为字典至关重要，Python 对它的实现做了高度优化，而散列表则是字典类型性能出众的根本原因。</p>
<p>要想进一步理解集合和字典，首先要理解散列表的原理。</p>
<p>标准库中的所有映射类型都是利用 dict 来实现的，因此它们有一个共同的限制，即只有可散列的数据类型才能用作这些映射里的键。</p>
<p>什么是可散列的？</p>
<blockquote>
<p>如果一个对象是可散列的，那么这个对象的生命周期中，它的散列值是不变的，而且这个对象需要实现 <code>__hash__()</code> 方法。另外，可散列对象还要有 <code>__qe__()</code> 方法，这样才能跟其他键作比较。如果两个散列对象是相等的，那么它们的散列值一定是一样的。</p>
</blockquote>
<p>原子不可变数据类型(str, bytes, 数值类型)都是可散列的，frozenset 也是可散列的。元组的话，只有当一个元组包含的所有元素都是可散列类型的情况下，它才是可散列的：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> tt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">hash</span><span class="token punctuation">(</span>tt<span class="token punctuation">)</span>
<span class="token number">8027212646858338501</span>
<span class="token operator">>></span><span class="token operator">></span> t1<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">hash</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span>
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>
  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>
TypeError<span class="token punctuation">:</span> unhashable <span class="token builtin">type</span><span class="token punctuation">:</span> <span class="token string">'list'</span>
<span class="token operator">>></span><span class="token operator">></span> t1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token builtin">frozenset</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">hash</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span>
<span class="token operator">-</span><span class="token number">4118419923444501110</span>
</pre><p>字典定义了很多的构造方法：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'one'</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'two'</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'three'</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">}</span>
<span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>one<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> two<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> three<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> c <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'one'</span><span class="token punctuation">,</span><span class="token string">'two'</span><span class="token punctuation">,</span><span class="token string">'three'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> d <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'one'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'two'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'three'</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> e <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'one'</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'two'</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'three'</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</pre><p>除了这些字面句法和灵活的构造方法外，字典推导(dict comprehension)也可以用来创建新的dict。</p>
<h3 class="mume-header" id="%E5%AD%97%E5%85%B8%E6%8E%A8%E5%AF%BC">字典推导</h3>

<p>自 Python2.7 以来，列表推导和生成器表达式的概念就移植到了字典上，从而有了字典推导。</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> pairs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'one'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'two'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'three'</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token punctuation">(</span><span class="token string">'four'</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'five'</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'six'</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> d <span class="token operator">=</span> <span class="token punctuation">{</span>k<span class="token punctuation">:</span>v <span class="token keyword">for</span> k<span class="token punctuation">,</span>v <span class="token keyword">in</span> pairs<span class="token punctuation">}</span>
<span class="token operator">>></span><span class="token operator">></span> d
<span class="token punctuation">{</span><span class="token string">'one'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'two'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'three'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'four'</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'five'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'six'</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">}</span>
<span class="token operator">>></span><span class="token operator">></span> d <span class="token operator">=</span> <span class="token punctuation">{</span>k<span class="token punctuation">:</span>v <span class="token keyword">for</span> k<span class="token punctuation">,</span>v <span class="token keyword">in</span> pairs <span class="token keyword">if</span> v<span class="token operator">%</span><span class="token number">2</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">}</span>
<span class="token operator">>></span><span class="token operator">></span> d
<span class="token punctuation">{</span><span class="token string">'two'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'four'</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'six'</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="%E5%B8%B8%E8%A7%81%E7%9A%84%E6%98%A0%E5%B0%84%E6%96%B9%E6%B3%95">常见的映射方法</h3>

<p>表3-1：<code>dict</code>、<code>collections.defaultdict</code> 和 <code>collections.OrderedDict</code>这三种映射类型的方法列表：</p>
<table>
<thead>
<tr>
<th></th>
<th>dict</th>
<th>defaultdict</th>
<th>OrderedDict</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>d.clear()</code></td>
<td>*</td>
<td>*</td>
<td>*</td>
<td>移除所有元素</td>
</tr>
<tr>
<td><code>d.__contains__(k)</code></td>
<td>*</td>
<td>*</td>
<td>*</td>
<td>检查k是否在d中</td>
</tr>
<tr>
<td><code>d.copy()</code></td>
<td>*</td>
<td>*</td>
<td>*</td>
<td>浅复制</td>
</tr>
<tr>
<td><code>d.__copy__()</code></td>
<td></td>
<td>*</td>
<td></td>
<td>用于支持 copy.copy</td>
</tr>
<tr>
<td><code>d.default_factory</code></td>
<td></td>
<td>*</td>
<td></td>
<td>默认值</td>
</tr>
<tr>
<td><code>d.__delitem(k)</code></td>
<td>*</td>
<td>*</td>
<td>*</td>
<td>del d[k],移除键为k的元素</td>
</tr>
<tr>
<td><code>d.fromkeys(it,[initial])</code></td>
<td>*</td>
<td>*</td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><code>d.get(k,[default])</code></td>
<td>*</td>
<td>*</td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><code>d.__getitem__(k)</code></td>
<td>*</td>
<td>*</td>
<td>*</td>
<td>获取d[k]</td>
</tr>
<tr>
<td><code>d.items()</code></td>
<td>*</td>
<td>*</td>
<td>*</td>
<td>返回d中所有键值对</td>
</tr>
<tr>
<td><code>d.__iter__()</code></td>
<td>*</td>
<td>*</td>
<td>*</td>
<td>获取键的迭代器</td>
</tr>
<tr>
<td><code>d.keys()</code></td>
<td>*</td>
<td>*</td>
<td>*</td>
<td>获取所有的键</td>
</tr>
<tr>
<td><code>d.__len__()</code></td>
<td>*</td>
<td>*</td>
<td>*</td>
<td>len(d)</td>
</tr>
<tr>
<td><code>d.__missing__(k)</code></td>
<td></td>
<td>*</td>
<td></td>
<td>d[k]找不到k时被调用</td>
</tr>
<tr>
<td><code>d.move_to_end(k,[last])</code></td>
<td></td>
<td></td>
<td>*</td>
<td>将k的元素移到最靠后或最靠前位置</td>
</tr>
<tr>
<td><code>d.pop(k,[default])</code></td>
<td>*</td>
<td>*</td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><code>d.popitem()</code></td>
<td>*</td>
<td>*</td>
<td>*</td>
<td>随机弹出一个键值对</td>
</tr>
<tr>
<td><code>d.__reversed__()</code></td>
<td></td>
<td></td>
<td>*</td>
<td>对键进行倒叙排列</td>
</tr>
<tr>
<td><code>d.setdefault(k,[default])</code></td>
<td>*</td>
<td>*</td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><code>d.__setitem__(k,v)</code></td>
<td>*</td>
<td>*</td>
<td>*</td>
<td>d[k]=v</td>
</tr>
<tr>
<td><code>d.update(m,[**kargs])</code></td>
<td>*</td>
<td>*</td>
<td>*</td>
<td>用m中内容更新d对应条目</td>
</tr>
<tr>
<td><code>d.values()</code></td>
<td>*</td>
<td>*</td>
<td>*</td>
<td>返回字典中的所有值</td>
</tr>
</tbody>
</table>
<p><strong>鸭子类型(duck typing)</strong>：一种动态类型的风格，在这种风格中，一个对象有效的语义不是由继承自特定的类或特定的接口决定，而是由 <em>当前方法和属性的集合</em> 决定。</p>
<p>鸭子测试可以表述为：当看到一只鸟走起来像鸭子、游泳像鸭子、叫起来也像鸭子，那这只鸟就可以被称为鸭子。</p>
<h3 class="mume-header" id="%E6%98%A0%E5%B0%84%E7%9A%84%E5%BC%B9%E6%80%A7%E9%94%AE%E6%9F%A5%E8%AF%A2">映射的弹性键查询</h3>

<p>有时候为了方便起见，就算某个键在映射里不存在，我们也洗完通过这个件读取值得时候能得到一个默认值，三种方式：</p>
<ul>
<li><code>setdefault</code></li>
<li><code>defaultdict</code></li>
<li>自定义 <code>dict</code> 子类</li>
</ul>
<h4 class="mume-header" id="defaultdict-%E5%A4%84%E7%90%86%E6%89%BE%E4%B8%8D%E5%88%B0%E7%9A%84%E9%94%AE%E7%9A%84%E4%B8%80%E4%B8%AA%E9%80%89%E6%8B%A9">defaultdict 处理找不到的键的一个选择</h4>

<p>在用户创建 <code>defaultdict</code> 对象的时候，就需要给它配置一个为找不到的键创造默认值的方法。</p>
<p>具体而言，在实例化一个 defaultdict 的时候，就需要给它配置一个为找不到的键创造默认值的方法。</p>
<p><strong><code>defaultdict</code> 中的 <code>default_factory</code> 只会在 <code>__getitem__</code>中被调用，其他地方不会发挥作用，比如 dd 是一个 <code>defaultdict</code>，k 是个找不到的键，dd[k] 会调用 <code>default_factory</code>，不过 dd.get(k) 会返回 None。</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> dd <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> dd<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> dd<span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token punctuation">]</span>
</pre><p>所有者一切背后的功臣其实是特殊方法 <code>__missing__</code>，它会在<code>defaultdict</code>遇到找不到的键的时候调用<code>default_factory</code>,而实际这个特性是所有映射类型都可以选择去支持的。</p>
<div class="code-chunk" data-id="code-chunk-id-10" data-cmd="python"><div class="input-div"><pre data-role="codeBlock" data-info="python {code_chunk_offset=10, cmd}" class="language-python"><span class="token keyword">class</span> <span class="token class-name">MyDict</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> default_factory<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>default_factory <span class="token operator">=</span> default_factory
    <span class="token keyword">def</span> <span class="token function">__missing__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>default_factory<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">[</span>k<span class="token punctuation">]</span>

md <span class="token operator">=</span> MyDict<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span>
md<span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>md<span class="token punctuation">)</span>
</pre><div class="btn-group"><div class="run-btn btn"><span>▶︎</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"></div></div><blockquote>
<p><code>__missing__</code> 方法只会被 <code>__getitem__</code> 调用(比如在表达式 d[k] 中)。提供 <code>__missing__</code> 方法对 get 或 <code>__contains__</code> 这些方法的使用没有影响。</p>
</blockquote>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token keyword">class</span> <span class="token class-name">StrKeyDict0</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__missing__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> KeyError<span class="token punctuation">(</span>k<span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> k<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> self<span class="token punctuation">[</span>k<span class="token punctuation">]</span>
        <span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>
            <span class="token keyword">return</span> default
    <span class="token keyword">def</span> <span class="token function">__contains__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> k <span class="token keyword">in</span> self<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">or</span> <span class="token builtin">str</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span>
d <span class="token operator">=</span> StrKeyDict0<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token string">'two'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">,</span><span class="token string">'four'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
d<span class="token punctuation">[</span><span class="token string">'2'</span><span class="token punctuation">]</span>
d<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>
</pre><blockquote>
<p>如果要自定义一个映射类型，更合适的策略是继承 <code>collection.UserDict</code>类。</p>
</blockquote>
<h3 class="mume-header" id="%E5%AD%97%E5%85%B8%E7%9A%84%E5%8F%98%E7%A7%8D">字典的变种</h3>

<p><code>collections.OrderedDict</code> : 这个类型在添加键的时候会被保持顺序，因此键的迭代次序总是一致；</p>
<p><code>collecton.ChainMap</code> : 该类型可以容纳数个不同的映射对象，然后在进行键查找操作的时候，这些对象会被当做一个整体被逐个查找，找到键被找到为止。</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> d1 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'one'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'two'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'three'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'four'</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">}</span>
<span class="token operator">>></span><span class="token operator">></span> d2 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'eleven'</span><span class="token punctuation">:</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token string">'twelve'</span><span class="token punctuation">:</span><span class="token number">12</span><span class="token punctuation">}</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> collections <span class="token keyword">import</span> ChainMap
<span class="token operator">>></span><span class="token operator">></span> d <span class="token operator">=</span> ChainMap<span class="token punctuation">(</span>d1<span class="token punctuation">,</span>d2<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token string">'one'</span> <span class="token keyword">in</span> d
<span class="token boolean">True</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token string">'eleven'</span> <span class="token keyword">in</span> d
<span class="token boolean">True</span>
</pre><p><code>collections.Counter</code>：这个映射类型会给键准备一个整数计数器，每次更新一个键的时候就会增加这个计数器，所以这个类型可用于给可散列列表对象技术，或者是当成多重集来用——多重集就是集合中的元素可以出现不止一次：</p>
<ul>
<li>计数/多重集合 作用：</li>
</ul>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> Counter<span class="token punctuation">(</span><span class="token string">'abccabacd'</span><span class="token punctuation">)</span>
Counter<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'a'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> Counter<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
Counter<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</pre><ul>
<li><code>+</code>/<code>-</code> 运算</li>
</ul>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> c1 <span class="token operator">=</span> Counter<span class="token punctuation">(</span><span class="token string">'abbcbca'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> c2 <span class="token operator">=</span> Counter<span class="token punctuation">(</span><span class="token string">'bccdb'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> c1
Counter<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'b'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> c2
Counter<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'b'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> c1 <span class="token operator">+</span> c2
Counter<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'b'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> c1 <span class="token operator">-</span> c2
Counter<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'a'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</pre><ul>
<li><code>most_common(n)</code>计算最频繁的 n 个元素</li>
</ul>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> c <span class="token operator">=</span> Counter<span class="token punctuation">(</span><span class="token string">'aabdababbabdcddeabd'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> c
Counter<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'a'</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'e'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> c<span class="token punctuation">.</span>most_common<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> c<span class="token punctuation">.</span>most_common<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</pre><p><code>collection.UserDict</code> ：这个类单纯地将标准 dict 用纯Python又实现了一遍，跟 OrderedDict、ChainMap、Counter这些开箱机用的类型不同，UserDict是让用户继承写子类的。</p>
<h3 class="mume-header" id="%E5%AD%90%E7%B1%BB%E5%8C%96-userdict">子类化 UserDict</h3>

<p>UserDict 不是 dict 的子类，但是 UserDict 有个叫 data 的属性，是 dict 实例，这个属性实际上就是 UserDict 最终存储数据的地方。这样做的好处主要是：<code>UserDict</code> 的子类能够在实现 <code>__setitem__</code> 的时候避免不必要的递归，也可以让 <code>__contains__</code> 中的代码更加简洁。</p>
<p>因为 UserDict 继承的是 MutableMapping，所以自定义的<code>StrKeyDict</code>中剩下的那些映射方法都是从 UserDict、MutableMapping和Mapping这些超类中继承而来的。Mapping类虽然是一个抽象基类（ABC)，但它却提供了好几个实用的方法。</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">StrKeyDict0</span><span class="token punctuation">(</span>UserDict<span class="token punctuation">)</span><span class="token punctuation">:</span>                          
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">__missing__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             <span class="token keyword">raise</span> KeyError<span class="token punctuation">(</span>k<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">return</span> self<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">__setitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         self<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> item 
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">__contains__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">:</span>    
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>data
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">>></span><span class="token operator">></span> d <span class="token operator">=</span> StrKeyDict0<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span><span class="token string">'two'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">,</span><span class="token string">'four'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> d<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'three'</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token number">1</span> <span class="token keyword">in</span> d
<span class="token boolean">True</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token number">5</span> <span class="token keyword">in</span> d
<span class="token boolean">False</span>
<span class="token operator">>></span><span class="token operator">></span> d
<span class="token punctuation">{</span><span class="token string">'2'</span><span class="token punctuation">:</span> <span class="token string">'two'</span><span class="token punctuation">,</span> <span class="token string">'4'</span><span class="token punctuation">:</span> <span class="token string">'four'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">'3'</span><span class="token punctuation">:</span> <span class="token string">'three'</span><span class="token punctuation">}</span>
<span class="token comment"># 继承自 MutableMapping 的 update 方法</span>
<span class="token operator">>></span><span class="token operator">></span> d<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token string">'five'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token string">'six'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> d<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token string">'seven'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> d
<span class="token punctuation">{</span><span class="token string">'2'</span><span class="token punctuation">:</span> <span class="token string">'two'</span><span class="token punctuation">,</span> <span class="token string">'4'</span><span class="token punctuation">:</span> <span class="token string">'four'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">'3'</span><span class="token punctuation">:</span> <span class="token string">'three'</span><span class="token punctuation">,</span> <span class="token string">'5'</span><span class="token punctuation">:</span> <span class="token string">'five'</span><span class="token punctuation">,</span> <span class="token string">'6'</span><span class="token punctuation">:</span> <span class="token string">'six'</span><span class="token punctuation">,</span> <span class="token string">'7'</span><span class="token punctuation">:</span> <span class="token string">'seven'</span><span class="token punctuation">}</span>
<span class="token comment"># 继承自 Mapping 的 get 方法</span>
<span class="token operator">>></span><span class="token operator">></span> d<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token string">'N/A'</span><span class="token punctuation">)</span>
<span class="token string">'N/A'</span>
</pre><h3 class="mume-header" id="%E4%B8%8D%E5%8F%AF%E5%8F%98%E6%98%A0%E5%B0%84%E7%B1%BB%E5%9E%8B">不可变映射类型</h3>

<p>标准库中的所有映射类型都是可变的。</p>
<p>通过 <code>MappingProxyType</code> 可以变相实现只读：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token keyword">from</span> types <span class="token keyword">import</span> MappingProxyType
<span class="token operator">>></span><span class="token operator">></span> d <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string">'A'</span><span class="token punctuation">}</span>
<span class="token operator">>></span><span class="token operator">></span> d_proxy <span class="token operator">=</span> MappingProxyType<span class="token punctuation">(</span>d<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> d_proxy
mappingproxy<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">:</span> <span class="token string">'A'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> d_proxy<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token string">'A'</span>
<span class="token operator">>></span><span class="token operator">></span> d_proxy<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'x'</span>
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>
  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>
TypeError<span class="token punctuation">:</span> <span class="token string">'mappingproxy'</span> <span class="token builtin">object</span> does <span class="token operator">not</span> support item assignment
<span class="token operator">>></span><span class="token operator">></span> d_proxy<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'B'</span>
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>
  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>
TypeError<span class="token punctuation">:</span> <span class="token string">'mappingproxy'</span> <span class="token builtin">object</span> does <span class="token operator">not</span> support item assignment
<span class="token comment"># d_proxy 是动态的，对 d 所做的任何改动都会反馈到 d_proxy 上</span>
<span class="token operator">>></span><span class="token operator">></span> d<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'B'</span>
<span class="token operator">>></span><span class="token operator">></span> d_proxy
mappingproxy<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">:</span> <span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span> <span class="token string">'B'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> d_proxy<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
<span class="token string">'B'</span>
</pre><h3 class="mume-header" id="%E9%9B%86%E5%90%88%E8%AE%BA">集合论</h3>

<p>集合的本质是许多唯一对象的聚集，因此，集合可以用于去重：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> l <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'spam'</span><span class="token punctuation">,</span><span class="token string">'spam'</span><span class="token punctuation">,</span><span class="token string">'eggs'</span><span class="token punctuation">,</span><span class="token string">'spam'</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">set</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span>
<span class="token punctuation">{</span><span class="token string">'spam'</span><span class="token punctuation">,</span> <span class="token string">'eggs'</span><span class="token punctuation">}</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token string">'spam'</span><span class="token punctuation">,</span> <span class="token string">'eggs'</span><span class="token punctuation">]</span>
</pre><p>set 和它不可变的姐妹类型 frozenset 直到 Python2.3 才首次以模块的形式出现，在 Python2.7 中它们升级为built-in类型。</p>
<p>集合中的元素必须是可散列的，set 类型本身是不可散列的，但是 fronzeset 可以。因此可以创建一个包含不同 frozenset 的 set。</p>
<p>集合的运算：a | b (a和b的并集)，a &amp; b (a和b的交集)，a - b (a和b的差集)，a ^ b (a和b的对称差)。</p>
<p>代码 <code>{1,2,3}</code> 这种字面量句法相比于构造方法<code>set([1,2,3])</code>要更快且更易读：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> dis <span class="token keyword">import</span> dis
<span class="token operator">>></span><span class="token operator">></span> dis<span class="token punctuation">(</span><span class="token string">'{1}'</span><span class="token punctuation">)</span>
  <span class="token number">1</span>           <span class="token number">0</span> LOAD_CONST               <span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
              <span class="token number">2</span> BUILD_SET                <span class="token number">1</span>
              <span class="token number">4</span> RETURN_VALUE
<span class="token operator">>></span><span class="token operator">></span> dis<span class="token punctuation">(</span><span class="token string">'set([1])'</span><span class="token punctuation">)</span>
  <span class="token number">1</span>           <span class="token number">0</span> LOAD_NAME                <span class="token number">0</span> <span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">)</span>
              <span class="token number">2</span> LOAD_CONST               <span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
              <span class="token number">4</span> BUILD_LIST               <span class="token number">1</span>
              <span class="token number">6</span> CALL_FUNCTION            <span class="token number">1</span>
              <span class="token number">8</span> RETURN_VALUE
</pre><p>由于 Python 中没有针对 frozenset 的特殊字面量句法，我们智能常用构造方法：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">frozenset</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token builtin">frozenset</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</pre><h4 class="mume-header" id="%E9%9B%86%E5%90%88%E6%8E%A8%E5%AF%BC">集合推导</h4>

<p>Python2.7 带来了集合推导（set comprehensions）和之前的字典推导。新建一个Latin-1 字符集合，该集合中的每个字符的 Unicode 名字里都有 'SIGN' 这个单词：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token builtin">chr</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token string">'SIGN'</span> <span class="token keyword">in</span> name<span class="token punctuation">(</span><span class="token builtin">chr</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token string">'±'</span><span class="token punctuation">,</span> <span class="token string">'$'</span><span class="token punctuation">,</span> <span class="token string">'§'</span><span class="token punctuation">,</span> <span class="token string">'¢'</span><span class="token punctuation">,</span> <span class="token string">'°'</span><span class="token punctuation">,</span> <span class="token string">'¬'</span><span class="token punctuation">,</span> <span class="token string">'£'</span><span class="token punctuation">,</span> <span class="token string">'>'</span><span class="token punctuation">,</span> <span class="token string">'×'</span><span class="token punctuation">,</span> <span class="token string">'÷'</span><span class="token punctuation">,</span> <span class="token string">'%'</span><span class="token punctuation">,</span> 
<span class="token string">'+'</span><span class="token punctuation">,</span> <span class="token string">'¥'</span><span class="token punctuation">,</span> <span class="token string">'¶'</span><span class="token punctuation">,</span> <span class="token string">'µ'</span><span class="token punctuation">,</span> <span class="token string">'#'</span><span class="token punctuation">,</span> <span class="token string">'&lt;'</span><span class="token punctuation">,</span> <span class="token string">'¤'</span><span class="token punctuation">,</span> <span class="token string">'®'</span><span class="token punctuation">,</span> <span class="token string">'='</span><span class="token punctuation">,</span> <span class="token string">'©'</span><span class="token punctuation">}</span>
</pre><p>备注：可以使用 <code>in</code> 判断某个字符串是否有某种类型的子字符串，而不用正则表达式：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> <span class="token string">"apple banana"</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token string">'na'</span> <span class="token keyword">in</span> s
<span class="token boolean">True</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token string">'aa'</span> <span class="token keyword">in</span> s
<span class="token boolean">False</span>
</pre><h4 class="mume-header" id="%E9%9B%86%E5%90%88%E7%9A%84%E6%93%8D%E4%BD%9C">集合的操作</h4>

<p><?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="330px" preserveAspectRatio="none" style="width:427px;height:330px;" version="1.1" viewBox="0 0 427 330" width="427px" zoomAndPan="magnify"><defs><filter height="300%" id="faj1nddp8ghtp" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"></feGaussianBlur><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"></feColorMatrix><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"></feOffset><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"></feBlend></filter></defs><g><!--class Container--><rect fill="#FEFECE" filter="url(#faj1nddp8ghtp)" height="60.9551" id="Container" style="stroke: #A80036; stroke-width: 1.5;" width="88" x="207" y="8"></rect><ellipse cx="222.45" cy="24" fill="#ADD1B2" rx="11" ry="11" style="stroke: #A80036; stroke-width: 1.0;"></ellipse><path d="M225.4231,29.6431 Q224.8421,29.9419 224.2029,30.0913 Q223.5638,30.2407 222.8582,30.2407 Q220.3514,30.2407 219.0315,28.5889 Q217.7117,26.937 217.7117,23.8159 Q217.7117,20.6865 219.0315,19.0347 Q220.3514,17.3828 222.8582,17.3828 Q223.5638,17.3828 224.2112,17.5322 Q224.8587,17.6816 225.4231,17.9805 L225.4231,20.7031 Q224.7923,20.1221 224.1988,19.8523 Q223.6053,19.5825 222.9744,19.5825 Q221.6297,19.5825 220.9449,20.6492 Q220.2601,21.7158 220.2601,23.8159 Q220.2601,25.9077 220.9449,26.9744 Q221.6297,28.041 222.9744,28.041 Q223.6053,28.041 224.1988,27.7712 Q224.7923,27.5015 225.4231,26.9204 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="55" x="236.55" y="28.5352">Container</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="208" x2="294" y1="40" y2="40"></line><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="76" x="213" y="54.6348">‘__contains__’</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="208" x2="294" y1="60.9551" y2="60.9551"></line><!--class Set--><rect fill="#FEFECE" filter="url(#faj1nddp8ghtp)" height="190.5059" id="Set" style="stroke: #A80036; stroke-width: 1.5;" width="70" x="216" y="129"></rect><ellipse cx="240.45" cy="145" fill="#ADD1B2" rx="11" ry="11" style="stroke: #A80036; stroke-width: 1.0;"></ellipse><path d="M243.4231,150.6431 Q242.8421,150.9419 242.2029,151.0913 Q241.5638,151.2407 240.8582,151.2407 Q238.3514,151.2407 237.0315,149.5889 Q235.7117,147.937 235.7117,144.8159 Q235.7117,141.6865 237.0315,140.0347 Q238.3514,138.3828 240.8582,138.3828 Q241.5638,138.3828 242.2112,138.5322 Q242.8587,138.6816 243.4231,138.9805 L243.4231,141.7031 Q242.7923,141.1221 242.1988,140.8523 Q241.6053,140.5825 240.9744,140.5825 Q239.6297,140.5825 238.9449,141.6492 Q238.2601,142.7158 238.2601,144.8159 Q238.2601,146.9077 238.9449,147.9744 Q239.6297,149.041 240.9744,149.041 Q241.6053,149.041 242.1988,148.7712 Q242.7923,148.5015 243.4231,147.9204 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="17" x="256.55" y="149.5352">Set</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="217" x2="285" y1="161" y2="161"></line><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="49" x="222" y="175.6348">isdisjoint</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="47" x="222" y="188.5898">`__le__`</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="45" x="222" y="201.5449">`__lt__`</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="51" x="222" y="214.5">`__ge__`</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="49" x="222" y="227.4551">`__gt__`</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="51" x="222" y="240.4102">`__eq__`</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="51" x="222" y="253.3652">`__ne__`</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="58" x="222" y="266.3203">`__and__`</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="50" x="222" y="279.2754">`__or__`</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="58" x="222" y="292.2305">`__sub__`</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="57" x="222" y="305.1855">`__xor__`</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="217" x2="285" y1="311.5059" y2="311.5059"></line><!--class Iterable--><rect fill="#FEFECE" filter="url(#faj1nddp8ghtp)" height="60.9551" id="Iterable" style="stroke: #A80036; stroke-width: 1.5;" width="76" x="6" y="194"></rect><ellipse cx="21" cy="210" fill="#ADD1B2" rx="11" ry="11" style="stroke: #A80036; stroke-width: 1.0;"></ellipse><path d="M23.9731,215.6431 Q23.3921,215.9419 22.7529,216.0913 Q22.1138,216.2407 21.4082,216.2407 Q18.9014,216.2407 17.5815,214.5889 Q16.2617,212.937 16.2617,209.8159 Q16.2617,206.6865 17.5815,205.0347 Q18.9014,203.3828 21.4082,203.3828 Q22.1138,203.3828 22.7612,203.5322 Q23.4087,203.6816 23.9731,203.9805 L23.9731,206.7031 Q23.3423,206.1221 22.7488,205.8523 Q22.1553,205.5825 21.5244,205.5825 Q20.1797,205.5825 19.4949,206.6492 Q18.8101,207.7158 18.8101,209.8159 Q18.8101,211.9077 19.4949,212.9744 Q20.1797,214.041 21.5244,214.041 Q22.1553,214.041 22.7488,213.7712 Q23.3423,213.5015 23.9731,212.9204 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="44" x="35" y="214.5352">Iterable</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="7" x2="81" y1="226" y2="226"></line><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="48" x="12" y="240.6348">'__iter__'</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="7" x2="81" y1="246.9551" y2="246.9551"></line><!--class Sized--><rect fill="#FEFECE" filter="url(#faj1nddp8ghtp)" height="60.9551" id="Sized" style="stroke: #A80036; stroke-width: 1.5;" width="63" x="117.5" y="194"></rect><ellipse cx="132.5" cy="210" fill="#ADD1B2" rx="11" ry="11" style="stroke: #A80036; stroke-width: 1.0;"></ellipse><path d="M135.4731,215.6431 Q134.8921,215.9419 134.2529,216.0913 Q133.6138,216.2407 132.9082,216.2407 Q130.4014,216.2407 129.0815,214.5889 Q127.7617,212.937 127.7617,209.8159 Q127.7617,206.6865 129.0815,205.0347 Q130.4014,203.3828 132.9082,203.3828 Q133.6138,203.3828 134.2612,203.5322 Q134.9087,203.6816 135.4731,203.9805 L135.4731,206.7031 Q134.8423,206.1221 134.2488,205.8523 Q133.6553,205.5825 133.0244,205.5825 Q131.6797,205.5825 130.9949,206.6492 Q130.3101,207.7158 130.3101,209.8159 Q130.3101,211.9077 130.9949,212.9744 Q131.6797,214.041 133.0244,214.041 Q133.6553,214.041 134.2488,213.7712 Q134.8423,213.5015 135.4731,212.9204 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="31" x="146.5" y="214.5352">Sized</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="118.5" x2="179.5" y1="226" y2="226"></line><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="46" x="123.5" y="240.6348">'__len__'</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="118.5" x2="179.5" y1="246.9551" y2="246.9551"></line><!--class MutableSet--><rect fill="#FEFECE" filter="url(#faj1nddp8ghtp)" height="164.5957" id="MutableSet" style="stroke: #A80036; stroke-width: 1.5;" width="95" x="321.5" y="142"></rect><ellipse cx="336.5" cy="158" fill="#ADD1B2" rx="11" ry="11" style="stroke: #A80036; stroke-width: 1.0;"></ellipse><path d="M339.4731,163.6431 Q338.8921,163.9419 338.2529,164.0913 Q337.6138,164.2407 336.9082,164.2407 Q334.4014,164.2407 333.0815,162.5889 Q331.7617,160.937 331.7617,157.8159 Q331.7617,154.6865 333.0815,153.0347 Q334.4014,151.3828 336.9082,151.3828 Q337.6138,151.3828 338.2612,151.5322 Q338.9087,151.6816 339.4731,151.9805 L339.4731,154.7031 Q338.8423,154.1221 338.2488,153.8523 Q337.6553,153.5825 337.0244,153.5825 Q335.6797,153.5825 334.9949,154.6492 Q334.3101,155.7158 334.3101,157.8159 Q334.3101,159.9077 334.9949,160.9744 Q335.6797,162.041 337.0244,162.041 Q337.6553,162.041 338.2488,161.7712 Q338.8423,161.5015 339.4731,160.9204 Z "></path><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacingAndGlyphs" textLength="63" x="350.5" y="162.5352">MutableSet</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="322.5" x2="415.5" y1="174" y2="174"></line><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="20" x="327.5" y="188.6348">add</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="40" x="327.5" y="201.5898">discard</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="40" x="327.5" y="214.5449">remove</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="21" x="327.5" y="227.5">pop</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="26" x="327.5" y="240.4551">clear</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="53" x="327.5" y="253.4102">`__ior__`</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="61" x="327.5" y="266.3652">`__iand__`</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="60" x="327.5" y="279.3203">`__ixor__`</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacingAndGlyphs" textLength="61" x="327.5" y="292.2754">`__isub__`</text><line style="stroke: #A80036; stroke-width: 1.5;" x1="322.5" x2="415.5" y1="298.5957" y2="298.5957"></line><!--link Container to Set--><path d="M251,89.5867 C251,101.7688 251,115.1641 251,128.6396 " fill="none" id="Container-Set" style="stroke: #A80036; stroke-width: 1.0;"></path><polygon fill="none" points="244.0001,89.2142,251,69.2141,258.0001,89.2141,244.0001,89.2142" style="stroke: #A80036; stroke-width: 1.0;"></polygon><!--link Iterable to Set--><path d="M59.3091,174.7997 C70.6403,147.2123 89.1197,115.2682 117.5,99 C141.792,85.0753 156.22,85.0543 180.5,99 C194.9108,107.2772 206.592,119.7226 215.9893,133.6122 " fill="none" id="Iterable-Set" style="stroke: #A80036; stroke-width: 1.0;"></path><polygon fill="none" points="65.7764,177.4937,52.2823,193.8311,52.643,172.6446,65.7764,177.4937" style="stroke: #A80036; stroke-width: 1.0;"></polygon><!--link Sized to Set--><path d="M201.1455,224.5 C206.0762,224.5 211.0068,224.5 215.9375,224.5 " fill="none" id="Sized-Set" style="stroke: #A80036; stroke-width: 1.0;"></path><polygon fill="none" points="200.875,231.4999,180.875,224.5,200.875,217.4999,200.875,231.4999" style="stroke: #A80036; stroke-width: 1.0;"></polygon><!--link Set to MutableSet--><path d="M306.1784,224.5 C311.2382,224.5 316.298,224.5 321.3578,224.5 " fill="none" id="Set-MutableSet" style="stroke: #A80036; stroke-width: 1.0;"></path><polygon fill="none" points="306.0313,231.4999,286.0313,224.5,306.0312,217.4999,306.0313,231.4999" style="stroke: #A80036; stroke-width: 1.0;"></polygon><!--
@startuml
Container <|- - Set
Iterable <|- Set
Sized <|- Set
Set <|- MutableSet
Container : ‘__contains__’
Iterable : '__iter__'
Sized : '__len__'
Set : isdisjoint
Set : `__le__`
Set : `__lt__`
Set : `__ge__`
Set : `__gt__`
Set : `__eq__`
Set : `__ne__`
Set : `__and__`
Set : `__or__`
Set : `__sub__`
Set : `__xor__`
MutableSet : add
MutableSet : discard
MutableSet : remove
MutableSet : pop
MutableSet : clear
MutableSet : `__ior__`
MutableSet : `__iand__`
MutableSet : `__ixor__`
MutableSet : `__isub__`
@enduml

PlantUML version 1.2018.01(Mon Jan 29 02:08:22 CST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 9.0.4+11
Operating System: Mac OS X
OS Version: 10.13.4
Default Encoding: US-ASCII
Language: zh
Country: CN
--></g></svg></p><p>相求4个聚合类型 a、b、c、d的并集，可以用 <code>a.union(b,c,d)</code>，其中 a 必须是 set，b、c、d可以是如何类型的可迭代对象：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     m <span class="token operator">=</span> <span class="token number">0</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">while</span> m <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">yield</span> m
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         m <span class="token operator">+=</span> <span class="token number">1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">5</span><span class="token punctuation">}</span>
<span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> f<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> c <span class="token operator">=</span> <span class="token string">'xyz'</span>
<span class="token operator">>></span><span class="token operator">></span> d <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token string">'w'</span><span class="token punctuation">}</span>
<span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">.</span>union<span class="token punctuation">(</span>b<span class="token punctuation">,</span>c<span class="token punctuation">,</span>d<span class="token punctuation">)</span>
<span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token string">'z'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">}</span>
</pre><p>下面，我们会继续讨论字典和集合类型背后的实现。</p>
<h3 class="mume-header" id="dict-%E5%92%8C-set-%E7%9A%84%E8%83%8C%E5%90%8E">dict 和 set 的背后</h3>

<p>5 个问题：</p>
<ol>
<li>Python 中的 dict 和 set 的效率有多高？</li>
<li>为什么它们是无序的？</li>
<li>为什么不是所有的Python对象都可以当做 dict 的键或者 set 里的元素？</li>
<li>为什么 dict 的键和 set 元素的顺序是根据它们被添加的次序而定的？为什么映射对象的生命周期中，这个顺序并不是一成不变的？</li>
<li>为什么不应该在迭代循环 dict 或 set 的同时往里面添加元素？</li>
</ol>
<h4 class="mume-header" id="%E4%B8%80%E4%B8%AA%E5%85%B3%E4%BA%8E%E6%95%88%E7%8E%87%E7%9A%84%E5%AE%9E%E9%AA%8C">一个关于效率的实验</h4>

<p>所有的 Python 程序员都从经验中得出结论，认为字典和集合的速度是非常快的。接下来我们要通过可控的实验来验证这一点。</p>
<p>为了对比容器的大小对 dict、set 或 list 的 in 元素运算符效率的影响，先创建一个有 1000万个双精度浮点数的数组，名叫 haystack。另外还有一个包含 1000 个浮点数的 needles 数组。 从其中 500 个数字是从 haystack 中跳出的，另外500个肯定不在 haystack 中。</p>
<p>作为 dict 测试的基准，用 dict.fromkeys() 来建立一个含有 1000 个浮点数的名叫 haystack 的字典，并用 timeit 模块测试：<br>
实验设备：Python 3.6，MacBook Pro 13， Core i5</p>
<table>
<thead>
<tr>
<th>haystack<br>长度</th>
<th>增长<br>系数</th>
<th>dict</th>
<th>增长<br>系数</th>
<th>集合</th>
<th>增长<br>系数</th>
<th>集合<br>交集</th>
<th>增长<br>系数</th>
<th>队列</th>
<th>增长<br>系数</th>
</tr>
</thead>
<tbody>
<tr>
<td>1000</td>
<td>1×</td>
<td>70.5 μs</td>
<td>1.0x</td>
<td>74.9 µs</td>
<td>1.0x</td>
<td>19.6 μs</td>
<td>1.0x</td>
<td>6.54 ms</td>
<td>1.0x</td>
</tr>
<tr>
<td>10000</td>
<td>10×</td>
<td>84.6 μs</td>
<td>1.2x</td>
<td>80.5 µs</td>
<td>1.08x</td>
<td>25.1 µs</td>
<td>1.28x</td>
<td>68.7 ms</td>
<td>10.5x</td>
</tr>
<tr>
<td>100000</td>
<td>100×</td>
<td>91.5 μs</td>
<td>1.3x</td>
<td>83.3 µs</td>
<td>1.15x</td>
<td>28.4 µs</td>
<td>1.45x</td>
<td>882 ms</td>
<td>134x</td>
</tr>
<tr>
<td>1000000</td>
<td>1000×</td>
<td>114 μs</td>
<td>1.62x</td>
<td>91.7 µs</td>
<td>1.22x</td>
<td>32.1 µs</td>
<td>1.64x</td>
<td>31.2 s</td>
<td>4771x</td>
</tr>
<tr>
<td>10000000</td>
<td>10000×</td>
<td>139 μs</td>
<td>1.97x</td>
<td>98.9 µs</td>
<td>1.32x</td>
<td>37.5 µs</td>
<td>1.91x</td>
<td>517s</td>
<td>79051x</td>
</tr>
</tbody>
</table>
<p>下面让我们看看字典和集合如此快的原因：对散列表内部结构的讨论。</p>
<h4 class="mume-header" id="%E5%AD%97%E5%85%B8%E4%B8%AD%E7%9A%84%E6%95%A3%E5%88%97%E8%A1%A8">字典中的散列表</h4>

<p>散列表其实是一个稀疏数组（总是有空白元素的数组称为稀疏数组）。在一部的数据结构教材中，散列表中的单元通常称为表元(bucket)。在dict散列表中，每个键值对都占用一个表元，每个表元有两个部分，一个是对键的引用。因为所有表元的大小一致，所以可以通过偏移量来读取某个表元。</p>
<p>因为 Python 会设法保证大概还有三分之一的表元是空的，所以在快到达这个阈值的时候，原有的散列表会被复制到一个更大的空间里面。</p>
<p>要把一个对象放入到散列表中，首先要计算这个元素的散列值。Python 中可以用 hash() 方法来做这件事情。</p>
<p><strong>01. 散列值和相等性</strong><br>
内置的 <code>hash()</code> 方法可以用于所有的内置类型对象。如果自定义对象调用<code>hash()</code> 的话，实际上运行的是自定义的 <code>__hash__</code> 。如果两个对象在比较的时候是相等的，那它们的散列值必须相等，否则散列表就不能正常运行了。例如，如果1==1.0为True，那么hash(1)==hash(1.0)也必须为True。</p>
<p><strong>注意：hash函数并不是单射，即一个值有对应的一个的哈希值，但一个哈希值可能有多个值与之对应，这就产生了冲突。</strong></p>
<p><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: G Pages: 1 -->
<svg width="184pt" height="98pt" viewBox="0.00 0.00 184.42 98.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 94)">
<title>G</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-94 180.4172,-94 180.4172,4 -4,4"></polygon>
<!-- A -->
<g id="node1" class="node">
<title>A</title>
<ellipse fill="none" stroke="#000000" cx="43.2086" cy="-72" rx="43.4183" ry="18"></ellipse>
<text text-anchor="middle" x="43.2086" y="-67.8" font-family="Times,serif" font-size="14.00" fill="#000000">hash(&#45;1)</text>
</g>
<!-- C -->
<g id="node3" class="node">
<title>C</title>
<ellipse fill="none" stroke="#000000" cx="149.4172" cy="-45" rx="27" ry="18"></ellipse>
<text text-anchor="middle" x="149.4172" y="-40.8" font-family="Times,serif" font-size="14.00" fill="#000000">&#45;2</text>
</g>
<!-- A&#45;&gt;C -->
<g id="edge1" class="edge">
<title>A&#45;&gt;C</title>
<path fill="none" stroke="#000000" d="M80.3552,-62.5567C91.3255,-59.7679 103.2975,-56.7244 114.146,-53.9665"></path>
<polygon fill="#000000" stroke="#000000" points="115.3042,-57.2835 124.1336,-51.4275 113.5795,-50.4993 115.3042,-57.2835"></polygon>
</g>
<!-- B -->
<g id="node2" class="node">
<title>B</title>
<ellipse fill="none" stroke="#000000" cx="43.2086" cy="-18" rx="43.4183" ry="18"></ellipse>
<text text-anchor="middle" x="43.2086" y="-13.8" font-family="Times,serif" font-size="14.00" fill="#000000">hash(&#45;2)</text>
</g>
<!-- B&#45;&gt;C -->
<g id="edge2" class="edge">
<title>B&#45;&gt;C</title>
<path fill="none" stroke="#000000" d="M80.3552,-27.4433C91.3255,-30.2321 103.2975,-33.2756 114.146,-36.0335"></path>
<polygon fill="#000000" stroke="#000000" points="113.5795,-39.5007 124.1336,-38.5725 115.3042,-32.7165 113.5795,-39.5007"></polygon>
</g>
</g>
</svg>
</p><p>为了让散列值能够胜任散列表索引这一角色，它们必须在索引空间中尽量分散开来。这意味着在最理想的状况下，越是相似但不相等的对象，它们的散列值得差别应该越大。</p>
<div class="code-chunk" data-id="code-chunk-id-11" data-cmd="python"><div class="input-div"><pre data-role="codeBlock" data-info="python {code_chunk_offset=11, cmd}" class="language-python"><span class="token keyword">import</span> sys
MAX_BITS <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">format</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>maxsize<span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s-bit Python build'</span> <span class="token operator">%</span><span class="token punctuation">(</span>MAX_BITS<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">hash_diff</span><span class="token punctuation">(</span>o1<span class="token punctuation">,</span> o2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    h1 <span class="token operator">=</span> f<span class="token string">'{hash(o1):>0{MAX_BITS}b}'</span>
    h2 <span class="token operator">=</span> f<span class="token string">'{hash(o2):>0{MAX_BITS}b}'</span>
    diff <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">'!'</span> <span class="token keyword">if</span> b1<span class="token operator">!=</span>b2 <span class="token keyword">else</span> <span class="token string">' '</span> <span class="token keyword">for</span> b1<span class="token punctuation">,</span>b2 <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>h1<span class="token punctuation">,</span>h2<span class="token punctuation">)</span><span class="token punctuation">)</span>
    count <span class="token operator">=</span> f<span class="token string">'! = {diff.count("!")}'</span>
    width <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">repr</span><span class="token punctuation">(</span>o1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">repr</span><span class="token punctuation">(</span>o2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span>
    sep <span class="token operator">=</span> <span class="token string">'-'</span> <span class="token operator">*</span> <span class="token punctuation">(</span>width <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> MAX_BITS<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>f<span class="token string">'{o1:&lt;{width}}{h1}\n'</span>
    f<span class="token string">'{"":{width}}{diff} {count}\n'</span> 
    f<span class="token string">'{o2:&lt;{width}}{h2}\n{sep}'</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>hash_diff<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>hash_diff<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0001</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>hash_diff<span class="token punctuation">(</span><span class="token number">1.0001</span><span class="token punctuation">,</span> <span class="token number">1.0002</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>hash_diff<span class="token punctuation">(</span><span class="token number">1.0002</span><span class="token punctuation">,</span> <span class="token number">1.0003</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    
</pre><div class="btn-group"><div class="run-btn btn"><span>▶︎</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"></div></div><p>从 Python3.3 开始，str、bytes、datetime 对象的散列值计算过程中多了随机的“加盐”的过程。所以，加盐值是Python进程内的一个常量，但是每次启动Python解释器都会生成一个不同的盐值。随机盐值是为了防止 DOS 攻击而采取的一种安全策略。</p>
<p><strong>02. 散列表算法</strong></p>
<p>为了获取 <code>my_dict[search_key]</code> 背后的值，Python 首先会调用 hash(search_key) 来计算 search_key 的散列值，把这个值最低的几位数字作为偏移量，在散列表中查找表元（具体取几位，得看当前散列表的大小）。若找到的表元是空的，则抛出 KeyError 异常。若不是空的，则表元里会有一对 found_key:found_value。这时候 Python 会检验 search_key==found_key 是否为真，如果它们相等的话，就会返回 found_value。</p>
<p>如果 search_key 和 found_key 不匹配的话，这种情况称为散列冲突。发生这种情况是因为散列表所做的其实是把随机地元素映射到只有几位的数字上，而散列表本身的索引又只依赖于这个数字的一部分。</p>
<h4 class="mume-header" id="dict-%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8F%8A%E5%85%B6%E5%AF%BC%E8%87%B4%E7%9A%84%E7%BB%93%E6%9E%9C">dict 的实现及其导致的结果</h4>

<p>使用散列表给 dict 带来的优势和限制有哪些：</p>
<ul>
<li>键必须是可散列的
<ul>
<li>支持 hash() 函数，并通过 <code>__hash__()</code> 方法所得到的散列值是不变的；</li>
<li>支持通过 <code>__eq__()</code> 方法检测相等性；</li>
<li>如果 a==b 为 True，那么 hash(a)==hash(b) 必定为 True；</li>
</ul>
</li>
</ul>
<blockquote>
<p>如果你实现了一个类的 <code>__eq__</code> 方法，并且希望它是可散列的，那么一定要有一个恰当的 <code>__hash__</code> 方法，保证在 a==b 为真的情况下，hash(a)==hash(b) 也必定为真，否则就会破坏核定的散列表算法，导致由这些对象所组成的字典和集合完全失去可靠性，这个后果是非常可怕的。另一方面，如果一个含有自定义的 <code>__eq__</code> 依赖的类处于可变的状态，那就不要再这个类中实现 <code>__hash__</code> 方法。</p>
</blockquote>
<ul>
<li>字典在内存上的开销较大</li>
</ul>
<p>由于字典使用了散列表，而散列表又必须是<strong>稀疏的</strong>，这导致了它在空间上的效率低下。举例而言，如果你需要存放数量巨大的记录，那么放在元组或是具名元组构成的列表中会使比较好的选择；最好不要根据 JSON 的风格，用由字典组成的列表用来存放这些记录。</p>
<blockquote>
<p>记住我们现在讨论的是空间优化，如果你手头有几百万个对象，而你的机器有几个GB的内存，那么空间的优化工作可以等到真正需要的时候在开始计划，因为优化往往是可维护性的对立面。</p>
</blockquote>
<ul>
<li>
<p>键查询很快：dict 的实现是典型的空间换时间：字典类型有较大的内存开销，但它们提供了无视数量大小的快速访问——只要字典能被装在内存里。</p>
</li>
<li>
<p>键的次序取决于添加顺序</p>
</li>
</ul>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> DIAL_CODES <span class="token operator">=</span> <span class="token punctuation">[</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">(</span><span class="token number">86</span><span class="token punctuation">,</span><span class="token string">'China'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">(</span><span class="token number">91</span><span class="token punctuation">,</span><span class="token string">'India'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">(</span><span class="token number">62</span><span class="token punctuation">,</span><span class="token string">'Indonesia'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'United States'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">(</span><span class="token number">55</span><span class="token punctuation">,</span> <span class="token string">'Brazil'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">(</span><span class="token number">92</span><span class="token punctuation">,</span> <span class="token string">'Pakistan'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">(</span><span class="token number">880</span><span class="token punctuation">,</span> <span class="token string">'Bangladesh'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">(</span><span class="token number">234</span><span class="token punctuation">,</span> <span class="token string">'Nigeria'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">'Russia'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">(</span><span class="token number">81</span><span class="token punctuation">,</span> <span class="token string">'Japan'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> d1 <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>DIAL_CODES<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'d1:'</span><span class="token punctuation">,</span>d1<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
d1<span class="token punctuation">:</span> dict_keys<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">86</span><span class="token punctuation">,</span> <span class="token number">91</span><span class="token punctuation">,</span> <span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">92</span><span class="token punctuation">,</span> <span class="token number">880</span><span class="token punctuation">,</span> <span class="token number">234</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> d2 <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">sorted</span><span class="token punctuation">(</span>DIAL_CODES<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'d2:'</span><span class="token punctuation">,</span> d2<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
d2<span class="token punctuation">:</span> dict_keys<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">,</span> <span class="token number">86</span><span class="token punctuation">,</span> <span class="token number">91</span><span class="token punctuation">,</span> <span class="token number">92</span><span class="token punctuation">,</span> <span class="token number">234</span><span class="token punctuation">,</span> <span class="token number">880</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> d3 <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">sorted</span><span class="token punctuation">(</span>DIAL_CODES<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'d3:'</span><span class="token punctuation">,</span> d3<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
d3<span class="token punctuation">:</span> dict_keys<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">880</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">86</span><span class="token punctuation">,</span> <span class="token number">91</span><span class="token punctuation">,</span> <span class="token number">62</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">,</span> <span class="token number">234</span><span class="token punctuation">,</span> <span class="token number">92</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> d1<span class="token operator">==</span>d2<span class="token operator">==</span>d3
<span class="token boolean">True</span>
</pre><p>不要对字典同时进行迭代和修改，如果想扫描并修改一个字典，最好分成两步来进行：首先对字典迭代，以得出需要添加的内容，吧这些内容放在一个字典中，迭代结束后对原有字典进行更新。</p>
<blockquote>
<p>在 Python3 中，keys()、items()、values() 方法返回的都是字典的视图，即这些方法返回的值更像集合，而不是像 Python2 那样返回列表。</p>
</blockquote>
<h3 class="mume-header" id="set-%E7%9A%84%E5%AE%9E%E7%8E%B0%E9%9B%86%E5%AF%BC%E8%87%B4%E7%9A%84%E7%BB%93%E6%9E%9C">set 的实现集导致的结果</h3>

<p>set 和 frozenset 的实现也依赖于散列表，但是它们的散列表中只存有元素的引用（相当于字典中只存放键而没有相应的值）。</p>
<p><strong>在 set 加入到 Python 之前，我们都是把字典加上无意义的值当做集合来用的。</strong></p>
<ul>
<li>集合中的元素必须是可散列的</li>
<li>集合很消耗内存</li>
<li>可以很高效地判断元素是否存在于某个集合中</li>
<li>元数的次序取决于被添加到集合中的次序</li>
<li>往集合中添加元素可能会改变集合中已有元素的次序</li>
</ul>
<p>JSON 被当做 “瘦身版XML”，在很多情境下，JSON都成功取代了XML，由于用于紧凑的列表和字典表达式，JSON格式可以完美地用于数据交换。</p>
<h2 class="mume-header" id="%E6%96%87%E6%9C%AC%E5%92%8C%E5%AD%97%E8%8A%82%E5%BA%8F%E5%88%97">文本和字节序列</h2>

<blockquote>
<p>人类使用文本，计算机使用字节序列。——Esther Nam and Travis Fischer</p>
</blockquote>
<p>Python 3 明确区分了人类可读的文本字符串和原始的字节序列，隐式地吧字节序列转换成Unicode文本已成为过去。</p>
<h3 class="mume-header" id="%E5%AD%97%E7%AC%A6%E9%97%AE%E9%A2%98">字符问题</h3>

<p>“字符串” 是一个相当简单的概念：一个字符串就是一个字符序列，问题出在对“字符”的定义上。</p>
<p>在 2015 年，字符的最佳定义是 Unicode 字符。</p>
<p>Unicode 标准把字符的标识和具体的字节表述进行了如下的明确区分：</p>
<ul>
<li>字符的标识：即码位，是 0~1114111 的数字，在Unicode 标准中以 4~6 个十六进制数字表示。</li>
<li>字符的具体表述取决于所用编码，编码时码位和字节序列之间的转换是使用的算法。在 UTF-9 编码中，A(U+0041)的码位编码成单个字节 \x41，而在 UTF-16LE编码中编码成两个字节 \x41\0x00。再比如，欧元符号(U+20AC)在UTF-8中编码是3个字节：\xe2\x82\xac，而在UTF-16LE中编码成两个字节：\xac\x20。</li>
</ul>
<p>把码位转换成字节序列的过程称为编码，把字节序列变为码位的过程是解码。</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> <span class="token string">'café'</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token number">4</span>
<span class="token comment"># 编码过程：码位 -> 字节序列</span>
<span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> s<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> b
b<span class="token string">'caf\xc3\xa9'</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
<span class="token number">5</span>
<span class="token comment"># 解码过程：字节序列 -> 码位</span>
<span class="token operator">>></span><span class="token operator">></span> b<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
<span class="token string">'café'</span>
</pre><blockquote>
<p>如果想帮助自己记住 <code>.encode</code> 和 <code>.decode</code>，可以把字节序列变为晦涩难懂的机器磁芯转储，把 Unicode 字符串想成“人类可读”的文本，那么把字节序列变成人类可读的文本字符串就是解码，而把字符串变成用于存储或传输的字节序列就是编码。</p>
</blockquote>
<p>虽然 Python3 的 str 类型基本上相当于 Python2 的unicode类型，只不过换了一个新的名字，但是 Python3 的 bytes 类型却不是把 str 类型换个名称那么简单，而且还有关系紧密的 bytearray 类型。因此，在讨论编码和解码的问题之前，有必要先来介绍一下二进制序列类型。</p>
<h3 class="mume-header" id="%E5%AD%97%E8%8A%82%E6%A6%82%E8%A6%81">字节概要</h3>

<p>bytes 和 bytearray 对象的各个元素是介于 0~255 之间的整数，而不是像 Python2 的 str 对象那样是单个的字符。然而，二进制序列的切片始终是同一类型的二进制序列，包括长度为1的切片：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> cafe <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token string">'café'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> cafe
b<span class="token string">'caf\xc3\xa9'</span>
<span class="token operator">>></span><span class="token operator">></span> cafe<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token number">99</span>
<span class="token operator">>></span><span class="token operator">></span> cafe<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">]</span>
b<span class="token string">'c'</span>
<span class="token operator">>></span><span class="token operator">></span> cafe_arr <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span>cafe<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> cafe_arr
<span class="token builtin">bytearray</span><span class="token punctuation">(</span>b<span class="token string">'caf\xc3\xa9'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> cafe_arr<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
<span class="token builtin">bytearray</span><span class="token punctuation">(</span>b<span class="token string">'\xa9'</span>
</pre><p>虽然二进制序列其实是整数序列，但是它们的字面量表示法表明其中有 ASCII 文本，因此，各个字节的值可能会使用下列3种不同的方式显示：</p>
<ul>
<li>可打印的 ASCII 范围内的直接(从空格到~)：使用ASCII字符本身</li>
<li>制表符、换行符、回车符和\对应的字节：使用转义序列\t、\n、\r、\\。</li>
<li>其他字节的值：使用十六进制转义序列（例如，\x00 是空字节）</li>
</ul>
<p>除了格式化方法（format、format_map）和几个处理 Unicode 数据的方法(如casefold / isdicimal / isidentifier / isnumeric / isprintable / encode)之外，str类型的其他方法都支持bytes和bytearray类型。</p>
<p>二进制序列中有个类方法是 str 没有的，名为 fromhex：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">bytes</span><span class="token punctuation">.</span>fromhex<span class="token punctuation">(</span><span class="token string">'31 4B ce A9'</span><span class="token punctuation">)</span>
b<span class="token string">'1K\xce\xa9'</span>
</pre><p>使用缓冲类对象构建二进制序列是一种底层操作，可能涉及类型转换：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> array <span class="token keyword">import</span> array
<span class="token comment"># 创建 signed short 类型的 array</span>
<span class="token operator">>></span><span class="token operator">></span> numbers <span class="token operator">=</span> array<span class="token punctuation">(</span><span class="token string">'h'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> octets <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> octets
b<span class="token string">'\xfe\xff\xff\xff\x00\x00\x01\x00\x02\x00'</span>
</pre><p>使用缓冲类对象创建 bytes 或 bytearray 对象时，始终赋值源对象中的字节序列。与之相反，memoryview 对象允许在二进制数据结构之间共享内存。如果从二进制序列中提取结构化信息，struct 模块是重要的工具。</p>
<h4 class="mume-header" id="%E7%BB%93%E6%9E%84%E4%BD%93%E5%92%8C%E5%86%85%E5%AD%98%E8%AF%95%E5%9B%BE">结构体和内存试图</h4>

<p>struct 模块中提供了一些函数，将打包的字节序列转换成不同类型字段组成的元组，还有一些函数用于反向操作。struct 模块能处理 bytes、bytearray、memoryview对象。</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> struct
<span class="token comment"># &lt; 表示小端模式，3s表示3字节的bytes，H表示unsigned short</span>
<span class="token operator">>></span><span class="token operator">></span> fmt <span class="token operator">=</span> <span class="token string">'&lt;3s3sHH'</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'filter.gif'</span><span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fp<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     img <span class="token operator">=</span> <span class="token builtin">memoryview</span><span class="token punctuation">(</span>fp<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">>></span><span class="token operator">></span> header <span class="token operator">=</span> img<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span>
b<span class="token string">'GIF89a,\x01,\x01'</span>
<span class="token comment"># 拆包，得到一个元组，包括类型、版本、宽度、高度</span>
<span class="token operator">>></span><span class="token operator">></span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span>fmt<span class="token punctuation">,</span> header<span class="token punctuation">)</span>
<span class="token punctuation">(</span>b<span class="token string">'GIF'</span><span class="token punctuation">,</span> b<span class="token string">'89a'</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span>
</pre><h3 class="mume-header" id="%E5%9F%BA%E6%9C%AC%E7%9A%84%E7%BC%96%E8%A7%A3%E7%A0%81%E5%99%A8">基本的编解码器</h3>

<p>Python 自带了超过 100 中编码解码器(codec, ecoder/decoder)，用于在文本和字节之间相互转换。每个编码器都有一个名称，如 'utf_8'，而且经常有几个别名，如'utf8'、'utf-8'、'U8'。这些名称可以传递给 open()、str.encode()、bytes.decode()等函数的encoding参数。</p>
<p>使用3个编码器编码字节字符串 'El Niño'，得到的字节序列相差很大：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> codec <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'latin-1'</span><span class="token punctuation">,</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span><span class="token string">'utf-16'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>codec<span class="token punctuation">,</span> <span class="token string">'El Niño'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span>encoding<span class="token operator">=</span>codec<span class="token punctuation">)</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
latin<span class="token operator">-</span><span class="token number">1</span>	b<span class="token string">'El Ni\xf1o'</span>
utf<span class="token operator">-</span><span class="token number">8</span>	b<span class="token string">'El Ni\xc3\xb1o'</span>
utf<span class="token operator">-</span><span class="token number">16</span>	b<span class="token string">'\xff\xfeE\x00l\x00 \x00N\x00i\x00\xf1\x00o\x00'</span>
</pre><p>一些编码的介绍：</p>
<ul>
<li>latin1（即iso8859_1）：一种重要的编码，是其他编码的基础，例如cp1252 和 Unicode（注意：latin1与cp1252的字节值是一样的，甚至连码位都相同）</li>
<li>cp1252：Microsoft定制的latin1超集，添加了有用的符号，例如弯引号和€：有些Windows应用把它称为 ASCI，但它并不是ASCI标准</li>
<li>cp437：IBM PC 最初的字符集，包含框图符号，与后来出现的 latin1 不兼容</li>
<li>gb2312：用于编码简体中文的陈旧标准，这是亚洲语言中使用最广泛的多字节编码之一</li>
<li>utf-8：目前Web中最常用的8位编码，与ASCII兼容</li>
<li>utf-16le：UTF-16的16位编码方案的一种形式；所有 UTF-16 支持通过转义序列(称为代理对，surrogate pair)表示超过U+FFFF的码位。</li>
</ul>
<h3 class="mume-header" id="%E4%BA%86%E8%A7%A3%E7%BC%96%E7%A0%81%E8%A7%A3%E7%A0%81%E9%97%AE%E9%A2%98">了解编码解码问题</h3>

<p>虽然有个一般性的 UnicodeError 异常，但是报告错误时几乎都会指明具体的异常：UnicodeEncodeError(把字符串转换成二进制序列时)或UnicodeDecodeError(把二进制序列转换成字符串时)。如果源码的编码与预期不符，加载Python模块时还可能抛出 SyntaxError。</p>
<h4 class="mume-header" id="%E5%A4%84%E7%90%86-unicodeencodeerror">处理 UnicodeEncodeError</h4>

<p>多数非 UTF 编解码器只能处理 Unicode 字符的一小部分子集。</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> city <span class="token operator">=</span> <span class="token string">'São Paulo'</span>
<span class="token comment"># utf-? 编码能处理任何的字符串</span>
<span class="token operator">>></span><span class="token operator">></span> city<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
b<span class="token string">'S\xc3\xa3o Paulo'</span>
<span class="token operator">>></span><span class="token operator">></span> city<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-16'</span><span class="token punctuation">)</span>
b<span class="token string">'\xff\xfeS\x00\xe3\x00o\x00 \x00P\x00a\x00u\x00l\x00o\x00'</span>
<span class="token comment"># iso8859-1 也能处理 'São Paulo'</span>
<span class="token operator">>></span><span class="token operator">></span> city<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'iso8859_1'</span><span class="token punctuation">)</span>
b<span class="token string">'S\xe3o Paulo'</span>
<span class="token comment"># cp437 不能处理 ã</span>
<span class="token operator">>></span><span class="token operator">></span> city<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'cp437'</span><span class="token punctuation">)</span>
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>
  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>
  File <span class="token string">"/Users/fenghuabin/anaconda3/lib/python3.6/encodings/cp437.py"</span><span class="token punctuation">,</span> line <span class="token number">12</span><span class="token punctuation">,</span> <span class="token keyword">in</span> encode
    <span class="token keyword">return</span> codecs<span class="token punctuation">.</span>charmap_encode<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">,</span>errors<span class="token punctuation">,</span>encoding_map<span class="token punctuation">)</span>
UnicodeEncodeError<span class="token punctuation">:</span> <span class="token string">'charmap'</span> codec can<span class="token string">'t encode character '</span>\xe3' <span class="token keyword">in</span> position <span class="token number">1</span><span class="token punctuation">:</span> character maps to <span class="token operator">&lt;</span>undefined<span class="token operator">></span>
<span class="token comment"># 以忽略无法编码的字符跳过，这种做法通常不妥</span>
<span class="token operator">>></span><span class="token operator">></span> city<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'cp437'</span><span class="token punctuation">,</span>errors<span class="token operator">=</span><span class="token string">'ignore'</span><span class="token punctuation">)</span>
b<span class="token string">'So Paulo'</span>
<span class="token comment"># 将无法编码的字符替换成 ?，显示给用户</span>
<span class="token operator">>></span><span class="token operator">></span> city<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'cp437'</span><span class="token punctuation">,</span>errors<span class="token operator">=</span><span class="token string">'replace'</span><span class="token punctuation">)</span>
b<span class="token string">'S?o Paulo'</span>
<span class="token comment"># 把无法编码的字符替换成 XML 实体</span>
<span class="token operator">>></span><span class="token operator">></span> city<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'cp437'</span><span class="token punctuation">,</span>errors<span class="token operator">=</span><span class="token string">'xmlcharrefreplace'</span><span class="token punctuation">)</span>
b<span class="token string">'S&amp;#227;o Paulo'</span>
</pre><h4 class="mume-header" id="%E5%A4%84%E7%90%86-unicodedecodeerror">处理 UnicodeDecodeError</h4>

<p>不是每个字节都包含有效的ASCII字符，也不是每个字符序列都是有效的UTF-8或UTF-16。因此，把二进制序列转换成文本时，如果假设是这两个编码中的一个，遇到无法转换的字节序列时就会抛出 UnicodeDecodeError。</p>
<p>另一方面，很多陈旧的 8 为编码 —— 如 cp1252，iso8859-1 和 koi8-r 能解码如何字节序列流而不抛出错误，例如随机噪声。因此，如果程序使用错误的8位编码，解码过程悄无声息，而得到的是无用的输出。</p>
<blockquote>
<p>乱码字符称为鬼符(gremlin)</p>
</blockquote>
<p>把字节序列解码成字符串：成功和错误处理</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token comment"># 这些字节是使用latin1 编码的 'Montréal'</span>
<span class="token operator">>></span><span class="token operator">></span> octets <span class="token operator">=</span> b<span class="token string">'Montr\xe9al'</span>
<span class="token comment"># 可以使用 cp1252 解码，因为它是 latin1 的有效超集</span>
<span class="token operator">>></span><span class="token operator">></span> octets<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'cp1252'</span><span class="token punctuation">)</span>
<span class="token string">'Montréal'</span>
<span class="token comment"># ISO-8895-7 用于希腊文编码，无法正确解码 '\xe9'</span>
<span class="token operator">>></span><span class="token operator">></span> octets<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'iso8859-7'</span><span class="token punctuation">)</span>
<span class="token string">'Montrιal'</span>
<span class="token comment"># KOI8-R 用于编码俄文</span>
<span class="token operator">>></span><span class="token operator">></span> octets<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'koi8_r'</span><span class="token punctuation">)</span>
<span class="token string">'MontrИal'</span>
<span class="token comment"># utf-8 检测到 octets 不是有效的 UTF-8 字符串，抛出错误 UnicodeDecodeError</span>
<span class="token operator">>></span><span class="token operator">></span> octets<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>
  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>
UnicodeDecodeError<span class="token punctuation">:</span> <span class="token string">'utf-8'</span> codec can't decode byte <span class="token number">0xe9</span> <span class="token keyword">in</span> position <span class="token number">5</span><span class="token punctuation">:</span> invalid continuation byte
<span class="token comment"># \xe9 被替换成 � （码位：U+FFFD）</span>
<span class="token operator">>></span><span class="token operator">></span> octets<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span> errors<span class="token operator">=</span><span class="token string">'replace'</span><span class="token punctuation">)</span>
<span class="token string">'Montr�al'</span>
</pre><h4 class="mume-header" id="%E4%BD%BF%E7%94%A8%E9%A2%84%E6%9C%9F%E4%B9%8B%E5%A4%96%E7%9A%84%E7%BC%96%E7%A0%81%E5%8A%A0%E8%BD%BD%E6%A8%A1%E5%9D%97%E6%97%B6%E6%8A%9B%E5%87%BAsyntaxerror">使用预期之外的编码加载模块时抛出SyntaxError</h4>

<p>Python3 默认使用 UTF-8 编码源码，Python2 默认使用 ASCII。</p>
<p>如果加载的 .py 模块中包含 UTF-8 之外的数据，而且没有声明编码，会得到类似下面的消息：</p>
<pre data-role="codeBlock" data-info="" class="language-"><code>SyntaxError: Non-UTF-8 code starting with &apos;\xc4&apos; in file x2.py on line 1, 
but no encoding declared; see http://python.org/dev/peps/pep-0263/ for details
</code></pre><p>GNU/Linux 和 OS X 系统大都使用 UTF-8，因此打开在 Windows 系统中使用 cp1252 编码。</p>
<p>为了修正这个问题，可以在文件顶部添加一个神奇的 coding 注释：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token comment"># coding: cp1252</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'你好，世界'</span><span class="token punctuation">)</span>
</pre><blockquote>
<p>现在 Python3 的源码不再限于使用ASCII，而是默认使用优秀的 UTF-8，因此要修正源码的陈旧编码（如 cp1252）问题，最好将其转换为UTF-8，别去麻烦coding注释，如果你用的编辑器不支持 UTF-8，那就换了它。</p>
</blockquote>
<p>Python 允许在源码中使用非ASCII标识符：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> 苹果<span class="token operator">=</span><span class="token string">'apple'</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>苹果<span class="token punctuation">)</span>
apple
<span class="token operator">>></span><span class="token operator">></span> π <span class="token operator">=</span> <span class="token number">3.14</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>π<span class="token punctuation">)</span>
<span class="token number">3.14</span>
</pre><h4 class="mume-header" id="%E5%A6%82%E4%BD%95%E6%89%BE%E5%87%BA%E5%AD%97%E8%8A%82%E5%BA%8F%E5%88%97%E7%9A%84%E7%BC%96%E7%A0%81">如何找出字节序列的编码</h4>

<p>如何找出字节序列的编码？简单来说，不能，必须有人告诉你。</p>
<p>有些通信协议和文件格式，如HTTP、XML，包含明确证明内容的首部。可以确定的是，某些字节流不是 ASCII，因为其中包含大于127的字节值，而且 UTF-8 和 UTF-16 的方式也限制了可用的字节序列。不过即便如此，我们也不能根据特定的位模式来 100% 确定二进制文件的编码时 ASCII 或 UTF-8。</p>
<p>统一字符编码侦测包 chardet 可以识别所支持的 30 种编码。Chardet 是一个 Python 库，可以在程序中使用，不过它也提供了命令行工具 chardetect。</p>
<pre data-role="codeBlock" data-info="sh" class="language-bash">bash-3.2$ chardetect ai_homework.md 
ai_homework.md: utf-8 with confidence 0.99
</pre><p>二进制序列编码文本通常不会指明自己的编码，但是 UTF 格式可以在文本内容的开始添加一个字节序标记。</p>
<h4 class="mume-header" id="bom-%E6%9C%89%E7%94%A8%E7%9A%84%E9%AC%BC%E7%AC%A6">BOM 有用的鬼符</h4>

<p>UTF-16 编码的序列开头有几个额外的字节：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> u16 <span class="token operator">=</span> <span class="token string">'El Niño'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span>encoding<span class="token operator">=</span><span class="token string">'utf-16'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> u16
b<span class="token string">'\xff\xfeE\x00l\x00 \x00N\x00i\x00\xf1\x00o\x00'</span>
</pre><p>其中的<code>\xff\xfe</code>就是额外的字节。这是 BOM，即字节序标记（Byte Order Mark），指明编码时使用 Intel CPU 的小字节序。</p>
<p>在小字节序设备中，各个码位的最低有效字节在前面。</p>
<p>UTF-16 有两个变种：UTF-16LE 显式指明使用小字节序，UTF-16BE，显式指明使用大字节序，如果使用这两个变种，不会生成 BOM：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token string">'El Niño'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span>encoding<span class="token operator">=</span><span class="token string">'utf_16'</span><span class="token punctuation">)</span>
b<span class="token string">'\xff\xfeE\x00l\x00 \x00N\x00i\x00\xf1\x00o\x00'</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token string">'El Niño'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span>encoding<span class="token operator">=</span><span class="token string">'utf_16le'</span><span class="token punctuation">)</span>
b<span class="token string">'E\x00l\x00 \x00N\x00i\x00\xf1\x00o\x00'</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token string">'El Niño'</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span>encoding<span class="token operator">=</span><span class="token string">'utf_16be'</span><span class="token punctuation">)</span>
b<span class="token string">'\x00E\x00l\x00 \x00N\x00i\x00\xf1\x00o'</span>
</pre><p>如果有BOM，UTF-16编码器会将其过滤掉，为你提供没有前导 ZERO WITH NOBREAK SPACE 字符的真正文本。根据标准，文件使用 UTF-16编码，并且没有BOM，那么应该假定使用 UTF-16BE 编码。然而，Intel x86 架构用的是小字节序，因此有很多文本用的是不带 BOM 的小字节序 UTF-16 编码。</p>
<h3 class="mume-header" id="%E5%A4%84%E7%90%86%E6%96%87%E6%9C%AC%E6%96%87%E4%BB%B6">处理文本文件</h3>

<p>处理文本的最佳时间是 &quot;Unicode三明治&quot;：要尽早将输入的字节序列解码成字符串三明治中的“肉片”是程序的业务逻辑，在这里只能处理字符串对象。在其他处理过程中，一定不能编码或解码。对输出来说，则要尽量晚地把字符串编码成字节序列。多数 Web 框架都是这样做的，使用框架时很少接触字节序列。例如，在 Django 中，视图应该输出 Unicode 字符串；Django 会负责将响应编码成字节序列，而且默认使用UTF-8编码。</p>
<blockquote>
<p>需要在多台设备中或多种场合中运行的代码，一定不能依赖默认编码。打开文件时始终应该明确传入 encoding=参数，因为不同的设备使用的默认编码可能不同，有时隔一天都会发生变化。</p>
</blockquote>
<blockquote>
<p>除非像判断编码，否则不要在二进制模式中打开文本文件；即使如此，也应该使用 Chardet 而不是重新发明轮子。常规代码只应该使用二进制模式打开二进制文件，如光栅图像。</p>
</blockquote>
<h3 class="mume-header" id="%E4%B8%BA%E4%BA%86%E6%AD%A3%E7%A1%AE%E6%AF%94%E8%BE%83%E8%80%8C%E8%A7%84%E8%8C%83%E5%8C%96-unicode-%E5%AD%97%E7%AC%A6%E4%B8%B2">为了正确比较而规范化 Unicode 字符串</h3>

<p>因为 Unicode 有组合字符（变音符号和附加到前一个字符上的记号，打印时作为一个整体），所以字符串比较起来很复杂，比如 café 可以用两种方式构成，分别有 4 个和 5 个码位，但是结果完全一样：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> s1 <span class="token operator">=</span> <span class="token string">'café'</span>
<span class="token operator">>></span><span class="token operator">></span> s2 <span class="token operator">=</span> <span class="token string">'cafe\u0301'</span>
<span class="token operator">>></span><span class="token operator">></span> s1<span class="token punctuation">,</span> s2
<span class="token punctuation">(</span><span class="token string">'café'</span><span class="token punctuation">,</span> <span class="token string">'café'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> s1<span class="token operator">==</span>s2
<span class="token boolean">False</span>
</pre><p>U+0301 是 COMBINING ACUTE ACCENT，加在 e 后面得到 é。在Unicode标准中，'é' 和 'e\u0301' 这样的序列称为 标准等价物，应用程序应该吧它们视为相同字符。但是，Python看到的是不同的码位序列，因此判定两者不相等。</p>
<p>这个问题的解决方案是使用 unicodedata.normalize 函数提供的 Unicode 规范化。这个函数的第一个参数使4个字符串中的一个：NFC、NFD、NFKC、NFKD。</p>
<ul>
<li>NFC（Normalization Form C）：使用最少的码位构成等价的字符串</li>
<li>NFD ：把组合字符分成基字符和单独的组合字符</li>
</ul>
<p>这两种规范化方式都能让比较行为符合预期：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> unicodedata <span class="token keyword">import</span> normalize
<span class="token operator">>></span><span class="token operator">></span> s1 <span class="token operator">=</span> <span class="token string">'café'</span>
<span class="token operator">>></span><span class="token operator">></span> s2 <span class="token operator">=</span> <span class="token string">'cafe\u0301'</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span>normalize<span class="token punctuation">(</span><span class="token string">'NFC'</span><span class="token punctuation">,</span>s1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>normalize<span class="token punctuation">(</span><span class="token string">'NFC'</span><span class="token punctuation">,</span>s2<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">len</span><span class="token punctuation">(</span>normalize<span class="token punctuation">(</span><span class="token string">'NFD'</span><span class="token punctuation">,</span>s1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>normalize<span class="token punctuation">(</span><span class="token string">'NFD'</span><span class="token punctuation">,</span>s2<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> normalize<span class="token punctuation">(</span><span class="token string">'NFC'</span><span class="token punctuation">,</span>s1<span class="token punctuation">)</span><span class="token operator">==</span>normalize<span class="token punctuation">(</span><span class="token string">'NFC'</span><span class="token punctuation">,</span>s2<span class="token punctuation">)</span>
<span class="token boolean">True</span>
<span class="token operator">>></span><span class="token operator">></span> normalize<span class="token punctuation">(</span><span class="token string">'NFD'</span><span class="token punctuation">,</span>s1<span class="token punctuation">)</span><span class="token operator">==</span>normalize<span class="token punctuation">(</span><span class="token string">'NFD'</span><span class="token punctuation">,</span>s2<span class="token punctuation">)</span>
<span class="token boolean">True</span>
</pre><p>另两个规范化形式为 NFKC 和 NFKD。</p>
<h4 class="mume-header" id="%E5%A4%A7%E5%B0%8F%E5%86%99%E6%8A%98%E5%8F%A0">大小写折叠</h4>

<p>大小写折叠就是把所有文本写成小写，再做其他转换，由 <code>str.casefold()</code> 支持。</p>
<p>对于只包含 latin1 字符的字符串 s，<code>s.casefold()</code> 得到的结果与 <code>s.lower()</code> 一样。</p>
<h1 class="mume-header" id="%E6%8A%8A%E5%87%BD%E6%95%B0%E8%A7%86%E4%B8%BA%E5%AF%B9%E8%B1%A1">把函数视为对象</h1>

<h2 class="mume-header" id="%E4%B8%80%E7%AD%89%E5%87%BD%E6%95%B0">一等函数</h2>

<p>在 Python 中，函数是一等对象。编程语言理论家将“一等对象”定义为满足下列条件的程序实体：</p>
<ul>
<li>在运行时创建</li>
<li>能赋值给变量或数据结构中的元素</li>
<li>能作为参数传给函数</li>
<li>能作为函数的返回值</li>
</ul>
<p>在 Python 中，整数、字符串和字典都是一等对象。</p>
<p>一等函数实际上的意思是：函数在Python中是一等对象。</p>
<h3 class="mume-header" id="%E6%8A%8A%E5%87%BD%E6%95%B0%E8%A7%86%E4%B8%BA%E5%AF%B9%E8%B1%A1-1">把函数视为对象</h3>

<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">factorial</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token triple-quoted-string string">'''returns n! '''</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">return</span> <span class="token number">1</span> <span class="token keyword">if</span> n <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token keyword">else</span> n<span class="token operator">*</span>factorial<span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">>></span><span class="token operator">></span> factorial<span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
<span class="token number">1405006117752879898543142606244511569936384000000000</span>
<span class="token operator">>></span><span class="token operator">></span> factorial<span class="token punctuation">.</span>__dict__
<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">type</span><span class="token punctuation">(</span>factorial<span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'function'</span><span class="token operator">></span>
</pre><h3 class="mume-header" id="%E9%AB%98%E9%98%B6%E5%87%BD%E6%95%B0">高阶函数</h3>

<p>接受函数为参数，或者把函数作为结果返回的函数就是高阶函数（higher-order function）。map 函数就是一例，此外，内置函数 sorted 也是。</p>
<h3 class="mume-header" id="%E5%8C%BF%E5%90%8D%E5%87%BD%E6%95%B0">匿名函数</h3>

<p>lambda 关键字在Python表达式中创建匿名函数。</p>
<p>除了作为参数传递给高阶函数之外，Python 很少使用匿名函数。</p>
<p><strong>Lumdh 提出的 lambda 表达式重构秘籍</strong><br>
如果使用 lambda 表达式导致一段代码难以阅读，Fredrik Lundh 建议像下面这样重构：</p>
<ol>
<li>编写注释：说明 lambda 表达式的作用</li>
<li>研究一会注释，并找出一个名称来概括注释</li>
<li>把lambda表达式转换成def语句，使用那个名称来定义函数</li>
<li>删除注释</li>
</ol>
<h3 class="mume-header" id="%E5%8F%AF%E8%B0%83%E7%94%A8%E5%AF%B9%E8%B1%A1">可调用对象</h3>

<p>除了用户定义的函数，调用运算符（即括号）还可以用到其他对象上，如果想判断对象能否被调用，可以使用内置的 callable()函数。<br>
Python 数据模型文档列出了 7 种可调用对象：</p>
<ol>
<li>用户定义的函数：用lambda 和 def 创建</li>
<li>内置函数：使用C语言实现的函数，如 len 或 time.strftime</li>
<li>内置方法：使用C实现的方法，如 dict.get</li>
<li>方法：在类的定义体中定义的函数</li>
<li>类：调用类时会运行类的 <code>__new__</code> 方法创建一个实例，然后运行 <code>__init__</code> 方法，初始化实例，最后把实例返回给调用方。因为 Python 没有 new 运算符，所以调用类相当于调用函数。</li>
<li>类的实例：如果定义了 <code>__call__</code> 方法，那么它的实例可以作为函数调用</li>
<li>生成器函数：使用 yield 关键字的函数或方法，调用生成器函数返回的是生成器对象。</li>
</ol>
<p>生成器函数在很多方面与其他可调用对象不同，后面章节会介绍，生成器函数还可以作为协程。</p>
<p>Python 中有各种各样的可调用类型，因此判断对象是否可调用，最安全的方式是使用内置的 callable() 函数。</p>
<h3 class="mume-header" id="%E7%94%A8%E6%88%B7%E5%AE%9A%E4%B9%89%E7%9A%84%E5%8F%AF%E8%B0%83%E7%94%A8%E7%B1%BB%E5%9E%8B">用户定义的可调用类型</h3>

<p>不仅 Python 函数是真正的对象，任何 Python 对象都可以表现得像函数，为此，只需要实现实例方法：<code>__call__</code>。</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'hello,world'</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> A<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> a<span class="token punctuation">(</span><span class="token punctuation">)</span>
hello<span class="token punctuation">,</span>world
</pre><p>实现 <code>__call__</code> 方法的类是创建函数类对象的简便方式，可以使用类中的属性记录运行环境，如下实现了一个计数器：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">MyCounter</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> init<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         self<span class="token punctuation">.</span>v <span class="token operator">=</span> init
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         self<span class="token punctuation">.</span>v <span class="token operator">+=</span> <span class="token number">1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">return</span> self<span class="token punctuation">.</span>v
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">>></span><span class="token operator">></span> c1 <span class="token operator">=</span> MyCounter<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> c1<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">1</span>
<span class="token operator">>></span><span class="token operator">></span> c1<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">2</span>
<span class="token operator">>></span><span class="token operator">></span> c2 <span class="token operator">=</span> MyCounter<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> c1<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">3</span>
<span class="token operator">>></span><span class="token operator">></span> c2<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">1</span>
</pre><p>创建保有内部状态的函数还有另一种截然不同的方法--使用闭包。</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">GetCounter</span><span class="token punctuation">(</span>init<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     v <span class="token operator">=</span> init
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">nonlocal</span> v
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         v <span class="token operator">+=</span> <span class="token number">1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">return</span> v
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">return</span> f
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">>></span><span class="token operator">></span> c1 <span class="token operator">=</span> GetCounter<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> c1<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">1</span>
<span class="token operator">>></span><span class="token operator">></span> c1<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">2</span>
<span class="token operator">>></span><span class="token operator">></span> c2 <span class="token operator">=</span> GetCounter<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> c1<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">3</span>
<span class="token operator">>></span><span class="token operator">></span> c2<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">1</span>
</pre><p>下面讨论把函数视为对象处理的另一方面：运行时内省。</p>
<h3 class="mume-header" id="%E5%87%BD%E6%95%B0%E5%86%85%E7%9C%81">函数内省</h3>

<p>除了 <code>__doc__</code>，函数对象还有很多属性。使用 dir 可以探知 factorial 具有下列属性：</p>
<pre data-role="codeBlock" data-info="" class="language-"><code>[&apos;__annotations__&apos;, &apos;__call__&apos;, &apos;__class__&apos;, &apos;__closure__&apos;, &apos;__code__&apos;, 
&apos;__defaults__&apos;, &apos;__delattr__&apos;, &apos;__dict__&apos;, &apos;__dir__&apos;, &apos;__doc__&apos;, &apos;__eq__&apos;, 
&apos;__format__&apos;, &apos;__ge__&apos;, &apos;__get__&apos;, &apos;__getattribute__&apos;, &apos;__globals__&apos;, &apos;__gt__&apos;, 
&apos;__hash__&apos;, &apos;__init__&apos;, &apos;__init_subclass__&apos;, &apos;__kwdefaults__&apos;, &apos;__le__&apos;, &apos;__lt__&apos;, 
&apos;__module__&apos;, &apos;__name__&apos;, &apos;__ne__&apos;, &apos;__new__&apos;, &apos;__qualname__&apos;, &apos;__reduce__&apos;, 
&apos;__reduce_ex__&apos;, &apos;__repr__&apos;, &apos;__setattr__&apos;, &apos;__sizeof__&apos;, &apos;__str__&apos;, 
&apos;__subclasshook__&apos;]
</code></pre><p>其中大多数属性是 Python 对象共有的，本节讨论把函数作为对象相关的几个属性。</p>
<ol>
<li><code>__dict__</code> : 存储赋予它的 <strong>用户属性</strong>。一般来说，为函数随意赋予属性不是很常见，但是 Django 框架这么做了。</li>
</ol>
<p>下面字典说明函数专有而一边对象没有的属性。计算两个属性集合的差便能得到函数专有属性列表：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">C</span><span class="token punctuation">:</span><span class="token keyword">pass</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">pass</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">>></span><span class="token operator">></span> obj <span class="token operator">=</span> C<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">sorted</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token builtin">dir</span><span class="token punctuation">(</span>fun<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token builtin">dir</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token string">'__annotations__'</span><span class="token punctuation">,</span> <span class="token string">'__call__'</span><span class="token punctuation">,</span> <span class="token string">'__closure__'</span><span class="token punctuation">,</span> <span class="token string">'__code__'</span><span class="token punctuation">,</span> <span class="token string">'__defaults__'</span><span class="token punctuation">,</span> 
<span class="token string">'__get__'</span><span class="token punctuation">,</span> <span class="token string">'__globals__'</span><span class="token punctuation">,</span> <span class="token string">'__kwdefaults__'</span><span class="token punctuation">,</span> <span class="token string">'__name__'</span><span class="token punctuation">,</span> <span class="token string">'__qualname__'</span><span class="token punctuation">]</span>
</pre><p>用户定义的函数的属性：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>__annotations__</code></td>
<td>dict</td>
<td>参数和返回值的注解</td>
</tr>
<tr>
<td><code>__call__</code></td>
<td>method-<br>wrapper</td>
<td>实现 () 运算，即可调用对象协议</td>
</tr>
<tr>
<td><code>__closure__</code></td>
<td>tuple</td>
<td>函数闭包，即自由变量的绑定(通常为 None)</td>
</tr>
<tr>
<td><code>__code__</code></td>
<td>code</td>
<td>编译成字节码的函数元数据和函数定义体</td>
</tr>
<tr>
<td><code>__defaults__</code></td>
<td>tuple</td>
<td>形参默认值</td>
</tr>
<tr>
<td><code>__get__</code></td>
<td>method-<br>wrapper</td>
<td>实现只读描述符协议</td>
</tr>
<tr>
<td><code>__globals__</code></td>
<td>dict</td>
<td>函数所在模块中的全局变量</td>
</tr>
<tr>
<td><code>__kwdefaults__</code></td>
<td>dict</td>
<td><strong>仅限关键字形式参数</strong>的默认值</td>
</tr>
<tr>
<td><code>__name__</code></td>
<td>str</td>
<td>函数名称，匿名函数为 <lambda></lambda></td>
</tr>
<tr>
<td><code>__qualname__</code></td>
<td>str</td>
<td>函数的限定名称</td>
</tr>
</tbody>
</table>
<h3 class="mume-header" id="%E4%BB%8E%E5%AE%9A%E4%BD%8D%E5%8F%82%E6%95%B0%E5%88%B0%E4%BB%85%E9%99%90%E5%85%B3%E9%94%AE%E5%AD%97%E5%8F%82%E6%95%B0">从定位参数到仅限关键字参数</h3>

<p>Python 最好的特性之一是提供了极为灵活的参数处理机制，而且 Python 3 进一步提供了仅限关键字 参数(keyword-only argument)。与之密切相关的是，调用函数时使用 * 和 ** 展开可迭代对象，映射到单个参数。</p>
<p>定义一个用于生成HTML标签的tag函数：</p>
<pre data-role="codeBlock" data-info="python {class=line-numbers}" class="language-python line-numbers"><span class="token keyword">def</span> <span class="token function">tag</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token operator">*</span>content<span class="token punctuation">,</span> cls<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>attrs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""生成一个或多个HTML标签"""</span>
    attr_str <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">if</span> attrs<span class="token punctuation">:</span>
        <span class="token keyword">for</span> k<span class="token punctuation">,</span>v <span class="token keyword">in</span> attrs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            attr_str <span class="token operator">+=</span> f<span class="token string">' {k}="{v}"'</span>
    cls_str <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">if</span> cls <span class="token keyword">is</span> <span class="token operator">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        cls_str <span class="token operator">=</span> f<span class="token string">' class="{cls}"'</span>
    left_tag <span class="token operator">=</span> f<span class="token string">'{name}{cls_str}{attr_str}'</span>
    right_tag <span class="token operator">=</span> f<span class="token string">'/{name}'</span>
    <span class="token keyword">if</span> <span class="token operator">not</span> content<span class="token punctuation">:</span>
        <span class="token keyword">return</span> f<span class="token string">'&lt;{left_tag} />'</span>
    <span class="token keyword">return</span> <span class="token string">'\n'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>f<span class="token string">'&lt;{left_tag}>{sub_ct}&lt;{right_tag}>'</span>
        <span class="token keyword">for</span> sub_ct <span class="token keyword">in</span> content<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><p>测试效果：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> tag<span class="token punctuation">(</span><span class="token string">'br'</span><span class="token punctuation">)</span>
<span class="token string">'&lt;br />'</span>
<span class="token operator">>></span><span class="token operator">></span> tag<span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span><span class="token string">'hello'</span><span class="token punctuation">)</span>
<span class="token string">'&lt;p>hello&lt;/p>'</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>tag<span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span><span class="token string">'hello'</span><span class="token punctuation">,</span><span class="token string">'world'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>p<span class="token operator">></span>hello<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>
<span class="token operator">&lt;</span>p<span class="token operator">></span>world<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>
<span class="token operator">>></span><span class="token operator">></span> tag<span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span><span class="token string">'hello'</span><span class="token punctuation">,</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token number">33</span><span class="token punctuation">)</span>
<span class="token string">'&lt;p id="33">hello&lt;/p>'</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>tag<span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span><span class="token string">'hello'</span><span class="token punctuation">,</span><span class="token string">'world'</span><span class="token punctuation">,</span>cls<span class="token operator">=</span><span class="token string">'sidebar'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span>p <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"sidebar"</span><span class="token operator">></span>hello<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>
<span class="token operator">&lt;</span>p <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"sidebar"</span><span class="token operator">></span>world<span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">></span>
<span class="token operator">>></span><span class="token operator">></span> tag<span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token string">'testing'</span><span class="token punctuation">,</span>name<span class="token operator">=</span><span class="token string">'img'</span><span class="token punctuation">)</span>
<span class="token string">'&lt;img content="testing" />'</span>
<span class="token operator">>></span><span class="token operator">></span> my_tag <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">:</span><span class="token string">'img'</span><span class="token punctuation">,</span><span class="token string">'title'</span><span class="token punctuation">:</span><span class="token string">'Sumset Boulevard'</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token string">'src'</span><span class="token punctuation">:</span><span class="token string">'sunset.jpg'</span><span class="token punctuation">,</span> <span class="token string">'cls'</span><span class="token punctuation">:</span><span class="token string">'framed'</span><span class="token punctuation">}</span>
<span class="token operator">>></span><span class="token operator">></span> tag<span class="token punctuation">(</span><span class="token operator">**</span>my_tag<span class="token punctuation">)</span>
<span class="token string">'&lt;img class="framed" title="Sumset Boulevard" src="sunset.jpg" />'</span>
</pre><p>仅限关键字参数是 Python3 新增的特性。在上面的示例中，cls 参数只能通过关键字参数指定，它一定不会捕获未命名的定位参数。<strong>定义函数时，若想指定仅限关键字参数，要把它们放到前面有 * 的参数后面</strong>。</p>
<p>如果不想支持数量不定的定位参数，但是想支持仅限关键字参数，在签名中放一个 * :</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token operator">*</span><span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">return</span> a<span class="token punctuation">,</span>b
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>b<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>b<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>
  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>
TypeError<span class="token punctuation">:</span> f<span class="token punctuation">(</span><span class="token punctuation">)</span> takes <span class="token number">1</span> positional argument but <span class="token number">2</span>
<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>
  File <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span>
TypeError<span class="token punctuation">:</span> f<span class="token punctuation">(</span><span class="token punctuation">)</span> missing <span class="token number">1</span> required keyword<span class="token operator">-</span>only argument<span class="token punctuation">:</span> <span class="token string">'b'</span>
</pre><p>注意：仅限关键字参数不一定要有默认值，可以像上例 b 一样，强制传入实参。</p>
<h3 class="mume-header" id="%E8%8E%B7%E5%8F%96%E5%85%B3%E4%BA%8E%E5%8F%82%E6%95%B0%E7%9A%84%E4%BF%A1%E6%81%AF">获取关于参数的信息</h3>

<p>函数对象有个 <code>__defaults__</code> 属性，它的值是一个元组，里面保存着定位参数和关键字参数的默认值。仅限关键字参数的默认值在 <code>__kwdefaults__</code> 属性中。然而，参数的名称在 <code>__code__</code> 属性中，它的值是一个 code 对象引用，自身也有很多属性。</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     c <span class="token operator">=</span> a <span class="token operator">+</span> b
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     d <span class="token operator">=</span> c<span class="token operator">*</span><span class="token number">2</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">return</span> d
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>__defaults__
<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>__code__
<span class="token operator">&lt;</span>code <span class="token builtin">object</span> f at <span class="token number">0x10adebc00</span><span class="token punctuation">,</span> <span class="token builtin">file</span> <span class="token string">"&lt;stdin>"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token operator">></span>
<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>__code__<span class="token punctuation">.</span>co_varnames
<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> f<span class="token punctuation">.</span>__code__<span class="token punctuation">.</span>co_argcount
<span class="token number">2</span>
</pre><p>可以看出，这种组织信息的方式并不遍历。参数名在 <code>__code__.co_varnames</code> 中，不过里面还有函数定义体中创建的局部变量。因此，参数名称是前 N 个字符串，N 的值由 <code>__code__.argcount</code> 确定。</p>
<p>我们可以用更好的方式--使用<code>inspect</code>模块。</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     c <span class="token operator">=</span> a <span class="token operator">+</span> b
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     d <span class="token operator">=</span> c <span class="token operator">*</span> <span class="token number">2</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">return</span> d
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> inspect <span class="token keyword">import</span> signature
<span class="token operator">>></span><span class="token operator">></span> sig <span class="token operator">=</span> signature<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> sig
<span class="token operator">&lt;</span>Signature <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token operator">></span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">str</span><span class="token punctuation">(</span>sig<span class="token punctuation">)</span>
<span class="token string">'(a, b=100)'</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> name<span class="token punctuation">,</span> param <span class="token keyword">in</span> sig<span class="token punctuation">.</span>parameters<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span>kind<span class="token punctuation">,</span> <span class="token string">':'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token string">'='</span><span class="token punctuation">,</span> param<span class="token punctuation">.</span>default<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
POSITIONAL_OR_KEYWORD <span class="token punctuation">:</span> a <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'inspect._empty'</span><span class="token operator">></span>
POSITIONAL_OR_KEYWORD <span class="token punctuation">:</span> b <span class="token operator">=</span> <span class="token number">100</span>
</pre><p><code>inspect.signature</code> 函数返回一个 inspect.Signature 对象，他有一个 parameters 属性，这是一个有序映射，把参数名和 inspect.Parameter 对象对应起来。各个 Parameter 属性也有自己的属性。</p>
<p>kind 属性值是 _ParameterKind 类中的5个值之一：</p>
<ul>
<li>POSITIONAL_OR_KEYWORD : 可以通过定位参数和关键字传入的形参</li>
<li>VAR_POSITIONAL : 定位参数元组，如 <code>f(*a)</code> 中的 <code>a</code></li>
<li>VAR_KEYWORD : 定位参数元组，如<code>f(**a)</code> 中的 <code>a</code></li>
<li>KEYWORD_ONLY : 仅限关键字参数(Python3 新增)，如<code>f(*, a)</code>和<code>f(*x,a)</code>中的<code>a</code></li>
<li>POSITIONAL_ONLY : 目前，Python声明语句的句法不支持，但是有些使用C语言实现且不接受关键字参数的函数支持。</li>
</ul>
<h3 class="mume-header" id="%E5%87%BD%E6%95%B0%E6%B3%A8%E9%87%8A">函数注释</h3>

<p>Python 3 提供了一种句法，用于为函数声明中的参数和返回值附加元数据。</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token keyword">def</span> <span class="token function">clip</span><span class="token punctuation">(</span>text<span class="token punctuation">:</span><span class="token builtin">str</span><span class="token punctuation">,</span> max_len<span class="token punctuation">:</span><span class="token string">'int > 0'</span><span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token builtin">str</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""在 max_len 前面或后面的第一个空格处截断文本
    """</span>
    end <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token operator">></span> max_len<span class="token punctuation">:</span>
        space_before <span class="token operator">=</span> text<span class="token punctuation">.</span>rfind<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> max_len<span class="token punctuation">)</span>
        <span class="token keyword">if</span> space_before <span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">:</span>
            end <span class="token operator">=</span> space_before
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            space_before <span class="token operator">=</span> text<span class="token punctuation">.</span>rfind<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> max_len<span class="token punctuation">)</span>
            <span class="token keyword">if</span> space_before <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">:</span>
                end <span class="token operator">=</span> space_before
        <span class="token keyword">if</span> end <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            end <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
    <span class="token keyword">return</span> text<span class="token punctuation">[</span><span class="token punctuation">:</span>end<span class="token punctuation">]</span><span class="token punctuation">.</span>rstrip<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre><p>函数声明中各个参数可以在冒号<code>:</code>之后添加注释表达式。如果参数有默认值，注释放在参数名和=号之间。如果想注释返回值，在 <code>)</code> 和函数声明末尾的 <code>:</code> 之间添加 <code>-&gt;</code> 和一个表达式。那个表达式可以是任何类型，注释中最常见的是类（如 str 和 int）和字符串（如 'int &gt; 0'）。</p>
<p>注释不会做任何的处理，只会存储在函数的<code>__annotations__</code>属性（一个字典）中。</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> clip<span class="token punctuation">.</span>__annotations__
<span class="token punctuation">{</span><span class="token string">'text'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'str'</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token string">'max_len'</span><span class="token punctuation">:</span> <span class="token string">'int > 0'</span><span class="token punctuation">,</span> <span class="token string">'return'</span><span class="token punctuation">:</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'str'</span><span class="token operator">></span><span class="token punctuation">}</span>
</pre><p>注释只是元数据，可供 IDE、框架和装饰器等工具使用。</p>
<h3 class="mume-header" id="%E6%94%AF%E6%8C%81%E5%87%BD%E6%95%B0%E6%98%AF%E7%BC%96%E7%A8%8B%E7%9A%84%E5%8C%85">支持函数是编程的包</h3>

<p>虽然 Guido 明确表明，Python 的目标不是编程函数式编程语言，但是得益于 operator 和 functools 等包的支持，函数式编程风格也可以实现。</p>
<h4 class="mume-header" id="operator-%E6%A8%A1%E5%9D%97">operator 模块</h4>

<p>在函数式编程中，经常需要把算术运算符当做函数使用，例如，不想使用递归计算阶乘。求和可以使用 sum 函数，但是求积却没有这样的函数，我们可以使用 reduce 函数，但是需要一个函数计算序列中两个元素之积。</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> functools <span class="token keyword">import</span> <span class="token builtin">reduce</span>
<span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span>
<span class="token comment"># 求和公式</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">reduce</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> a<span class="token punctuation">,</span>b<span class="token punctuation">:</span>a<span class="token operator">+</span>b<span class="token punctuation">,</span> a<span class="token punctuation">)</span>
<span class="token number">15</span>
<span class="token comment"># 求积公式</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">reduce</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> a<span class="token punctuation">,</span>b<span class="token punctuation">:</span>a<span class="token operator">*</span>b<span class="token punctuation">,</span> a<span class="token punctuation">)</span>
<span class="token number">120</span>
</pre><p>operator 模块为多个算术运算符提供了对应的函数，从而避免编写 <code>lambda a,b:a*b</code> 这样的平凡匿名化函数。</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> operator
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">reduce</span><span class="token punctuation">(</span>operator<span class="token punctuation">.</span>add<span class="token punctuation">,</span> a<span class="token punctuation">)</span>
<span class="token number">15</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">reduce</span><span class="token punctuation">(</span>operator<span class="token punctuation">.</span>mul<span class="token punctuation">,</span> a<span class="token punctuation">)</span>
<span class="token number">120</span>
</pre><p><code>operator</code> 模块中还有一类函数，能替代从序列中取出元素或读取对象属性的lambda表达式：因此<code>itemgetter</code> 和 <code>attrgetter</code> 其实会自动构建函数。</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> d <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'apple'</span><span class="token punctuation">,</span><span class="token number">4.8</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'orange'</span><span class="token punctuation">,</span><span class="token number">6.2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'banana'</span><span class="token punctuation">,</span><span class="token number">2.3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">'pear'</span><span class="token punctuation">,</span><span class="token number">3.9</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> key<span class="token operator">=</span>operator<span class="token punctuation">.</span>itemgetter<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'banana'</span><span class="token punctuation">,</span> <span class="token number">2.3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'pear'</span><span class="token punctuation">,</span> <span class="token number">3.9</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'apple'</span><span class="token punctuation">,</span> <span class="token number">4.8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'orange'</span><span class="token punctuation">,</span> <span class="token number">6.2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> p<span class="token punctuation">:</span>p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'banana'</span><span class="token punctuation">,</span> <span class="token number">2.3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'pear'</span><span class="token punctuation">,</span> <span class="token number">3.9</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'apple'</span><span class="token punctuation">,</span> <span class="token number">4.8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'orange'</span><span class="token punctuation">,</span> <span class="token number">6.2</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</pre><p>itemgetter 还可以返回多个提取的值构成的元组：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> get_fruit <span class="token operator">=</span> operator<span class="token punctuation">.</span>itemgetter<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> fruit <span class="token keyword">in</span> d<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>get_fruit<span class="token punctuation">(</span>fruit<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token punctuation">(</span><span class="token number">4.8</span><span class="token punctuation">,</span> <span class="token string">'apple'</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token number">6.2</span><span class="token punctuation">,</span> <span class="token string">'orange'</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token number">2.3</span><span class="token punctuation">,</span> <span class="token string">'banana'</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token number">3.9</span><span class="token punctuation">,</span> <span class="token string">'pear'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> get_fruit <span class="token operator">=</span> <span class="token keyword">lambda</span> o<span class="token punctuation">:</span><span class="token punctuation">(</span>o<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>o<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> fruit <span class="token keyword">in</span> d<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>get_fruit<span class="token punctuation">(</span>fruit<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token punctuation">(</span><span class="token number">4.8</span><span class="token punctuation">,</span> <span class="token string">'apple'</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token number">6.2</span><span class="token punctuation">,</span> <span class="token string">'orange'</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token number">2.3</span><span class="token punctuation">,</span> <span class="token string">'banana'</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token number">3.9</span><span class="token punctuation">,</span> <span class="token string">'pear'</span><span class="token punctuation">)</span>
</pre><p>itemgetter 使用 [] 运算符，因此它不仅支持序列，还支持映射和任何实现 <code>__getitem__</code> 方法的类。</p>
<p><code>attrgetter</code> 的演示：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">Fruit</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">,</span> price<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         self<span class="token punctuation">.</span>name<span class="token punctuation">,</span> self<span class="token punctuation">.</span>price <span class="token operator">=</span> name<span class="token punctuation">,</span> price
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">>></span><span class="token operator">></span> fruits <span class="token operator">=</span> <span class="token punctuation">[</span>Fruit<span class="token punctuation">(</span>n<span class="token punctuation">,</span>p<span class="token punctuation">)</span> <span class="token keyword">for</span> n<span class="token punctuation">,</span>p <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'apple'</span><span class="token punctuation">,</span><span class="token string">'orange'</span><span class="token punctuation">,</span><span class="token string">'banana'</span><span class="token punctuation">,</span><span class="token string">'pear'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token punctuation">[</span><span class="token number">4.8</span><span class="token punctuation">,</span><span class="token number">6.2</span><span class="token punctuation">,</span><span class="token number">2.3</span><span class="token punctuation">,</span><span class="token number">3.9</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token operator">>></span><span class="token operator">></span> get_frname <span class="token operator">=</span> operator<span class="token punctuation">.</span>attrgetter<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> fx <span class="token keyword">in</span> fruits<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>get_frname<span class="token punctuation">(</span>fx<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
apple
orange
banana
pear
<span class="token operator">>></span><span class="token operator">></span> get_frname <span class="token operator">=</span> <span class="token keyword">lambda</span> o<span class="token punctuation">:</span>o<span class="token punctuation">.</span>name
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> fx <span class="token keyword">in</span> fruits<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>get_frname<span class="token punctuation">(</span>fx<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
apple
orange
banana
pear
</pre><p>下面是 <code>operator</code> 模块中定义的部分函数（省略了以 _ 开头的名称，因为它们基本上是实现细节）：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span>name <span class="token keyword">for</span> name <span class="token keyword">in</span> <span class="token builtin">dir</span><span class="token punctuation">(</span>operator<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token operator">not</span> name<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token string">'abs'</span><span class="token punctuation">,</span> <span class="token string">'add'</span><span class="token punctuation">,</span> <span class="token string">'and_'</span><span class="token punctuation">,</span> <span class="token string">'attrgetter'</span><span class="token punctuation">,</span> <span class="token string">'concat'</span><span class="token punctuation">,</span> <span class="token string">'contains'</span><span class="token punctuation">,</span> <span class="token string">'countOf'</span><span class="token punctuation">,</span> 
<span class="token string">'delitem'</span><span class="token punctuation">,</span> <span class="token string">'eq'</span><span class="token punctuation">,</span> <span class="token string">'floordiv'</span><span class="token punctuation">,</span> <span class="token string">'ge'</span><span class="token punctuation">,</span> <span class="token string">'getitem'</span><span class="token punctuation">,</span> <span class="token string">'gt'</span><span class="token punctuation">,</span> <span class="token string">'iadd'</span><span class="token punctuation">,</span> <span class="token string">'iand'</span><span class="token punctuation">,</span> 
<span class="token string">'iconcat'</span><span class="token punctuation">,</span> <span class="token string">'ifloordiv'</span><span class="token punctuation">,</span> <span class="token string">'ilshift'</span><span class="token punctuation">,</span> <span class="token string">'imatmul'</span><span class="token punctuation">,</span> <span class="token string">'imod'</span><span class="token punctuation">,</span> <span class="token string">'imul'</span><span class="token punctuation">,</span> <span class="token string">'index'</span><span class="token punctuation">,</span> 
<span class="token string">'indexOf'</span><span class="token punctuation">,</span> <span class="token string">'inv'</span><span class="token punctuation">,</span> <span class="token string">'invert'</span><span class="token punctuation">,</span> <span class="token string">'ior'</span><span class="token punctuation">,</span> <span class="token string">'ipow'</span><span class="token punctuation">,</span> <span class="token string">'irshift'</span><span class="token punctuation">,</span> <span class="token string">'is_'</span><span class="token punctuation">,</span> <span class="token string">'is_not'</span><span class="token punctuation">,</span> 
<span class="token string">'isub'</span><span class="token punctuation">,</span> <span class="token string">'itemgetter'</span><span class="token punctuation">,</span> <span class="token string">'itruediv'</span><span class="token punctuation">,</span> <span class="token string">'ixor'</span><span class="token punctuation">,</span> <span class="token string">'le'</span><span class="token punctuation">,</span> <span class="token string">'length_hint'</span><span class="token punctuation">,</span> 
<span class="token string">'lshift'</span><span class="token punctuation">,</span> <span class="token string">'lt'</span><span class="token punctuation">,</span> <span class="token string">'matmul'</span><span class="token punctuation">,</span> <span class="token string">'methodcaller'</span><span class="token punctuation">,</span> <span class="token string">'mod'</span><span class="token punctuation">,</span> <span class="token string">'mul'</span><span class="token punctuation">,</span> <span class="token string">'ne'</span><span class="token punctuation">,</span> <span class="token string">'neg'</span><span class="token punctuation">,</span> 
<span class="token string">'not_'</span><span class="token punctuation">,</span> <span class="token string">'or_'</span><span class="token punctuation">,</span> <span class="token string">'pos'</span><span class="token punctuation">,</span> <span class="token string">'pow'</span><span class="token punctuation">,</span> <span class="token string">'rshift'</span><span class="token punctuation">,</span> <span class="token string">'setitem'</span><span class="token punctuation">,</span> <span class="token string">'sub'</span><span class="token punctuation">,</span> <span class="token string">'truediv'</span><span class="token punctuation">,</span> 
<span class="token string">'truth'</span><span class="token punctuation">,</span> <span class="token string">'xor'</span><span class="token punctuation">]</span>
</pre><p>最后介绍一下 methodcaller。它的作用于 attrgetter 和 itemgetter 类似，它会自行创建函数。methodcaller 创建的函数会在对象上调用参数指定的方法：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> operator <span class="token keyword">import</span> methodcaller
<span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> <span class="token string">'The time has come'</span>
<span class="token operator">>></span><span class="token operator">></span> upcase <span class="token operator">=</span> methodcaller<span class="token punctuation">(</span><span class="token string">'upper'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> upcase<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token string">'THE TIME HAS COME'</span>
<span class="token comment"># 类似于 functions.partial 函数，用于冻结某些参数</span>
<span class="token operator">>></span><span class="token operator">></span> hiphenate <span class="token operator">=</span> methodcaller<span class="token punctuation">(</span><span class="token string">'replace'</span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> hiphenate<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token string">'The-time-has-come'</span>
<span class="token operator">>></span><span class="token operator">></span> s
<span class="token string">'The time has come'</span>
</pre><h4 class="mume-header" id="%E4%BD%BF%E7%94%A8-functoolspartial-%E5%86%BB%E7%BB%93%E5%8F%82%E6%95%B0">使用 functools.partial 冻结参数</h4>

<p>functools 模块提供了一系列的高阶函数，其中最广为人知或许的是 <code>reduce</code>。余下的函数中，最有用的是 partial 及其辩题，partialmethod。</p>
<p>functools.partial 这个高阶函数用于部分应用函数。部分应用是指：基于一个函数创建一个新的可调用对象，把原函数的某些参数固定。使用这些函数可以把接受1个或多个参数的函数改编成需要回调的API，这样参数更少。</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> operator <span class="token keyword">import</span> mul
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> functools <span class="token keyword">import</span> partial
<span class="token operator">>></span><span class="token operator">></span> triple <span class="token operator">=</span> partial<span class="token punctuation">(</span>mul<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> triple<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
<span class="token number">21</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span>triple<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">27</span><span class="token punctuation">]</span>
</pre><pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> picture <span class="token operator">=</span> partial<span class="token punctuation">(</span>tag<span class="token punctuation">,</span> <span class="token string">'img'</span><span class="token punctuation">,</span> cls<span class="token operator">=</span><span class="token string">'pic-frame'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> picture<span class="token punctuation">(</span>src<span class="token operator">=</span><span class="token string">'wumpus.jpeg'</span><span class="token punctuation">)</span>
<span class="token string">'&lt;img class="pic-frame" src="wumpus.jpeg" />'</span>
<span class="token operator">>></span><span class="token operator">></span> picture
functools<span class="token punctuation">.</span>partial<span class="token punctuation">(</span><span class="token operator">&lt;</span>function tag at <span class="token number">0x10ab21e18</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token string">'img'</span><span class="token punctuation">,</span> cls<span class="token operator">=</span><span class="token string">'pic-frame'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> picture<span class="token punctuation">.</span>func
<span class="token operator">&lt;</span>function tag at <span class="token number">0x10ab21e18</span><span class="token operator">></span>
<span class="token operator">>></span><span class="token operator">></span> picture<span class="token punctuation">.</span>args
<span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">,</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> picture<span class="token punctuation">.</span>keywords
<span class="token punctuation">{</span><span class="token string">'cls'</span><span class="token punctuation">:</span> <span class="token string">'pic-frame'</span><span class="token punctuation">}</span>
</pre><p><code>functools.partialmethod</code> 函数(Python 3.4 新增)的作用与 partial 一样，不过是用于处理方法，如：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> functools <span class="token keyword">import</span> partialmethod
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">MyMul</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">mul</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">return</span> a<span class="token operator">*</span>b
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     double <span class="token operator">=</span> partialmethod<span class="token punctuation">(</span>mul<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
<span class="token operator">>></span><span class="token operator">></span> mymul <span class="token operator">=</span> MyMul<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> mymul<span class="token punctuation">.</span>double<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token number">40</span>
</pre><h4 class="mume-header" id="%E5%90%8E%E8%AE%B0">后记</h4>

<p>Python 从另一门函数语言（Hashell）中借鉴了列表推导，使得Python对map、filter、以及lambda表达式的需求极大地减少了。</p>
<h2 class="mume-header" id="%E4%BD%BF%E7%94%A8%E4%B8%80%E7%AD%89%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F">使用一等函数实现设计模式</h2>

<p>虽然设计模式与语言无关，但这并不意味着每一个设计模式都能在每一种语言中使用。</p>
<p>《设计模式：可复用面向对象软件的基础》的作者在引言中承认，所用的语言决定了那些设计模式可用：</p>
<blockquote>
<p>程序设计语言的选择非常重要，它将影响人们理解问题的出发点。我们的设计模式常用了 Smalltalk 和 C++ 层的语言特性，这个选择实际上决定了那些机制可以方便地实现，那些则不能。若我们常用过程式语言，可能就要包括诸如“集成”、“封装” 和 “多态” 的设计模式了。</p>
</blockquote>
<h3 class="mume-header" id="%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90">案例分析</h3>

<p>如果合理利用作为一等对象的函数，某些设计模式可以被简化，“策略”模式就是其中一个很好的例子。</p>
<h4 class="mume-header" id="%E7%BB%8F%E5%85%B8%E7%9A%84%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F">经典的策略模式</h4>

<p>策略模式的定义：定义一系列算法，把它们一一封装起来，并且使它们可以相互替换。本模式使得算法可以独立于使用它的客户而改变。</p>
<p>电商领域有个功能明显可以使用“策略”模式，即根据客户的属性或订单中的商品计算折扣。</p>
<p>假如一个网店制定了下述的折扣规则：</p>
<ul>
<li>同一订单中，单个商品的数量达到20个或以上，享 10% 折扣</li>
<li>订单中的不同商品达到10个或以上，享7%折扣</li>
<li>有 1000 或以上积分的顾客，每个订单享 5% 折扣</li>
</ul>
<p>简单起见，我们假定一个订单一次只能享用一个折扣。</p>
<p><img src="../assets/FPfig6_1.png" alt="FPfig6_1"></p>
<ul>
<li>上下文：把一些计算委托给实现不同算法的可互换组件，它提供服务。在这个电商示例中，上下文是 Order，它会根据不同的算法计算促销折扣。</li>
<li>策略：实现不同的组件共同的接口，在这个示例中，名为 Promotion 的抽象类表演这个角色</li>
<li>具体策略：策略的具体子类。fidelityPromo/BulkPromo/LargeOrderPromo是实现的3个具体策略。</li>
</ul>
<p>实现 Order 类，支持插入式折扣策略：</p>
<div class="code-chunk" data-id="20180419145715" data-cmd="python"><div class="input-div"><pre data-role="codeBlock" data-info="python {code_chunk_offset=12, cmd id=&amp;amp;quot;20180419145715&amp;amp;quot; class=line-numbers}" class="language-python line-numbers"><span class="token keyword">from</span> abc <span class="token keyword">import</span> ABC<span class="token punctuation">,</span> abstractmethod
<span class="token keyword">from</span> collections <span class="token keyword">import</span> namedtuple

Customer <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">'Customer'</span><span class="token punctuation">,</span> <span class="token string">'name fidelity'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">LineItem</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> product<span class="token punctuation">,</span> quantity<span class="token punctuation">,</span> price<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>product <span class="token operator">=</span> product
        self<span class="token punctuation">.</span>quantity <span class="token operator">=</span> quantity
        self<span class="token punctuation">.</span>price <span class="token operator">=</span> price
    
    <span class="token keyword">def</span> <span class="token function">total</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>price <span class="token operator">*</span> self<span class="token punctuation">.</span>quantity

<span class="token keyword">class</span> <span class="token class-name">Order</span><span class="token punctuation">:</span> <span class="token comment"># 上下文</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> customer<span class="token punctuation">,</span> cart<span class="token punctuation">,</span> promotion<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>customer <span class="token operator">=</span> customer
        self<span class="token punctuation">.</span>cart <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>cart<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>promotion <span class="token operator">=</span> promotion

    <span class="token keyword">def</span> <span class="token function">total</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'__total'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>__total <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>total<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> item <span class="token keyword">in</span> self<span class="token punctuation">.</span>cart<span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__total

    <span class="token keyword">def</span> <span class="token function">due</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>promotion <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            discount <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            discount <span class="token operator">=</span> self<span class="token punctuation">.</span>promotion<span class="token punctuation">.</span>discount<span class="token punctuation">(</span>self<span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>total<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> discount

    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        fmt <span class="token operator">=</span> <span class="token string">'Order total: {:.2f} due:{:.2f}'</span>
        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>total<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>due<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Promotion</span><span class="token punctuation">(</span>ABC<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 策略，抽象基类</span>
    @abstractmethod
    <span class="token keyword">def</span> <span class="token function">discount</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> order<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""返回折扣金额（正值）"""</span>

<span class="token keyword">class</span> <span class="token class-name">BulkItemPromo</span><span class="token punctuation">(</span>Promotion<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""单个商品为20个或以上时提供10%的折扣
    """</span>
    <span class="token keyword">def</span> <span class="token function">discount</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> order<span class="token punctuation">)</span><span class="token punctuation">:</span>
        discount_v <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> item <span class="token keyword">in</span> order<span class="token punctuation">.</span>cart<span class="token punctuation">:</span>
            <span class="token keyword">if</span>  item<span class="token punctuation">.</span>quantity <span class="token operator">>=</span> <span class="token number">20</span><span class="token punctuation">:</span>
                discount_v <span class="token operator">+=</span> item<span class="token punctuation">.</span>quantity<span class="token operator">*</span>item<span class="token punctuation">.</span>price<span class="token operator">*</span><span class="token number">0.1</span>
        <span class="token keyword">return</span> discount_v

<span class="token keyword">class</span> <span class="token class-name">LargeOrderPromo</span><span class="token punctuation">(</span>Promotion<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""订单中的不同商品达到10个或以上的时候，提供 7% 的折扣
    """</span>
    <span class="token keyword">def</span> <span class="token function">discount</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> order<span class="token punctuation">)</span><span class="token punctuation">:</span>
        distinct_items <span class="token operator">=</span> <span class="token punctuation">{</span>item<span class="token punctuation">.</span>product <span class="token keyword">for</span> item <span class="token keyword">in</span> order<span class="token punctuation">.</span>cart<span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>distinct_items<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">10</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> order<span class="token punctuation">.</span>total<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.07</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token number">0</span>


<span class="token keyword">class</span> <span class="token class-name">FidelityPromo</span><span class="token punctuation">(</span>Promotion<span class="token punctuation">)</span><span class="token punctuation">:</span> 
    <span class="token triple-quoted-string string">"""为积分1000或以上的顾客提供 5% 的折扣
    """</span>
    <span class="token keyword">def</span> <span class="token function">discount</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> order<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> order<span class="token punctuation">.</span>total<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.05</span> <span class="token keyword">if</span> order<span class="token punctuation">.</span>customer<span class="token punctuation">.</span>fidelity <span class="token operator">></span> <span class="token number">1000</span> <span class="token keyword">else</span> <span class="token number">0</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><div class="btn-group"><div class="run-btn btn"><span>▶︎</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"></div></div><p>注意：在示例 6-1 中，我把 Promotion 定义为抽象基类 (Abstract Base Class, ABC)，这么做是为了使用 <code>@abstractmethod</code> 装饰器，从而明确表明所用的模式。</p>
<blockquote>
<p>在Python3.4及之后，声明抽象基类的最简单方式是子类话<code>abc.ABC</code>。</p>
</blockquote>
<div class="code-chunk" data-id="code-chunk-id-13" data-cmd="python"><div class="input-div"><pre data-role="codeBlock" data-info="python {code_chunk_offset=13, cmd continue=&amp;amp;quot;20180419145715&amp;amp;quot;}" class="language-python">joe <span class="token operator">=</span> Customer<span class="token punctuation">(</span><span class="token string">'John Doe'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
ann <span class="token operator">=</span> Customer<span class="token punctuation">(</span><span class="token string">'Ann Smith'</span><span class="token punctuation">,</span> <span class="token number">1100</span><span class="token punctuation">)</span>
cart <span class="token operator">=</span> <span class="token punctuation">[</span>LineItem<span class="token punctuation">(</span><span class="token string">'banana'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    LineItem<span class="token punctuation">(</span><span class="token string">'apple'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    LineItem<span class="token punctuation">(</span><span class="token string">'watermellon'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span> Order<span class="token punctuation">(</span>joe<span class="token punctuation">,</span> cart<span class="token punctuation">,</span> FidelityPromo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span> Order<span class="token punctuation">(</span>ann<span class="token punctuation">,</span> cart<span class="token punctuation">,</span> FidelityPromo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
banana_cart <span class="token operator">=</span> <span class="token punctuation">[</span>LineItem<span class="token punctuation">(</span><span class="token string">'banana'</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    LineItem<span class="token punctuation">(</span><span class="token string">'apple'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1.5</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span> Order<span class="token punctuation">(</span>joe<span class="token punctuation">,</span> banana_cart<span class="token punctuation">,</span> BulkItemPromo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
long_order <span class="token operator">=</span> <span class="token punctuation">[</span>LineItem<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>item_code<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token keyword">for</span> item_code <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span> Order<span class="token punctuation">(</span>joe<span class="token punctuation">,</span> long_order<span class="token punctuation">,</span> LargeOrderPromo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span> Order<span class="token punctuation">(</span>joe<span class="token punctuation">,</span> cart<span class="token punctuation">,</span> LargeOrderPromo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>
</pre><div class="btn-group"><div class="run-btn btn"><span>▶︎</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"></div></div><h4 class="mume-header" id="%E4%BD%BF%E7%94%A8%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0-%E7%AD%96%E7%95%A5-%E6%A8%A1%E5%BC%8F">使用函数实现 “策略” 模式</h4>

<p>在上面的例子中，每个具体策略都是一个类，而且都自定义了一个方法，即<code>discount</code>。此外，策略实例没有状态（没有实例属性）。其实它看起来像是普通的函数，下面对上面的例子进行重构，把具体策略换成简单的函数，并去掉 Promo 抽象类。</p>
<div class="code-chunk" data-id="20180419164816" data-cmd="python"><div class="input-div"><pre data-role="codeBlock" data-info="python {code_chunk_offset=14, cmd id=&amp;amp;quot;20180419164816&amp;amp;quot; class=line-numbers}" class="language-python line-numbers"><span class="token keyword">from</span> abc <span class="token keyword">import</span> ABC<span class="token punctuation">,</span> abstractmethod
<span class="token keyword">from</span> collections <span class="token keyword">import</span> namedtuple

Customer <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">'Customer'</span><span class="token punctuation">,</span> <span class="token string">'name fidelity'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">LineItem</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> product<span class="token punctuation">,</span> quantity<span class="token punctuation">,</span> price<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>product <span class="token operator">=</span> product
        self<span class="token punctuation">.</span>quantity <span class="token operator">=</span> quantity
        self<span class="token punctuation">.</span>price <span class="token operator">=</span> price
    
    <span class="token keyword">def</span> <span class="token function">total</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>price <span class="token operator">*</span> self<span class="token punctuation">.</span>quantity

<span class="token keyword">class</span> <span class="token class-name">Order</span><span class="token punctuation">:</span> <span class="token comment"># 上下文</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> customer<span class="token punctuation">,</span> cart<span class="token punctuation">,</span> promotion<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>customer <span class="token operator">=</span> customer
        self<span class="token punctuation">.</span>cart <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>cart<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>promotion <span class="token operator">=</span> promotion

    <span class="token keyword">def</span> <span class="token function">total</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'__total'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>__total <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>total<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> item <span class="token keyword">in</span> self<span class="token punctuation">.</span>cart<span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>__total

    <span class="token keyword">def</span> <span class="token function">due</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>promotion <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            discount <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            discount <span class="token operator">=</span> self<span class="token punctuation">.</span>promotion<span class="token punctuation">(</span>self<span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>total<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> discount

    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        fmt <span class="token operator">=</span> <span class="token string">'Order total: {:.2f} due:{:.2f}'</span>
        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>total<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>due<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">fidelity_promo</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""为积分为1000及以上的顾客提供 5%的折扣"""</span>
    <span class="token keyword">return</span> order<span class="token punctuation">.</span>total<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">.05</span> <span class="token keyword">if</span> order<span class="token punctuation">.</span>customer<span class="token punctuation">.</span>fidelity<span class="token operator">>=</span><span class="token number">1000</span> <span class="token keyword">else</span> <span class="token number">0</span>

<span class="token keyword">def</span> <span class="token function">bulk_item_promo</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""单个商品为20个或以上的提供10%的折扣"""</span>
    discount <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> order<span class="token punctuation">.</span>cart<span class="token punctuation">:</span>
        <span class="token keyword">if</span> item<span class="token punctuation">.</span>quantity <span class="token operator">>=</span> <span class="token number">20</span><span class="token punctuation">:</span>
            discount <span class="token operator">+=</span> item<span class="token punctuation">.</span>total<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">.1</span>
    <span class="token keyword">return</span> discount

<span class="token keyword">def</span> <span class="token function">large_order_promo</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""订单中的不同商品达到10个或以上 提供7%的折扣"""</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>product <span class="token keyword">for</span> item <span class="token keyword">in</span> order<span class="token punctuation">.</span>cart<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">>=</span><span class="token number">10</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> order<span class="token punctuation">.</span>total<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">.07</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">0</span>

joe <span class="token operator">=</span> Customer<span class="token punctuation">(</span><span class="token string">'John Doe'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
ann <span class="token operator">=</span> Customer<span class="token punctuation">(</span><span class="token string">'Ann Smith'</span><span class="token punctuation">,</span> <span class="token number">1100</span><span class="token punctuation">)</span>
cart <span class="token operator">=</span> <span class="token punctuation">[</span>LineItem<span class="token punctuation">(</span><span class="token string">'banana'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    LineItem<span class="token punctuation">(</span><span class="token string">'apple'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    LineItem<span class="token punctuation">(</span><span class="token string">'watermellon'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
banana_cart <span class="token operator">=</span> <span class="token punctuation">[</span>LineItem<span class="token punctuation">(</span><span class="token string">'banana'</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    LineItem<span class="token punctuation">(</span><span class="token string">'apple'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1.5</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
long_order <span class="token operator">=</span> <span class="token punctuation">[</span>LineItem<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>item_code<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1.0</span><span class="token punctuation">)</span> 
    <span class="token keyword">for</span> item_code <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><div class="btn-group"><div class="run-btn btn"><span>▶︎</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"></div></div><p>测试效果：</p>
<div class="code-chunk" data-id="code-chunk-id-15" data-cmd="python"><div class="input-div"><pre data-role="codeBlock" data-info="python {code_chunk_offset=15, cmd continue=&amp;amp;quot;20180419164816&amp;amp;quot;}" class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span> Order<span class="token punctuation">(</span>joe<span class="token punctuation">,</span> cart<span class="token punctuation">,</span> fidelity_promo<span class="token punctuation">)</span> <span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span> Order<span class="token punctuation">(</span>ann<span class="token punctuation">,</span> cart<span class="token punctuation">,</span> fidelity_promo<span class="token punctuation">)</span> <span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span> Order<span class="token punctuation">(</span>joe<span class="token punctuation">,</span> banana_cart<span class="token punctuation">,</span> bulk_item_promo<span class="token punctuation">)</span> <span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span> Order<span class="token punctuation">(</span>joe<span class="token punctuation">,</span> long_order<span class="token punctuation">,</span> large_order_promo<span class="token punctuation">)</span> <span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span> Order<span class="token punctuation">(</span>joe<span class="token punctuation">,</span> cart<span class="token punctuation">,</span> large_order_promo<span class="token punctuation">)</span> <span class="token punctuation">)</span>
</pre><div class="btn-group"><div class="run-btn btn"><span>▶︎</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"></div></div><p>值得注意的是，《设计模式：可复用面向对象软件的基础》一书的作者指出：“策略对象通常是很好的享元（flyweight）”。其中，书中对享元的定义为：</p>
<blockquote>
<p>享元是可共享的对象，可以同时在多个上下文中使用。共享是推荐的做法，这样不必在每个新的上下文中（这里是Order实例）中使用相同的策略时不断新建具体策略对象，从而减少消耗。</p>
</blockquote>
<p>以此，为了避免“策略”模式的一个缺点（运行时消耗），《设计模式：可复用面向对象软件的基础》的作者建议使用另一个模式，但是代码行数和维护成本都会不断攀升。</p>
<p>在复杂的情况下，需要具体策略维护内部状态，可能需要把 “策略” 和 “享元” 结合起来。但是，具体策略一般没有内部状态，只是处理上下文中的数据，此时一定要使用普通的函数，别去编写只有一个方法的类，再去实现另一个类声明的单函数接口。<em>函数比用户定义的类的实例轻量，并且因为不会创建实例，所以没必要用享元</em>。</p>
<p>假设我们想创建一个“元策略”，让它为指定的订单选择最佳折扣，接下来的几节会继续重构，利用函数和模块是对象，使用不同的方法实现这个需求。</p>
<h4 class="mume-header" id="%E6%9C%80%E4%BD%B3%E9%80%89%E6%8B%A9%E7%AD%96%E7%95%A5%E7%AE%80%E5%8D%95%E7%9A%84%E6%96%B9%E5%BC%8F">最佳选择策略：简单的方式</h4>

<p>我们继续使用上面的顾客和购物车，在此基础上添加3个测试：<br>
<code>best_promo</code> 函数计算所有折扣，并返回额度最大的：</p>
<div class="code-chunk" data-id="code-chunk-id-16" data-cmd="python"><div class="input-div"><pre data-role="codeBlock" data-info="python {code_chunk_offset=16, cmd continue=&amp;amp;quot;20180419164816&amp;amp;quot;}" class="language-python">promo_func <span class="token operator">=</span> <span class="token punctuation">[</span>fidelity_promo<span class="token punctuation">,</span> bulk_item_promo<span class="token punctuation">,</span> large_order_promo<span class="token punctuation">]</span>
<span class="token keyword">def</span> <span class="token function">best_promo</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""选择可用的最佳折扣
    """</span>
    <span class="token keyword">return</span> <span class="token builtin">max</span><span class="token punctuation">(</span>f<span class="token punctuation">(</span>order<span class="token punctuation">)</span> <span class="token keyword">for</span> f <span class="token keyword">in</span> promo_func<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>Order<span class="token punctuation">(</span>joe<span class="token punctuation">,</span> long_order<span class="token punctuation">,</span> best_promo<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>Order<span class="token punctuation">(</span>joe<span class="token punctuation">,</span> banana_cart<span class="token punctuation">,</span> best_promo<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>Order<span class="token punctuation">(</span>ann<span class="token punctuation">,</span> cart<span class="token punctuation">,</span> best_promo<span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><div class="btn-group"><div class="run-btn btn"><span>▶︎</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"></div></div><p>上面实例的一个小缺陷：若想添加新的促销策略，要定义相应的函数，还要记得把它添加到 promo_func ，否则新策略不能进入对比。</p>
<h4 class="mume-header" id="%E6%89%BE%E5%87%BA%E6%A8%A1%E5%9D%97%E4%B8%AD%E7%9A%84%E5%85%A8%E9%83%A8%E7%AD%96%E7%95%A5">找出模块中的全部策略</h4>

<p>在 Python 中，模块也是一等对象，而且标准库提供了几个处理模块的函数。</p>
<ul>
<li><code>globals()</code> : 返回一个字典，表示当前的全局符号表。这个符号表始终指向当前模块（对函数或方法来说，是指定它们的模块，而不是调用它们的模块）</li>
</ul>
<p>方案1：使用<code>globals</code> 函数帮助 best_promo 自动找到其他可用的 *_promo 函数，过程有点曲折：</p>
<div class="code-chunk" data-id="code-chunk-id-17" data-cmd="python"><div class="input-div"><pre data-role="codeBlock" data-info="python {code_chunk_offset=17, cmd continue=&amp;amp;quot;20180419164816&amp;amp;quot;}" class="language-python">promos <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token keyword">for</span> name <span class="token keyword">in</span> <span class="token builtin">globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> name<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'_promo'</span><span class="token punctuation">)</span> <span class="token operator">and</span> name<span class="token operator">!=</span><span class="token string">'best_promo'</span><span class="token punctuation">]</span>
<span class="token keyword">def</span> <span class="token function">best_promo</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token builtin">max</span><span class="token punctuation">(</span>f<span class="token punctuation">(</span>order<span class="token punctuation">)</span> <span class="token keyword">for</span> f <span class="token keyword">in</span> promos<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>Order<span class="token punctuation">(</span>joe<span class="token punctuation">,</span> long_order<span class="token punctuation">,</span> best_promo<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>Order<span class="token punctuation">(</span>joe<span class="token punctuation">,</span> banana_cart<span class="token punctuation">,</span> best_promo<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>Order<span class="token punctuation">(</span>ann<span class="token punctuation">,</span> cart<span class="token punctuation">,</span> best_promo<span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre><div class="btn-group"><div class="run-btn btn"><span>▶︎</span></div><div class="run-all-btn btn">all</div></div><div class="status">running...</div></div><div class="output-div"></div></div><p>收集上有可用促销的另一种方法是，在一个单独的模块中保存上有策略函数，把 <code>best_promo</code> 排除在外。</p>
<p>在下面的实例中，最大的变化是内省名为 promotions 的独立模块，构建策略函数列表。注意，要导入 promotions 模块，并提供高阶内省函数的 inspect 模块：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token keyword">import</span> promotions

promos <span class="token operator">=</span> <span class="token punctuation">[</span>func <span class="token keyword">for</span> name<span class="token punctuation">,</span>func <span class="token keyword">in</span> inspect<span class="token punctuation">.</span>getmembers<span class="token punctuation">(</span>
    promotions<span class="token punctuation">,</span> inspect<span class="token punctuation">.</span>isfunction<span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">best_promo</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""选择可用的最佳折扣
    """</span>
    <span class="token keyword">return</span> <span class="token builtin">max</span><span class="token punctuation">(</span> f<span class="token punctuation">(</span>order<span class="token punctuation">)</span> <span class="token keyword">for</span> f <span class="token keyword">in</span> promos <span class="token punctuation">)</span>
</pre><p><code>inspect.getmembers</code> 函数用于获取对象的属性。第二个参数使可选的判断条件（一个布尔值函数）。我们使用的是<code>inspect.isfunction</code>，只获取模块中的函数。</p>
<p>不过怎么命名策略函数，方法2的<code>promotions</code>模块只能包含计算订单折扣的函数。当然，这是对代码的隐形假设，如果有人在 <code>promotions</code>模块中使用不同的签名定义函数，那么 <code>best_promo</code> 也会尝试将其应用到订单上时就会出错。</p>
<p>我们可以添加更为严格的测试，审查传递给实例的参数，进一步过滤函数。</p>
<p>下一节讨论 “命令” 模式，这个设计模式也常使用单方法类实现，同样也可以换成普通的函数。</p>
<h3 class="mume-header" id="%E5%91%BD%E4%BB%A4%E6%A8%A1%E5%BC%8F">命令模式</h3>

<p>“命令” 设计模式也可以通过将函数作为参数传递而简化。这一模式对类的编排如下：<br>
<img src="../assets/FPfig6_2.png" alt="FPfig6_2"><br>
图6-2：菜单驱动的文本编辑器的 UML 类图，使用命令设计模式的实现。各个命令可以有不同的接收者（实现操作的对象）。对<code>PasteCommand</code>来说，接收者就是Document，对OpenCommand来说，接收者就是应用程序。</p>
<p><strong>“命令”模式的目的是解耦调用操作的对象（调用者）和提供实现的对象（接收者）</strong>。在《设计模式：可复用面向对象软件的基础》所列举的实例中，调用者是图形应用程序中的菜单，而接收者是被编辑的文档或者是应用程序自身。</p>
<p>这个模式的做法是，在两者之间放一个 Command 对象，让它实现只有一个方法（execute）的接口，调用接收者中的方法执行所需的操作，这样，调用者无需了解接收者的接口，而且不同的接收者可以适应不同的Command子类。调用者有一个具体的命令，通过调用 execute 方法执行。</p>
<p>Gamma 等人说过：命令模式是回调机制的面向对象的替代品。</p>
<p>我们可以不为调用者提供一个 Command 实例，而是给它一个函数，此时，调用者不用调用 command.execute(),而是直接调用 command() 即可。MacroCommand()可以实现成定义了 <code>__call__</code> 方法的类。这样， MacroCommand 的实例就是可调用对象，各自维护一个函数列表，供之后的调用：</p>
<pre data-role="codeBlock" data-info="python" class="language-python"><span class="token keyword">class</span> <span class="token class-name">MacroCommand</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""一个执行一组命令的命令
    """</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> commands<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>commands <span class="token operator">=</span> commands

    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> command <span class="token keyword">in</span> self<span class="token punctuation">.</span>commands<span class="token punctuation">:</span>
            command<span class="token punctuation">(</span><span class="token punctuation">)</span>
</pre>
      </div>
      <div class="md-sidebar-toc"><ul>
<li><a href="#%E6%B5%81%E7%95%85%E7%9A%84-python">流畅的 Python</a>
<ul>
<li><a href="#%E7%AC%AC%E4%B8%80%E7%AB%A0-python%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B">第一章 Python数据模型</a>
<ul>
<li><a href="#%E4%B8%80%E6%91%9Epython%E9%A3%8E%E6%A0%BC%E7%9A%84%E7%BA%B8%E7%89%8C">一摞Python风格的纸牌</a></li>
<li><a href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E7%89%B9%E6%AE%8A%E6%96%B9%E6%B3%95">如何使用特殊方法</a>
<ul>
<li><a href="#%E6%A8%A1%E6%8B%9F%E6%95%B0%E5%80%BC%E7%B1%BB%E5%9E%8B">模拟数值类型</a></li>
<li><a href="#__repr__"><strong>repr</strong></a></li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%E5%B8%83%E5%B0%94%E5%80%BC">自定义的布尔值</a></li>
</ul>
</li>
<li><a href="#%E7%89%B9%E6%AE%8A%E6%96%B9%E6%B3%95%E6%80%BB%E7%BB%93">特殊方法总结</a></li>
</ul>
</li>
<li><a href="#%E5%BA%8F%E5%88%97%E6%9E%84%E6%88%90%E7%9A%84%E6%95%B0%E7%BB%84">序列构成的数组</a>
<ul>
<li><a href="#%E5%86%85%E7%BD%AE%E5%BA%8F%E5%88%97%E7%B1%BB%E5%9E%8B%E9%A2%84%E8%A7%88">内置序列类型预览</a></li>
<li><a href="#%E5%88%97%E8%A1%A8%E6%8E%A8%E5%AF%BC%E5%92%8C%E7%94%9F%E6%88%90%E5%99%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F">列表推导和生成器表达式</a>
<ul>
<li><a href="#%E5%88%97%E8%A1%A8%E6%8E%A8%E5%AF%BC%E5%90%8C-map-filter%E7%9A%84%E6%AF%94%E8%BE%83">列表推导同 map、filter的比较</a></li>
<li><a href="#%E7%AC%9B%E5%8D%A1%E5%B0%94%E7%A7%AF">笛卡尔积</a></li>
<li><a href="#%E7%94%9F%E6%88%90%E5%99%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F">生成器表达式</a></li>
</ul>
</li>
<li><a href="#%E5%85%83%E7%BB%84%E4%B8%8D%E4%BB%85%E4%BB%85%E6%98%AF%E4%B8%8D%E5%8F%AF%E5%8F%98%E7%9A%84%E5%88%97%E8%A1%A8">元组不仅仅是不可变的列表</a>
<ul>
<li><a href="#%E5%85%83%E7%BB%84-%E8%AE%B0%E5%BD%95">元组-记录</a></li>
<li><a href="#%E5%85%B7%E5%90%8D%E5%85%83%E7%BB%84">具名元组</a></li>
<li><a href="#tuple%E6%B2%A1%E6%9C%89%E7%9A%84%E6%96%B9%E6%B3%95">tuple没有的方法</a></li>
</ul>
</li>
<li><a href="#%E5%88%87%E7%89%87">切片</a>
<ul>
<li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E5%88%87%E7%89%87%E5%92%8C%E5%8C%BA%E9%97%B4%E4%BC%9A%E5%BF%BD%E7%95%A5%E6%9C%80%E5%90%8E%E4%B8%80%E4%B8%AA%E5%85%83%E7%B4%A0">为什么切片和区间会忽略最后一个元素</a></li>
<li><a href="#%E5%A4%9A%E7%BB%B4%E5%88%87%E7%89%87%E5%92%8C%E7%9C%81%E7%95%A5">多维切片和省略</a></li>
</ul>
</li>
<li><a href="#%E5%BA%8F%E5%88%97%E7%9A%84%E5%A2%9E%E9%87%8F%E8%B5%8B%E5%80%BC">序列的增量赋值</a></li>
<li><a href="#listsort-%E6%96%B9%E6%B3%95%E5%92%8C%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0-sorted">list.sort 方法和内置函数 sorted</a></li>
<li><a href="#%E7%94%A8-bisect-%E6%9D%A5%E7%AE%A1%E7%90%86%E5%B7%B2%E6%8E%92%E5%BA%8F%E7%9A%84%E5%BA%8F%E5%88%97">用 bisect 来管理已排序的序列</a></li>
<li><a href="#%E5%BD%93%E5%88%97%E8%A1%A8%E4%B8%8D%E6%98%AF%E9%A6%96%E9%80%89%E6%97%B6">当列表不是首选时</a>
<ul>
<li><a href="#%E6%95%B0%E7%BB%84">数组</a></li>
<li><a href="#%E5%86%85%E5%AD%98%E8%A7%86%E5%9B%BE">内存视图</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E5%AD%97%E5%85%B8%E5%92%8C%E9%9B%86%E5%90%88">字典和集合</a>
<ul>
<li><a href="#%E5%AD%97%E5%85%B8%E6%8E%A8%E5%AF%BC">字典推导</a></li>
<li><a href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E6%98%A0%E5%B0%84%E6%96%B9%E6%B3%95">常见的映射方法</a></li>
<li><a href="#%E6%98%A0%E5%B0%84%E7%9A%84%E5%BC%B9%E6%80%A7%E9%94%AE%E6%9F%A5%E8%AF%A2">映射的弹性键查询</a>
<ul>
<li><a href="#defaultdict-%E5%A4%84%E7%90%86%E6%89%BE%E4%B8%8D%E5%88%B0%E7%9A%84%E9%94%AE%E7%9A%84%E4%B8%80%E4%B8%AA%E9%80%89%E6%8B%A9">defaultdict 处理找不到的键的一个选择</a></li>
</ul>
</li>
<li><a href="#%E5%AD%97%E5%85%B8%E7%9A%84%E5%8F%98%E7%A7%8D">字典的变种</a></li>
<li><a href="#%E5%AD%90%E7%B1%BB%E5%8C%96-userdict">子类化 UserDict</a></li>
<li><a href="#%E4%B8%8D%E5%8F%AF%E5%8F%98%E6%98%A0%E5%B0%84%E7%B1%BB%E5%9E%8B">不可变映射类型</a></li>
<li><a href="#%E9%9B%86%E5%90%88%E8%AE%BA">集合论</a>
<ul>
<li><a href="#%E9%9B%86%E5%90%88%E6%8E%A8%E5%AF%BC">集合推导</a></li>
<li><a href="#%E9%9B%86%E5%90%88%E7%9A%84%E6%93%8D%E4%BD%9C">集合的操作</a></li>
</ul>
</li>
<li><a href="#dict-%E5%92%8C-set-%E7%9A%84%E8%83%8C%E5%90%8E">dict 和 set 的背后</a>
<ul>
<li><a href="#%E4%B8%80%E4%B8%AA%E5%85%B3%E4%BA%8E%E6%95%88%E7%8E%87%E7%9A%84%E5%AE%9E%E9%AA%8C">一个关于效率的实验</a></li>
<li><a href="#%E5%AD%97%E5%85%B8%E4%B8%AD%E7%9A%84%E6%95%A3%E5%88%97%E8%A1%A8">字典中的散列表</a></li>
<li><a href="#dict-%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8F%8A%E5%85%B6%E5%AF%BC%E8%87%B4%E7%9A%84%E7%BB%93%E6%9E%9C">dict 的实现及其导致的结果</a></li>
</ul>
</li>
<li><a href="#set-%E7%9A%84%E5%AE%9E%E7%8E%B0%E9%9B%86%E5%AF%BC%E8%87%B4%E7%9A%84%E7%BB%93%E6%9E%9C">set 的实现集导致的结果</a></li>
</ul>
</li>
<li><a href="#%E6%96%87%E6%9C%AC%E5%92%8C%E5%AD%97%E8%8A%82%E5%BA%8F%E5%88%97">文本和字节序列</a>
<ul>
<li><a href="#%E5%AD%97%E7%AC%A6%E9%97%AE%E9%A2%98">字符问题</a></li>
<li><a href="#%E5%AD%97%E8%8A%82%E6%A6%82%E8%A6%81">字节概要</a>
<ul>
<li><a href="#%E7%BB%93%E6%9E%84%E4%BD%93%E5%92%8C%E5%86%85%E5%AD%98%E8%AF%95%E5%9B%BE">结构体和内存试图</a></li>
</ul>
</li>
<li><a href="#%E5%9F%BA%E6%9C%AC%E7%9A%84%E7%BC%96%E8%A7%A3%E7%A0%81%E5%99%A8">基本的编解码器</a></li>
<li><a href="#%E4%BA%86%E8%A7%A3%E7%BC%96%E7%A0%81%E8%A7%A3%E7%A0%81%E9%97%AE%E9%A2%98">了解编码解码问题</a>
<ul>
<li><a href="#%E5%A4%84%E7%90%86-unicodeencodeerror">处理 UnicodeEncodeError</a></li>
<li><a href="#%E5%A4%84%E7%90%86-unicodedecodeerror">处理 UnicodeDecodeError</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8%E9%A2%84%E6%9C%9F%E4%B9%8B%E5%A4%96%E7%9A%84%E7%BC%96%E7%A0%81%E5%8A%A0%E8%BD%BD%E6%A8%A1%E5%9D%97%E6%97%B6%E6%8A%9B%E5%87%BAsyntaxerror">使用预期之外的编码加载模块时抛出SyntaxError</a></li>
<li><a href="#%E5%A6%82%E4%BD%95%E6%89%BE%E5%87%BA%E5%AD%97%E8%8A%82%E5%BA%8F%E5%88%97%E7%9A%84%E7%BC%96%E7%A0%81">如何找出字节序列的编码</a></li>
<li><a href="#bom-%E6%9C%89%E7%94%A8%E7%9A%84%E9%AC%BC%E7%AC%A6">BOM 有用的鬼符</a></li>
</ul>
</li>
<li><a href="#%E5%A4%84%E7%90%86%E6%96%87%E6%9C%AC%E6%96%87%E4%BB%B6">处理文本文件</a></li>
<li><a href="#%E4%B8%BA%E4%BA%86%E6%AD%A3%E7%A1%AE%E6%AF%94%E8%BE%83%E8%80%8C%E8%A7%84%E8%8C%83%E5%8C%96-unicode-%E5%AD%97%E7%AC%A6%E4%B8%B2">为了正确比较而规范化 Unicode 字符串</a>
<ul>
<li><a href="#%E5%A4%A7%E5%B0%8F%E5%86%99%E6%8A%98%E5%8F%A0">大小写折叠</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E6%8A%8A%E5%87%BD%E6%95%B0%E8%A7%86%E4%B8%BA%E5%AF%B9%E8%B1%A1">把函数视为对象</a>
<ul>
<li><a href="#%E4%B8%80%E7%AD%89%E5%87%BD%E6%95%B0">一等函数</a>
<ul>
<li><a href="#%E6%8A%8A%E5%87%BD%E6%95%B0%E8%A7%86%E4%B8%BA%E5%AF%B9%E8%B1%A1-1">把函数视为对象</a></li>
<li><a href="#%E9%AB%98%E9%98%B6%E5%87%BD%E6%95%B0">高阶函数</a></li>
<li><a href="#%E5%8C%BF%E5%90%8D%E5%87%BD%E6%95%B0">匿名函数</a></li>
<li><a href="#%E5%8F%AF%E8%B0%83%E7%94%A8%E5%AF%B9%E8%B1%A1">可调用对象</a></li>
<li><a href="#%E7%94%A8%E6%88%B7%E5%AE%9A%E4%B9%89%E7%9A%84%E5%8F%AF%E8%B0%83%E7%94%A8%E7%B1%BB%E5%9E%8B">用户定义的可调用类型</a></li>
<li><a href="#%E5%87%BD%E6%95%B0%E5%86%85%E7%9C%81">函数内省</a></li>
<li><a href="#%E4%BB%8E%E5%AE%9A%E4%BD%8D%E5%8F%82%E6%95%B0%E5%88%B0%E4%BB%85%E9%99%90%E5%85%B3%E9%94%AE%E5%AD%97%E5%8F%82%E6%95%B0">从定位参数到仅限关键字参数</a></li>
<li><a href="#%E8%8E%B7%E5%8F%96%E5%85%B3%E4%BA%8E%E5%8F%82%E6%95%B0%E7%9A%84%E4%BF%A1%E6%81%AF">获取关于参数的信息</a></li>
<li><a href="#%E5%87%BD%E6%95%B0%E6%B3%A8%E9%87%8A">函数注释</a></li>
<li><a href="#%E6%94%AF%E6%8C%81%E5%87%BD%E6%95%B0%E6%98%AF%E7%BC%96%E7%A8%8B%E7%9A%84%E5%8C%85">支持函数是编程的包</a>
<ul>
<li><a href="#operator-%E6%A8%A1%E5%9D%97">operator 模块</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8-functoolspartial-%E5%86%BB%E7%BB%93%E5%8F%82%E6%95%B0">使用 functools.partial 冻结参数</a></li>
<li><a href="#%E5%90%8E%E8%AE%B0">后记</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E4%BD%BF%E7%94%A8%E4%B8%80%E7%AD%89%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F">使用一等函数实现设计模式</a>
<ul>
<li><a href="#%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90">案例分析</a>
<ul>
<li><a href="#%E7%BB%8F%E5%85%B8%E7%9A%84%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F">经典的策略模式</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0-%E7%AD%96%E7%95%A5-%E6%A8%A1%E5%BC%8F">使用函数实现 “策略” 模式</a></li>
<li><a href="#%E6%9C%80%E4%BD%B3%E9%80%89%E6%8B%A9%E7%AD%96%E7%95%A5%E7%AE%80%E5%8D%95%E7%9A%84%E6%96%B9%E5%BC%8F">最佳选择策略：简单的方式</a></li>
<li><a href="#%E6%89%BE%E5%87%BA%E6%A8%A1%E5%9D%97%E4%B8%AD%E7%9A%84%E5%85%A8%E9%83%A8%E7%AD%96%E7%95%A5">找出模块中的全部策略</a></li>
</ul>
</li>
<li><a href="#%E5%91%BD%E4%BB%A4%E6%A8%A1%E5%BC%8F">命令模式</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
      <a id="sidebar-toc-btn">≡</a>
    </body>
    
    
    
    
    
    
    
<script>

var sidebarTOCBtn = document.getElementById('sidebar-toc-btn')
sidebarTOCBtn.addEventListener('click', function(event) {
  event.stopPropagation()
  if (document.body.hasAttribute('html-show-sidebar-toc')) {
    document.body.removeAttribute('html-show-sidebar-toc')
  } else {
    document.body.setAttribute('html-show-sidebar-toc', true)
  }
})
</script>
      
  </html>